<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">{- |
Copyright : Flipstone Technology Partners 2023
License   : MIT
Stability : Stable

This module provides the functionality to work with SQL transactions, notably
to ensure some Haskell action occurs within a database transaction.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Orville.PostgreSQL.Execution.Transaction</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Execution.Transaction.html#withTransaction"><span class="hs-identifier">withTransaction</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Execution.Execute.html"><span class="hs-identifier">Orville.PostgreSQL.Execution.Execute</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Execute</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Execution.QueryType.html"><span class="hs-identifier">Orville.PostgreSQL.Execution.QueryType</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">QueryType</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.html"><span class="hs-identifier">Orville.PostgreSQL.Expr</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Expr</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.Bracket.html"><span class="hs-identifier">Orville.PostgreSQL.Internal.Bracket</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bracket</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html"><span class="hs-identifier">Orville.PostgreSQL.Internal.OrvilleState</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OrvilleState</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.html"><span class="hs-identifier">Orville.PostgreSQL.Monad</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Monad</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html"><span class="hs-identifier">Orville.PostgreSQL.Raw.RawSql</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RawSql</span></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><span class="hs-comment">{- |
  Performs an action in an Orville monad within a database transaction. The transaction
  in begun before the action is called. If the action completes without raising an exception,
  the transaction will be committed. If the action raises an exception, the transaction will
  rollback.

  This function in safe to call from within another transaction. When called this way the
  transaction will establish a new savepoint at the beginning of the nested transaction and
  either release the savepoint or rollback to it as appropriate.

  Note: Exceptions are handled using the implementations of 'Monad.catch' and
  'Monad.mask'  provided by the 'MonadOrvilleControl' instance for @m@.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-41"></span><span id="local-6989586621679135893"><span id="local-6989586621679135895"><span class="annot"><a href="Orville.PostgreSQL.Execution.Transaction.html#withTransaction"><span class="hs-identifier hs-type">withTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Monad.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679135893"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679135893"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679135895"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679135893"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679135895"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-42"></span><span id="withTransaction"><span class="annot"><span class="annottext">withTransaction :: forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#withTransaction"><span class="hs-identifier hs-var hs-var">withTransaction</span></a></span></span><span> </span><span id="local-6989586621679135972"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679135972"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><span class="annottext">(ConnectedState -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a.
MonadOrville m =&gt;
(ConnectedState -&gt; m a) -&gt; m a
</span><a href="Orville.PostgreSQL.Monad.MonadOrville.html#withConnectedState"><span class="hs-identifier hs-var">Monad.withConnectedState</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectedState -&gt; m a) -&gt; m a) -&gt; (ConnectedState -&gt; m a) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679135974"><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679135974"><span class="hs-identifier hs-var">connectedState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-45"></span><span>      </span><span id="local-6989586621679135975"><span class="annot"><span class="annottext">conn :: Connection
</span><a href="#local-6989586621679135975"><span class="hs-identifier hs-var hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectedState -&gt; Connection
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedConnection"><span class="hs-identifier hs-var">OrvilleState.connectedConnection</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679135974"><span class="hs-identifier hs-var">connectedState</span></a></span><span>
</span><span id="line-46"></span><span>      </span><span id="local-6989586621679135977"><span class="annot"><span class="annottext">transaction :: TransactionState
</span><a href="#local-6989586621679135977"><span class="hs-identifier hs-var hs-var">transaction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe TransactionState -&gt; TransactionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#newTransaction"><span class="hs-identifier hs-var">OrvilleState.newTransaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectedState -&gt; Maybe TransactionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedTransaction"><span class="hs-identifier hs-var">OrvilleState.connectedTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679135974"><span class="hs-identifier hs-var">connectedState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>      </span><span id="local-6989586621679135980"><span class="annot"><span class="annottext">innerConnectedState :: ConnectedState
</span><a href="#local-6989586621679135980"><span class="hs-identifier hs-var hs-var">innerConnectedState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-49"></span><span>        </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679135974"><span class="hs-identifier hs-var">connectedState</span></a></span><span>
</span><span id="line-50"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">connectedTransaction :: Maybe TransactionState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectedTransaction"><span class="hs-identifier hs-var">OrvilleState.connectedTransaction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionState -&gt; Maybe TransactionState
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TransactionState
</span><a href="#local-6989586621679135977"><span class="hs-identifier hs-var">transaction</span></a></span><span>
</span><span id="line-51"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span>    </span><span id="local-6989586621679135981"><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m OrvilleState
forall (m :: * -&gt; *). HasOrvilleState m =&gt; m OrvilleState
</span><a href="Orville.PostgreSQL.Monad.HasOrvilleState.html#askOrvilleState"><span class="hs-identifier hs-var">Monad.askOrvilleState</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-56"></span><span>      </span><span class="annot"><a href="#local-6989586621679135983"><span class="hs-identifier hs-type">executeTransactionSql</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html#RawSql"><span class="hs-identifier hs-type">RawSql.RawSql</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>      </span><span id="local-6989586621679135983"><span class="annot"><span class="annottext">executeTransactionSql :: RawSql -&gt; IO ()
</span><a href="#local-6989586621679135983"><span class="hs-identifier hs-var hs-var">executeTransactionSql</span></a></span></span><span> </span><span id="local-6989586621679135984"><span class="annot"><span class="annottext">RawSql
</span><a href="#local-6989586621679135984"><span class="hs-identifier hs-var">sql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-58"></span><span>        </span><span class="annot"><span class="annottext">QueryType -&gt; RawSql -&gt; OrvilleState -&gt; Connection -&gt; IO ()
forall sql.
SqlExpression sql =&gt;
QueryType -&gt; sql -&gt; OrvilleState -&gt; Connection -&gt; IO ()
</span><a href="Orville.PostgreSQL.Execution.Execute.html#executeVoidIO"><span class="hs-identifier hs-var">Execute.executeVoidIO</span></a></span><span> </span><span class="annot"><span class="annottext">QueryType
</span><a href="Orville.PostgreSQL.Execution.QueryType.html#OtherQuery"><span class="hs-identifier hs-var">QueryType.OtherQuery</span></a></span><span> </span><span class="annot"><span class="annottext">RawSql
</span><a href="#local-6989586621679135984"><span class="hs-identifier hs-var">sql</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679135975"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>      </span><span id="local-6989586621679135987"><span class="annot"><span class="annottext">callback :: TransactionEvent -&gt; IO ()
</span><a href="#local-6989586621679135987"><span class="hs-identifier hs-var hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><span class="annottext">OrvilleState -&gt; TransactionEvent -&gt; IO ()
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleTransactionCallback"><span class="hs-identifier hs-var">OrvilleState.orvilleTransactionCallback</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span>      </span><span id="local-6989586621679135995"><span class="annot"><span class="annottext">beginTransaction :: m ()
</span><a href="#local-6989586621679135995"><span class="hs-identifier hs-var hs-var">beginTransaction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-65"></span><span>          </span><span class="hs-keyword">let</span><span>
</span><span id="line-66"></span><span>            </span><span id="local-6989586621679135996"><span class="annot"><span class="annottext">openEvent :: TransactionEvent
</span><a href="#local-6989586621679135996"><span class="hs-identifier hs-var hs-var">openEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionState -&gt; TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#openTransactionEvent"><span class="hs-identifier hs-var">OrvilleState.openTransactionEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionState
</span><a href="#local-6989586621679135977"><span class="hs-identifier hs-var">transaction</span></a></span><span>
</span><span id="line-67"></span><span>          </span><span class="annot"><span class="annottext">RawSql -&gt; IO ()
</span><a href="#local-6989586621679135983"><span class="hs-identifier hs-var">executeTransactionSql</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrvilleState -&gt; TransactionEvent -&gt; RawSql
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#transactionEventSql"><span class="hs-identifier hs-var">transactionEventSql</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679135996"><span class="hs-identifier hs-var">openEvent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>          </span><span class="annot"><span class="annottext">TransactionEvent -&gt; IO ()
</span><a href="#local-6989586621679135987"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679135996"><span class="hs-identifier hs-var">openEvent</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span>      </span><span id="local-6989586621679136000"><span class="annot"><span class="annottext">doAction :: () -&gt; m a
</span><a href="#local-6989586621679136000"><span class="hs-identifier hs-var hs-var">doAction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><span class="annottext">(OrvilleState -&gt; OrvilleState) -&gt; m a -&gt; m a
forall a. (OrvilleState -&gt; OrvilleState) -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
HasOrvilleState m =&gt;
(OrvilleState -&gt; OrvilleState) -&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Monad.HasOrvilleState.html#localOrvilleState"><span class="hs-identifier hs-var">Monad.localOrvilleState</span></a></span><span>
</span><span id="line-72"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectedState -&gt; OrvilleState -&gt; OrvilleState
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#connectState"><span class="hs-identifier hs-var">OrvilleState.connectState</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectedState
</span><a href="#local-6989586621679135980"><span class="hs-identifier hs-var">innerConnectedState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>          </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679135972"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>      </span><span id="local-6989586621679135922"><span class="annot"><a href="#local-6989586621679136003"><span class="hs-identifier hs-type">finishTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679135922"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.Bracket.html#BracketResult"><span class="hs-identifier hs-type">Bracket.BracketResult</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679135922"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-76"></span><span>      </span><span id="local-6989586621679136003"><span class="annot"><span class="annottext">finishTransaction :: forall (m :: * -&gt; *). MonadIO m =&gt; () -&gt; BracketResult -&gt; m ()
</span><a href="#local-6989586621679136003"><span class="hs-identifier hs-var hs-var">finishTransaction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679136008"><span class="annot"><span class="annottext">BracketResult
</span><a href="#local-6989586621679136008"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BracketResult
</span><a href="#local-6989586621679136008"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-79"></span><span>            </span><span class="annot"><span class="annottext">BracketResult
</span><a href="Orville.PostgreSQL.Internal.Bracket.html#BracketSuccess"><span class="hs-identifier hs-var">Bracket.BracketSuccess</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>              </span><span class="hs-keyword">let</span><span>
</span><span id="line-81"></span><span>                </span><span id="local-6989586621679136010"><span class="annot"><span class="annottext">successEvent :: TransactionEvent
</span><a href="#local-6989586621679136010"><span class="hs-identifier hs-var hs-var">successEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionState -&gt; TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#transactionSuccessEvent"><span class="hs-identifier hs-var">OrvilleState.transactionSuccessEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionState
</span><a href="#local-6989586621679135977"><span class="hs-identifier hs-var">transaction</span></a></span><span>
</span><span id="line-82"></span><span>              </span><span class="annot"><span class="annottext">RawSql -&gt; IO ()
</span><a href="#local-6989586621679135983"><span class="hs-identifier hs-var">executeTransactionSql</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrvilleState -&gt; TransactionEvent -&gt; RawSql
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#transactionEventSql"><span class="hs-identifier hs-var">transactionEventSql</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136010"><span class="hs-identifier hs-var">successEvent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>              </span><span class="annot"><span class="annottext">TransactionEvent -&gt; IO ()
</span><a href="#local-6989586621679135987"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136010"><span class="hs-identifier hs-var">successEvent</span></a></span><span>
</span><span id="line-84"></span><span>            </span><span class="annot"><span class="annottext">BracketResult
</span><a href="Orville.PostgreSQL.Internal.Bracket.html#BracketError"><span class="hs-identifier hs-var">Bracket.BracketError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>              </span><span class="hs-keyword">let</span><span>
</span><span id="line-86"></span><span>                </span><span id="local-6989586621679136013"><span class="annot"><span class="annottext">rollbackEvent :: TransactionEvent
</span><a href="#local-6989586621679136013"><span class="hs-identifier hs-var hs-var">rollbackEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransactionState -&gt; TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#rollbackTransactionEvent"><span class="hs-identifier hs-var">OrvilleState.rollbackTransactionEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionState
</span><a href="#local-6989586621679135977"><span class="hs-identifier hs-var">transaction</span></a></span><span>
</span><span id="line-87"></span><span>              </span><span class="annot"><span class="annottext">RawSql -&gt; IO ()
</span><a href="#local-6989586621679135983"><span class="hs-identifier hs-var">executeTransactionSql</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OrvilleState -&gt; TransactionEvent -&gt; RawSql
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#transactionEventSql"><span class="hs-identifier hs-var">transactionEventSql</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679135981"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136013"><span class="hs-identifier hs-var">rollbackEvent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>              </span><span class="annot"><span class="annottext">TransactionEvent -&gt; IO ()
</span><a href="#local-6989586621679135987"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136013"><span class="hs-identifier hs-var">rollbackEvent</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; (() -&gt; BracketResult -&gt; m ()) -&gt; (() -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) a c b.
(MonadIO m, MonadOrvilleControl m) =&gt;
m a -&gt; (a -&gt; BracketResult -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><a href="Orville.PostgreSQL.Internal.Bracket.html#bracketWithResult"><span class="hs-identifier hs-var">Bracket.bracketWithResult</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679135995"><span class="hs-identifier hs-var">beginTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; BracketResult -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; () -&gt; BracketResult -&gt; m ()
</span><a href="#local-6989586621679136003"><span class="hs-identifier hs-var">finishTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m a
</span><a href="#local-6989586621679136000"><span class="hs-identifier hs-var">doAction</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="annot"><a href="Orville.PostgreSQL.Execution.Transaction.html#transactionEventSql"><span class="hs-identifier hs-type">transactionEventSql</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#OrvilleState"><span class="hs-identifier hs-type">OrvilleState.OrvilleState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#TransactionEvent"><span class="hs-identifier hs-type">OrvilleState.TransactionEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html#RawSql"><span class="hs-identifier hs-type">RawSql.RawSql</span></a></span><span>
</span><span id="line-96"></span><span id="transactionEventSql"><span class="annot"><span class="annottext">transactionEventSql :: OrvilleState -&gt; TransactionEvent -&gt; RawSql
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#transactionEventSql"><span class="hs-identifier hs-var hs-var">transactionEventSql</span></a></span></span><span> </span><span id="local-6989586621679136016"><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679136016"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span id="local-6989586621679136017"><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136017"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="#local-6989586621679136017"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#BeginTransaction"><span class="hs-identifier hs-var">OrvilleState.BeginTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><span class="annottext">BeginTransactionExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(BeginTransactionExpr -&gt; RawSql) -&gt; BeginTransactionExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OrvilleState -&gt; BeginTransactionExpr
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#orvilleBeginTransactionExpr"><span class="hs-identifier hs-var">OrvilleState.orvilleBeginTransactionExpr</span></a></span><span> </span><span class="annot"><span class="annottext">OrvilleState
</span><a href="#local-6989586621679136016"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#NewSavepoint"><span class="hs-identifier hs-type">OrvilleState.NewSavepoint</span></a></span><span> </span><span id="local-6989586621679136022"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136022"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">SavepointExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(SavepointExpr -&gt; RawSql) -&gt; SavepointExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SavepointName -&gt; SavepointExpr
</span><a href="Orville.PostgreSQL.Expr.Transaction.html#savepoint"><span class="hs-identifier hs-var">Expr.savepoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Savepoint -&gt; SavepointName
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#savepointName"><span class="hs-identifier hs-var">savepointName</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136022"><span class="hs-identifier hs-var">savepoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#RollbackTransaction"><span class="hs-identifier hs-var">OrvilleState.RollbackTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">RollbackExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(RollbackExpr -&gt; RawSql) -&gt; RollbackExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RollbackExpr
</span><a href="Orville.PostgreSQL.Expr.Transaction.html#rollback"><span class="hs-identifier hs-var">Expr.rollback</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#RollbackToSavepoint"><span class="hs-identifier hs-type">OrvilleState.RollbackToSavepoint</span></a></span><span> </span><span id="local-6989586621679136028"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136028"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-105"></span><span>      </span><span class="annot"><span class="annottext">RollbackExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(RollbackExpr -&gt; RawSql) -&gt; RollbackExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SavepointName -&gt; RollbackExpr
</span><a href="Orville.PostgreSQL.Expr.Transaction.html#rollbackTo"><span class="hs-identifier hs-var">Expr.rollbackTo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Savepoint -&gt; SavepointName
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#savepointName"><span class="hs-identifier hs-var">savepointName</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136028"><span class="hs-identifier hs-var">savepoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">TransactionEvent
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#CommitTransaction"><span class="hs-identifier hs-var">OrvilleState.CommitTransaction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="annottext">CommitExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(CommitExpr -&gt; RawSql) -&gt; CommitExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CommitExpr
</span><a href="Orville.PostgreSQL.Expr.Transaction.html#commit"><span class="hs-identifier hs-var">Expr.commit</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#ReleaseSavepoint"><span class="hs-identifier hs-type">OrvilleState.ReleaseSavepoint</span></a></span><span> </span><span id="local-6989586621679136033"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136033"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="annottext">ReleaseSavepointExpr -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">(ReleaseSavepointExpr -&gt; RawSql) -&gt; ReleaseSavepointExpr -&gt; RawSql
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SavepointName -&gt; ReleaseSavepointExpr
</span><a href="Orville.PostgreSQL.Expr.Transaction.html#releaseSavepoint"><span class="hs-identifier hs-var">Expr.releaseSavepoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Savepoint -&gt; SavepointName
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#savepointName"><span class="hs-identifier hs-var">savepointName</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136033"><span class="hs-identifier hs-var">savepoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="annot"><span class="hs-comment">{- |
  INTERNAL: Constructs a savepoint name based on the current nesting level of
  transactions, as tracked by the `OrvilleState.Savepoint` type. Strictly
  speaking this is not necessary for PostgreSQL because it supports shadowing
  savepoint names. The SQL standard doesn't allow for savepoint name shadowing,
  however. Re-using this same name in other databases would overwrite the
  savepoint rather than shadow it. This function constructs savepoint names
  that will work on any database that implements savepoints accordings to the
  SQL standard even though Orville only supports PostgreSQL currently.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-123"></span><span class="annot"><a href="Orville.PostgreSQL.Execution.Transaction.html#savepointName"><span class="hs-identifier hs-type">savepointName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.OrvilleState.html#Savepoint"><span class="hs-identifier hs-type">OrvilleState.Savepoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.SavepointName.html#SavepointName"><span class="hs-identifier hs-type">Expr.SavepointName</span></a></span><span>
</span><span id="line-124"></span><span id="savepointName"><span class="annot"><span class="annottext">savepointName :: Savepoint -&gt; SavepointName
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#savepointName"><span class="hs-identifier hs-var hs-var">savepointName</span></a></span></span><span> </span><span id="local-6989586621679136035"><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136035"><span class="hs-identifier hs-var">savepoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679136036"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679136036"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Savepoint -&gt; Int
</span><a href="Orville.PostgreSQL.Internal.OrvilleState.html#savepointNestingLevel"><span class="hs-identifier hs-var">OrvilleState.savepointNestingLevel</span></a></span><span> </span><span class="annot"><span class="annottext">Savepoint
</span><a href="#local-6989586621679136035"><span class="hs-identifier hs-var">savepoint</span></a></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SavepointName
</span><a href="Orville.PostgreSQL.Expr.Internal.Name.SavepointName.html#savepointName"><span class="hs-identifier hs-var">Expr.savepointName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;orville_savepoint_level_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679136036"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span></pre></body></html>