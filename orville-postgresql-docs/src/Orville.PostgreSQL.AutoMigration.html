<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="annot"><span class="hs-comment">{- |
Copyright : Flipstone Technology Partners 2023
License   : MIT
Stability : Stable

Facilities for performing some database migrations automatically.
See 'autoMigrateSchema' as a primary, high level entry point.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Orville.PostgreSQL.AutoMigration</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#autoMigrateSchema"><span class="hs-identifier">autoMigrateSchema</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier">SchemaItem</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemSummary"><span class="hs-identifier">schemaItemSummary</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier">MigrationPlan</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlan"><span class="hs-identifier">generateMigrationPlan</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#migrationPlanSteps"><span class="hs-identifier">migrationPlanSteps</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlan"><span class="hs-identifier">executeMigrationPlan</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier">MigrationStep</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationDataError"><span class="hs-identifier">MigrationDataError</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MigrationLock.html#withMigrationLock"><span class="hs-identifier">MigrationLock.withMigrationLock</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MigrationLock.html#MigrationLockError"><span class="hs-identifier">MigrationLock.MigrationLockError</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">where</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception.Safe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">traverse_</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:|)</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nonEmpty</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Maybe</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">String</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Enc</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.PostgreSQL.LibPQ</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LibPQ</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.html"><span class="hs-identifier">Orville.PostgreSQL</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Orville</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.html"><span class="hs-identifier">Orville.PostgreSQL.Expr</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Expr</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html"><span class="hs-identifier">Orville.PostgreSQL.Internal.IndexDefinition</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IndexDefinition</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.MigrationLock.html"><span class="hs-identifier">Orville.PostgreSQL.Internal.MigrationLock</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MigrationLock</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.html"><span class="hs-identifier">Orville.PostgreSQL.PgCatalog</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PgCatalog</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html"><span class="hs-identifier">Orville.PostgreSQL.Raw.RawSql</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RawSql</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Schema.html"><span class="hs-identifier">Orville.PostgreSQL.Schema</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Schema</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="annot"><span class="hs-comment">{- |
  A 'SchemaItem' represents a single item in a database schema such as a table,
  index or constraint. The constructor functions below can be used to create
  items from other types (such as 'Orville.TableDefinition') to put them into
  a list to be used with 'autoMigrateSchema'.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">data</span><span> </span><span id="SchemaItem"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-var">SchemaItem</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-comment">-- |</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-comment">--    Constructs a 'SchemaItem' from a 'Orville.TableDefinition'.</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-comment">-- @since 1.0.0.0</span><span>
</span><span id="line-63"></span><span>  </span><span id="local-6989586621679142731"><span id="local-6989586621679142732"><span id="local-6989586621679142733"><span id="SchemaTable"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaTable"><span class="hs-identifier hs-var">SchemaTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">Orville.TableDefinition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142731"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142732"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142733"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span></span></span></span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-comment">-- |</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-comment">--    Constructs a 'SchemaItem' that will drop the specified table if it is</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-comment">--    found in the database.</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-comment">-- @since 1.0.0.0</span><span>
</span><span id="line-70"></span><span>  </span><span id="SchemaDropTable"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropTable"><span class="hs-identifier hs-var">SchemaDropTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#TableIdentifier"><span class="hs-identifier hs-type">Orville.TableIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-comment">-- |</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-comment">--    Constructs a 'SchemaItem' from a 'Orville.SequenceDefinition'.</span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-comment">-- @since 1.0.0.0</span><span>
</span><span id="line-76"></span><span>  </span><span id="SchemaSequence"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaSequence"><span class="hs-identifier hs-var">SchemaSequence</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#SequenceDefinition"><span class="hs-identifier hs-type">Orville.SequenceDefinition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-comment">-- |</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-comment">--    Constructs a 'SchemaItem' that will drop the specified table if it is</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-comment">--    found in the database.</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-comment">-- @since 1.0.0.0</span><span>
</span><span id="line-83"></span><span>  </span><span id="SchemaDropSequence"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropSequence"><span class="hs-identifier hs-var">SchemaDropSequence</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#SequenceIdentifier"><span class="hs-identifier hs-type">Orville.SequenceIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><span class="hs-comment">{- |
  Returns a one-line string describe the 'SchemaItem', suitable for a human to
  identify it in a list of output.

  For example, a 'SchemaItem' constructed via 'schemaTable' gives @Table &lt;table
  name&gt;@.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-96"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemSummary"><span class="hs-identifier hs-type">schemaItemSummary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-97"></span><span id="schemaItemSummary"><span class="annot"><span class="annottext">schemaItemSummary :: SchemaItem -&gt; String
</span><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemSummary"><span class="hs-identifier hs-var hs-var">schemaItemSummary</span></a></span></span><span> </span><span id="local-6989586621679142738"><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679142738"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679142738"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaTable"><span class="hs-identifier hs-type">SchemaTable</span></a></span><span> </span><span id="local-6989586621679142740"><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142740"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Table &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdToString"><span class="hs-identifier hs-var">Orville.tableIdToString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableIdentifier
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIdentifier"><span class="hs-identifier hs-var">Orville.tableIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142740"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropTable"><span class="hs-identifier hs-type">SchemaDropTable</span></a></span><span> </span><span id="local-6989586621679142743"><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679142743"><span class="hs-identifier hs-var">tableId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Drop table &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdToString"><span class="hs-identifier hs-var">Orville.tableIdToString</span></a></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679142743"><span class="hs-identifier hs-var">tableId</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaSequence"><span class="hs-identifier hs-type">SchemaSequence</span></a></span><span> </span><span id="local-6989586621679142744"><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142744"><span class="hs-identifier hs-var">sequenceDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Sequence &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#sequenceIdToString"><span class="hs-identifier hs-var">Orville.sequenceIdToString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceDefinition -&gt; SequenceIdentifier
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceIdentifier"><span class="hs-identifier hs-var">Orville.sequenceIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142744"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropSequence"><span class="hs-identifier hs-type">SchemaDropSequence</span></a></span><span> </span><span id="local-6989586621679142747"><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679142747"><span class="hs-identifier hs-var">sequenceId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Drop sequence &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#sequenceIdToString"><span class="hs-identifier hs-var">Orville.sequenceIdToString</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679142747"><span class="hs-identifier hs-var">sequenceId</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="annot"><span class="hs-comment">{- |
A 'MigrationPlan' contains an ordered list of migration steps. Each one is a
single DDL statement to make a specific database change. The steps are ordered
such that dependencies from earlier steps will be in place before a later step
is executed (e.g. new columns are added before foreign keys referring to them).

While most steps are executed together in a single transaction this is not
possible for indexes being created concurrently. Any such steps are executed
last after the transaction for the rest of the schema changes has been
successfully committed.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationPlan"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-var">MigrationPlan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MigrationPlan"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-var">MigrationPlan</span></a></span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="i_transactionalSteps"><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_transactionalSteps"><span class="hs-identifier hs-var hs-var">i_transactionalSteps</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-type">MigrationStep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="i_asynchronusSteps"><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_asynchronusSteps"><span class="hs-identifier hs-var hs-var">i_asynchronusSteps</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-type">MigrationStep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="annot"><span class="hs-comment">{- |
  Returns all the 'MigrationStep's found in a 'MigrationPlan' together in a
  single list. This is useful if you merely want to examine the steps of a plan
  rather than execute them. You should always use 'executeMigrationPlan' to
  execute a migration plan to ensure that the transactional steps are done
  within a transaction while the asynchronous steps are done afterward outside
  of it.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-136"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#migrationPlanSteps"><span class="hs-identifier hs-type">migrationPlanSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-type">MigrationStep</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-137"></span><span id="migrationPlanSteps"><span class="annot"><span class="annottext">migrationPlanSteps :: MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationPlanSteps"><span class="hs-identifier hs-var hs-var">migrationPlanSteps</span></a></span></span><span> </span><span id="local-6989586621679142752"><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142752"><span class="hs-identifier hs-var">plan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_transactionalSteps"><span class="hs-identifier hs-var">i_transactionalSteps</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142752"><span class="hs-identifier hs-var">plan</span></a></span><span> </span><span class="annot"><span class="annottext">[MigrationStep] -&gt; [MigrationStep] -&gt; [MigrationStep]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_asynchronusSteps"><span class="hs-identifier hs-var">i_asynchronusSteps</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142752"><span class="hs-identifier hs-var">plan</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationPlan"><span class="hs-identifier hs-type">mkMigrationPlan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span><span>
</span><span id="line-141"></span><span id="mkMigrationPlan"><span class="annot"><span class="annottext">mkMigrationPlan :: [MigrationStepWithType] -&gt; MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationPlan"><span class="hs-identifier hs-var hs-var">mkMigrationPlan</span></a></span></span><span> </span><span id="local-6989586621679142754"><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142754"><span class="hs-identifier hs-var">steps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679142755"><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142755"><span class="hs-identifier hs-var">transactionalSteps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142756"><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142756"><span class="hs-identifier hs-var">asynchronousSteps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="annottext">(MigrationStepWithType -&gt; Bool)
-&gt; [MigrationStepWithType]
-&gt; ([MigrationStepWithType], [MigrationStepWithType])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">List.partition</span></span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType -&gt; Bool
</span><a href="Orville.PostgreSQL.AutoMigration.html#isMigrationStepTransactional"><span class="hs-identifier hs-var">isMigrationStepTransactional</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; ([MigrationStepWithType], [MigrationStepWithType]))
-&gt; ([MigrationStepWithType] -&gt; [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; ([MigrationStepWithType], [MigrationStepWithType])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(MigrationStepWithType -&gt; StepType)
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">List.sortOn</span></span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType -&gt; StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStepType"><span class="hs-identifier hs-var">migrationStepType</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; ([MigrationStepWithType], [MigrationStepWithType]))
-&gt; [MigrationStepWithType]
-&gt; ([MigrationStepWithType], [MigrationStepWithType])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142754"><span class="hs-identifier hs-var">steps</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">i_transactionalSteps :: [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_transactionalSteps"><span class="hs-identifier hs-var">i_transactionalSteps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MigrationStepWithType -&gt; MigrationStep)
-&gt; [MigrationStepWithType] -&gt; [MigrationStep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType -&gt; MigrationStep
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStep"><span class="hs-identifier hs-var">migrationStep</span></a></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142755"><span class="hs-identifier hs-var">transactionalSteps</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">i_asynchronusSteps :: [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_asynchronusSteps"><span class="hs-identifier hs-var">i_asynchronusSteps</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MigrationStepWithType -&gt; MigrationStep)
-&gt; [MigrationStepWithType] -&gt; [MigrationStep]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType -&gt; MigrationStep
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStep"><span class="hs-identifier hs-var">migrationStep</span></a></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142756"><span class="hs-identifier hs-var">asynchronousSteps</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><span class="hs-comment">{- |
  A single SQL statement that will be executed in order to migrate the database
  to the desired result. You can use 'generateMigrationPlan' to get a list
  of these yourself for inspection and debugging.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-160"></span><span class="hs-keyword">newtype</span><span> </span><span id="MigrationStep"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-var">MigrationStep</span></a></span></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MigrationStep"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-var">MigrationStep</span></a></span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html#RawSql"><span class="hs-identifier hs-type">RawSql.RawSql</span></a></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- | @since 1.0.0.0</span></span><span>
</span><span id="line-164"></span><span>      </span><span id="local-6989586621679142764"><span id="local-6989586621679142769"><span class="annot"><span class="annottext">RawSql -&gt; MigrationStep
MigrationStep -&gt; RawSql
(MigrationStep -&gt; RawSql)
-&gt; (RawSql -&gt; MigrationStep) -&gt; SqlExpression MigrationStep
forall a. (a -&gt; RawSql) -&gt; (RawSql -&gt; a) -&gt; SqlExpression a
$ctoRawSql :: MigrationStep -&gt; RawSql
toRawSql :: MigrationStep -&gt; RawSql
$cunsafeFromRawSql :: RawSql -&gt; MigrationStep
unsafeFromRawSql :: RawSql -&gt; MigrationStep
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#SqlExpression"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">RawSql.SqlExpression</span></a></span></span></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><span class="hs-comment">{- |
  This type is used internally by Orville to order the migration steps after
  they have been created. It is not exposed outside this module.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-173"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationStepWithType"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-var">MigrationStepWithType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MigrationStepWithType"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-var">MigrationStepWithType</span></a></span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="migrationStepType"><span class="annot"><span class="annottext">MigrationStepWithType -&gt; StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStepType"><span class="hs-identifier hs-var hs-var">migrationStepType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="migrationStep"><span class="annot"><span class="annottext">MigrationStepWithType -&gt; MigrationStep
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStep"><span class="hs-identifier hs-var hs-var">migrationStep</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-type">MigrationStep</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span id="local-6989586621679142402"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-type">mkMigrationStepWithType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Raw.RawSql.html#SqlExpression"><span class="hs-identifier hs-type">RawSql.SqlExpression</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142402"><span class="hs-identifier hs-type">sql</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="#local-6989586621679142402"><span class="hs-identifier hs-type">sql</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span></span><span>
</span><span id="line-183"></span><span id="mkMigrationStepWithType"><span class="annot"><span class="annottext">mkMigrationStepWithType :: forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var hs-var">mkMigrationStepWithType</span></a></span></span><span> </span><span id="local-6989586621679142778"><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679142778"><span class="hs-identifier hs-var">stepType</span></a></span></span><span> </span><span id="local-6989586621679142779"><span class="annot"><span class="annottext">sql
</span><a href="#local-6989586621679142779"><span class="hs-identifier hs-var">sql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">migrationStepType :: StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStepType"><span class="hs-identifier hs-var">migrationStepType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679142778"><span class="hs-identifier hs-var">stepType</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">migrationStep :: MigrationStep
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStep"><span class="hs-identifier hs-var">migrationStep</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RawSql -&gt; MigrationStep
</span><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-var">MigrationStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">sql -&gt; RawSql
forall a. SqlExpression a =&gt; a -&gt; RawSql
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toRawSql"><span class="hs-identifier hs-var">RawSql.toRawSql</span></a></span><span> </span><span class="annot"><span class="annottext">sql
</span><a href="#local-6989586621679142779"><span class="hs-identifier hs-var">sql</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#isMigrationStepTransactional"><span class="hs-identifier hs-type">isMigrationStepTransactional</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-190"></span><span id="isMigrationStepTransactional"><span class="annot"><span class="annottext">isMigrationStepTransactional :: MigrationStepWithType -&gt; Bool
</span><a href="Orville.PostgreSQL.AutoMigration.html#isMigrationStepTransactional"><span class="hs-identifier hs-var hs-var">isMigrationStepTransactional</span></a></span></span><span> </span><span id="local-6989586621679142781"><span class="annot"><span class="annottext">MigrationStepWithType
</span><a href="#local-6989586621679142781"><span class="hs-identifier hs-var">stepWithType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType -&gt; StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#migrationStepType"><span class="hs-identifier hs-var">migrationStepType</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType
</span><a href="#local-6989586621679142781"><span class="hs-identifier hs-var">stepWithType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropForeignKeys"><span class="hs-identifier hs-var">DropForeignKeys</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropUniqueConstraints"><span class="hs-identifier hs-var">DropUniqueConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropIndexes"><span class="hs-identifier hs-var">DropIndexes</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesTransactionally"><span class="hs-identifier hs-var">AddIndexesTransactionally</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddUniqueConstraints"><span class="hs-identifier hs-var">AddUniqueConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddForeignKeys"><span class="hs-identifier hs-var">AddForeignKeys</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesAsynchronously"><span class="hs-identifier hs-var">AddIndexesAsynchronously</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="annot"><span class="hs-comment">{- |
  Indicates the kind of operation being performed by a 'MigrationStep' so
  that the steps can be ordered in a sequence that is guaranteed to succeed.
  The order of the constructors below indicates the order in which steps will
  be run.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-209"></span><span class="hs-keyword">data</span><span> </span><span id="StepType"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-var">StepType</span></a></span></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DropForeignKeys"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#DropForeignKeys"><span class="hs-identifier hs-var">DropForeignKeys</span></a></span></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DropUniqueConstraints"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#DropUniqueConstraints"><span class="hs-identifier hs-var">DropUniqueConstraints</span></a></span></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DropIndexes"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#DropIndexes"><span class="hs-identifier hs-var">DropIndexes</span></a></span></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddRemoveTablesAndColumns"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddIndexesTransactionally"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesTransactionally"><span class="hs-identifier hs-var">AddIndexesTransactionally</span></a></span></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddUniqueConstraints"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#AddUniqueConstraints"><span class="hs-identifier hs-var">AddUniqueConstraints</span></a></span></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddForeignKeys"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#AddForeignKeys"><span class="hs-identifier hs-var">AddForeignKeys</span></a></span></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddIndexesAsynchronously"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesAsynchronously"><span class="hs-identifier hs-var">AddIndexesAsynchronously</span></a></span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- | @since 1.0.0.0</span></span><span>
</span><span id="line-220"></span><span>      </span><span id="local-6989586621679142791"><span id="local-6989586621679142793"><span class="annot"><span class="annottext">StepType -&gt; StepType -&gt; Bool
(StepType -&gt; StepType -&gt; Bool)
-&gt; (StepType -&gt; StepType -&gt; Bool) -&gt; Eq StepType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: StepType -&gt; StepType -&gt; Bool
== :: StepType -&gt; StepType -&gt; Bool
$c/= :: StepType -&gt; StepType -&gt; Bool
/= :: StepType -&gt; StepType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-comment">-- | @since 1.0.0.0</span></span><span>
</span><span id="line-222"></span><span>      </span><span id="local-6989586621679142800"><span id="local-6989586621679142802"><span id="local-6989586621679142804"><span id="local-6989586621679142807"><span id="local-6989586621679142810"><span id="local-6989586621679142813"><span id="local-6989586621679142816"><span class="annot"><span class="annottext">Eq StepType
Eq StepType
-&gt; (StepType -&gt; StepType -&gt; Ordering)
-&gt; (StepType -&gt; StepType -&gt; Bool)
-&gt; (StepType -&gt; StepType -&gt; Bool)
-&gt; (StepType -&gt; StepType -&gt; Bool)
-&gt; (StepType -&gt; StepType -&gt; Bool)
-&gt; (StepType -&gt; StepType -&gt; StepType)
-&gt; (StepType -&gt; StepType -&gt; StepType)
-&gt; Ord StepType
StepType -&gt; StepType -&gt; Bool
StepType -&gt; StepType -&gt; Ordering
StepType -&gt; StepType -&gt; StepType
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: StepType -&gt; StepType -&gt; Ordering
compare :: StepType -&gt; StepType -&gt; Ordering
$c&lt; :: StepType -&gt; StepType -&gt; Bool
&lt; :: StepType -&gt; StepType -&gt; Bool
$c&lt;= :: StepType -&gt; StepType -&gt; Bool
&lt;= :: StepType -&gt; StepType -&gt; Bool
$c&gt; :: StepType -&gt; StepType -&gt; Bool
&gt; :: StepType -&gt; StepType -&gt; Bool
$c&gt;= :: StepType -&gt; StepType -&gt; Bool
&gt;= :: StepType -&gt; StepType -&gt; Bool
$cmax :: StepType -&gt; StepType -&gt; StepType
max :: StepType -&gt; StepType -&gt; StepType
$cmin :: StepType -&gt; StepType -&gt; StepType
min :: StepType -&gt; StepType -&gt; StepType
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="annot"><span class="hs-comment">{- |
  A 'MigrationDataError' will be thrown from the migration functions if data
  necessary for migration cannot be found.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-231"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationDataError"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationDataError"><span class="hs-identifier hs-var">MigrationDataError</span></a></span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="UnableToDiscoverCurrentSchema"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#UnableToDiscoverCurrentSchema"><span class="hs-identifier hs-var">UnableToDiscoverCurrentSchema</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PgCatalogInvariantViolated"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#PgCatalogInvariantViolated"><span class="hs-identifier hs-var">PgCatalogInvariantViolated</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- | @since 1.0.0.0</span></span><span>
</span><span id="line-236"></span><span>      </span><span id="local-6989586621679142822"><span id="local-6989586621679142831"><span id="local-6989586621679142835"><span class="annot"><span class="annottext">Int -&gt; MigrationDataError -&gt; String -&gt; String
[MigrationDataError] -&gt; String -&gt; String
MigrationDataError -&gt; String
(Int -&gt; MigrationDataError -&gt; String -&gt; String)
-&gt; (MigrationDataError -&gt; String)
-&gt; ([MigrationDataError] -&gt; String -&gt; String)
-&gt; Show MigrationDataError
forall a.
(Int -&gt; a -&gt; String -&gt; String)
-&gt; (a -&gt; String) -&gt; ([a] -&gt; String -&gt; String) -&gt; Show a
$cshowsPrec :: Int -&gt; MigrationDataError -&gt; String -&gt; String
showsPrec :: Int -&gt; MigrationDataError -&gt; String -&gt; String
$cshow :: MigrationDataError -&gt; String
show :: MigrationDataError -&gt; String
$cshowList :: [MigrationDataError] -&gt; String -&gt; String
showList :: [MigrationDataError] -&gt; String -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><span class="hs-comment">-- | @since 1.0.0.0</span></span><span>
</span><span id="line-240"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679142844"><span id="local-6989586621679142848"><span id="local-6989586621679142851"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationDataError"><span class="hs-identifier hs-type">MigrationDataError</span></a></span></span></span></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="annot"><span class="hs-comment">{- |
  This function compares the list of 'SchemaItem's provided against the current
  schema found in the database to determine whether any migration are
  necessary.  If any changes need to be made, this function executes. You can
  call 'generateMigrationPlan' and 'executeMigrationPlan' yourself if you want
  to have more control over the process, but must then take care to ensure that
  the schema has not changed between the two calls. This function uses an
  PostgreSQL advisory lock to ensure that no other calls to 'autoMigrateSchema'
  (potentially on other processes) attempt to modify the schema at the same
  time.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-255"></span><span id="local-6989586621679142412"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#autoMigrateSchema"><span class="hs-identifier hs-type">autoMigrateSchema</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-256"></span><span id="autoMigrateSchema"><span class="annot"><span class="annottext">autoMigrateSchema :: forall (m :: * -&gt; *). MonadOrville m =&gt; [SchemaItem] -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#autoMigrateSchema"><span class="hs-identifier hs-var hs-var">autoMigrateSchema</span></a></span></span><span> </span><span id="local-6989586621679142863"><span class="annot"><span class="annottext">[SchemaItem]
</span><a href="#local-6989586621679142863"><span class="hs-identifier hs-var">schemaItems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MigrationLock.html#withMigrationLock"><span class="hs-identifier hs-var">MigrationLock.withMigrationLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621679142864"><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142864"><span class="hs-identifier hs-var">plan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SchemaItem] -&gt; m MigrationPlan
forall (m :: * -&gt; *).
MonadOrville m =&gt;
[SchemaItem] -&gt; m MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlanWithoutLock"><span class="hs-identifier hs-var">generateMigrationPlanWithoutLock</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaItem]
</span><a href="#local-6989586621679142863"><span class="hs-identifier hs-var">schemaItems</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="annottext">MigrationPlan -&gt; m ()
forall (m :: * -&gt; *). MonadOrville m =&gt; MigrationPlan -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlanWithoutLock"><span class="hs-identifier hs-var">executeMigrationPlanWithoutLock</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142864"><span class="hs-identifier hs-var">plan</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><span class="hs-comment">{- |
  Compares the list of 'SchemaItem's provided against the current schema found
  in the database and returns a 'MigrationPlan' that could be executed to make
  the database schema match the items given.

  You can execute the 'MigrationPlan' yourself using 'executeMigrationPlan'
  convenience function, though 'autoMigrateSchema' is usually a better option
  because it uses a database lock to ensure that no other processes are also
  using 'autoMigrateSchema' to apply migrations at the same time. If you use
  'generateMigrationPlan' and 'executeMigrationPlan' separately you are
  responsible for ensuring that the schema has no changed between the time the
  plan is generated and executed yourself.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-276"></span><span id="local-6989586621679142867"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlan"><span class="hs-identifier hs-type">generateMigrationPlan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span></span><span>
</span><span id="line-277"></span><span id="generateMigrationPlan"><span class="annot"><span class="annottext">generateMigrationPlan :: forall (m :: * -&gt; *).
MonadOrville m =&gt;
[SchemaItem] -&gt; m MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlan"><span class="hs-identifier hs-var hs-var">generateMigrationPlan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="annottext">m MigrationPlan -&gt; m MigrationPlan
forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MigrationLock.html#withMigrationLock"><span class="hs-identifier hs-var">MigrationLock.withMigrationLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m MigrationPlan -&gt; m MigrationPlan)
-&gt; ([SchemaItem] -&gt; m MigrationPlan)
-&gt; [SchemaItem]
-&gt; m MigrationPlan
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SchemaItem] -&gt; m MigrationPlan
forall (m :: * -&gt; *).
MonadOrville m =&gt;
[SchemaItem] -&gt; m MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlanWithoutLock"><span class="hs-identifier hs-var">generateMigrationPlanWithoutLock</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span id="local-6989586621679142420"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlanWithoutLock"><span class="hs-identifier hs-type">generateMigrationPlanWithoutLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142420"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142420"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span></span><span>
</span><span id="line-281"></span><span id="generateMigrationPlanWithoutLock"><span class="annot"><span class="annottext">generateMigrationPlanWithoutLock :: forall (m :: * -&gt; *).
MonadOrville m =&gt;
[SchemaItem] -&gt; m MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#generateMigrationPlanWithoutLock"><span class="hs-identifier hs-var hs-var">generateMigrationPlanWithoutLock</span></a></span></span><span> </span><span id="local-6989586621679142892"><span class="annot"><span class="annottext">[SchemaItem]
</span><a href="#local-6989586621679142892"><span class="hs-identifier hs-var">schemaItems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">m MigrationPlan -&gt; m MigrationPlan
forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#withTransaction"><span class="hs-identifier hs-var">Orville.withTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">(m MigrationPlan -&gt; m MigrationPlan)
-&gt; m MigrationPlan -&gt; m MigrationPlan
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621679142894"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142894"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m NamespaceName
forall (m :: * -&gt; *). MonadOrville m =&gt; m NamespaceName
</span><a href="Orville.PostgreSQL.AutoMigration.html#findCurrentNamespace"><span class="hs-identifier hs-var">findCurrentNamespace</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-286"></span><span>      </span><span id="local-6989586621679142896"><span class="annot"><span class="annottext">pgCatalogRelations :: [(NamespaceName, RelationName)]
</span><a href="#local-6989586621679142896"><span class="hs-identifier hs-var hs-var">pgCatalogRelations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SchemaItem -&gt; (NamespaceName, RelationName))
-&gt; [SchemaItem] -&gt; [(NamespaceName, RelationName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName -&gt; SchemaItem -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemPgCatalogRelation"><span class="hs-identifier hs-var">schemaItemPgCatalogRelation</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142894"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SchemaItem]
</span><a href="#local-6989586621679142892"><span class="hs-identifier hs-var">schemaItems</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621679142898"><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142898"><span class="hs-identifier hs-var">dbDesc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(NamespaceName, RelationName)] -&gt; m DatabaseDescription
forall (m :: * -&gt; *).
MonadOrville m =&gt;
[(NamespaceName, RelationName)] -&gt; m DatabaseDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#describeDatabaseRelations"><span class="hs-identifier hs-var">PgCatalog.describeDatabaseRelations</span></a></span><span> </span><span class="annot"><span class="annottext">[(NamespaceName, RelationName)]
</span><a href="#local-6989586621679142896"><span class="hs-identifier hs-var">pgCatalogRelations</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(SchemaItem -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; [SchemaItem]
-&gt; Either MigrationDataError [[MigrationStepWithType]]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
-&gt; DatabaseDescription
-&gt; SchemaItem
-&gt; Either MigrationDataError [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#calculateMigrationSteps"><span class="hs-identifier hs-var">calculateMigrationSteps</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142894"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142898"><span class="hs-identifier hs-var">dbDesc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SchemaItem]
</span><a href="#local-6989586621679142892"><span class="hs-identifier hs-var">schemaItems</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679142902"><span class="annot"><span class="annottext">MigrationDataError
</span><a href="#local-6989586621679142902"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">IO MigrationPlan -&gt; m MigrationPlan
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO MigrationPlan -&gt; m MigrationPlan)
-&gt; (MigrationDataError -&gt; IO MigrationPlan)
-&gt; MigrationDataError
-&gt; m MigrationPlan
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MigrationDataError -&gt; IO MigrationPlan
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(MigrationDataError -&gt; m MigrationPlan)
-&gt; MigrationDataError -&gt; m MigrationPlan
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MigrationDataError
</span><a href="#local-6989586621679142902"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679142903"><span class="annot"><span class="annottext">[[MigrationStepWithType]]
</span><a href="#local-6989586621679142903"><span class="hs-identifier hs-var">migrationSteps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">MigrationPlan -&gt; m MigrationPlan
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MigrationPlan -&gt; m MigrationPlan)
-&gt; ([[MigrationStepWithType]] -&gt; MigrationPlan)
-&gt; [[MigrationStepWithType]]
-&gt; m MigrationPlan
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType] -&gt; MigrationPlan
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationPlan"><span class="hs-identifier hs-var">mkMigrationPlan</span></a></span><span> </span><span class="annot"><span class="annottext">([MigrationStepWithType] -&gt; MigrationPlan)
-&gt; ([[MigrationStepWithType]] -&gt; [MigrationStepWithType])
-&gt; [[MigrationStepWithType]]
-&gt; MigrationPlan
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[[MigrationStepWithType]] -&gt; [MigrationStepWithType]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[MigrationStepWithType]] -&gt; m MigrationPlan)
-&gt; [[MigrationStepWithType]] -&gt; m MigrationPlan
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[MigrationStepWithType]]
</span><a href="#local-6989586621679142903"><span class="hs-identifier hs-var">migrationSteps</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="annot"><span class="hs-comment">{- |
  Executes a 'MigrationPlan' that has be previously devised via
  'generateMigrationPlan'. Normally all the steps in a migration plan are
  executed in a transaction so that they will all be applied together
  successfully or all rolled-back if one of them fails. Any indexes using the
  'Orville.Asynchronous' creation strategy cannot be created this way, however,
  because PostgreSQL does not allow @CREATE INDEX CONCURRENTLY@ to be used from
  inside a transaction. If a 'MigrationPlan' includes any indexes whose
  creation strategy is set to 'Orville.Asynchronous', Orville will begin the
  creation of those indexes after the rest of the migration steps have been
  committed successfully. This function will return before PostgreSQL has
  fineshed creating those indexes. You should check on the status of indexes
  created this way manually to ensure they were created successfully. If they
  could not be, you can drop them and Orville will re-attempt creating them the
  next time migration is performed.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-314"></span><span id="local-6989586621679142906"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlan"><span class="hs-identifier hs-type">executeMigrationPlan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-315"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><a href="#local-6989586621679142906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-318"></span><span id="executeMigrationPlan"><span class="annot"><span class="annottext">executeMigrationPlan :: forall (m :: * -&gt; *). MonadOrville m =&gt; MigrationPlan -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlan"><span class="hs-identifier hs-var hs-var">executeMigrationPlan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Internal.MigrationLock.html#withMigrationLock"><span class="hs-identifier hs-var">MigrationLock.withMigrationLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (MigrationPlan -&gt; m ()) -&gt; MigrationPlan -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MigrationPlan -&gt; m ()
forall (m :: * -&gt; *). MonadOrville m =&gt; MigrationPlan -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlanWithoutLock"><span class="hs-identifier hs-var">executeMigrationPlanWithoutLock</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span id="local-6989586621679142421"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlanWithoutLock"><span class="hs-identifier hs-type">executeMigrationPlanWithoutLock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142421"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><a href="#local-6989586621679142421"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-325"></span><span id="executeMigrationPlanWithoutLock"><span class="annot"><span class="annottext">executeMigrationPlanWithoutLock :: forall (m :: * -&gt; *). MonadOrville m =&gt; MigrationPlan -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationPlanWithoutLock"><span class="hs-identifier hs-var hs-var">executeMigrationPlanWithoutLock</span></a></span></span><span> </span><span id="local-6989586621679142917"><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142917"><span class="hs-identifier hs-var">plan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. MonadOrville m =&gt; m a -&gt; m a
</span><a href="Orville.PostgreSQL.Execution.Transaction.html#withTransaction"><span class="hs-identifier hs-var">Orville.withTransaction</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">[MigrationStep] -&gt; m ()
forall (m :: * -&gt; *). MonadOrville m =&gt; [MigrationStep] -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationStepsWithoutTransaction"><span class="hs-identifier hs-var">executeMigrationStepsWithoutTransaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_transactionalSteps"><span class="hs-identifier hs-var">i_transactionalSteps</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142917"><span class="hs-identifier hs-var">plan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>  </span><span class="annot"><span class="annottext">[MigrationStep] -&gt; m ()
forall (m :: * -&gt; *). MonadOrville m =&gt; [MigrationStep] -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationStepsWithoutTransaction"><span class="hs-identifier hs-var">executeMigrationStepsWithoutTransaction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MigrationPlan -&gt; [MigrationStep]
</span><a href="Orville.PostgreSQL.AutoMigration.html#i_asynchronusSteps"><span class="hs-identifier hs-var">i_asynchronusSteps</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationPlan
</span><a href="#local-6989586621679142917"><span class="hs-identifier hs-var">plan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span id="local-6989586621679142447"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationStepsWithoutTransaction"><span class="hs-identifier hs-type">executeMigrationStepsWithoutTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142447"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStep"><span class="hs-identifier hs-type">MigrationStep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142447"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-332"></span><span id="executeMigrationStepsWithoutTransaction"><span class="annot"><span class="annottext">executeMigrationStepsWithoutTransaction :: forall (m :: * -&gt; *). MonadOrville m =&gt; [MigrationStep] -&gt; m ()
</span><a href="Orville.PostgreSQL.AutoMigration.html#executeMigrationStepsWithoutTransaction"><span class="hs-identifier hs-var hs-var">executeMigrationStepsWithoutTransaction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><span class="annottext">(MigrationStep -&gt; m ()) -&gt; [MigrationStep] -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QueryType -&gt; MigrationStep -&gt; m ()
forall (m :: * -&gt; *) sql.
(MonadOrville m, SqlExpression sql) =&gt;
QueryType -&gt; sql -&gt; m ()
</span><a href="Orville.PostgreSQL.Execution.Execute.html#executeVoid"><span class="hs-identifier hs-var">Orville.executeVoid</span></a></span><span> </span><span class="annot"><span class="annottext">QueryType
</span><a href="Orville.PostgreSQL.Execution.QueryType.html#DDLQuery"><span class="hs-identifier hs-var">Orville.DDLQuery</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#calculateMigrationSteps"><span class="hs-identifier hs-type">calculateMigrationSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#DatabaseDescription"><span class="hs-identifier hs-type">PgCatalog.DatabaseDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationDataError"><span class="hs-identifier hs-type">MigrationDataError</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span id="calculateMigrationSteps"><span class="annot"><span class="annottext">calculateMigrationSteps :: NamespaceName
-&gt; DatabaseDescription
-&gt; SchemaItem
-&gt; Either MigrationDataError [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#calculateMigrationSteps"><span class="hs-identifier hs-var hs-var">calculateMigrationSteps</span></a></span></span><span> </span><span id="local-6989586621679142929"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679142930"><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142930"><span class="hs-identifier hs-var">dbDesc</span></a></span></span><span> </span><span id="local-6989586621679142931"><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679142931"><span class="hs-identifier hs-var">schemaItem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679142931"><span class="hs-identifier hs-var">schemaItem</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaTable"><span class="hs-identifier hs-type">SchemaTable</span></a></span><span> </span><span id="local-6989586621679142932"><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142932"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-345"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679142933"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142933"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142934"><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142934"><span class="hs-identifier hs-var">tableName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">NamespaceName -&gt; TableIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-var">tableIdToPgCatalogNames</span></a></span><span>
</span><span id="line-347"></span><span>              </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span>
</span><span id="line-348"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableIdentifier
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIdentifier"><span class="hs-identifier hs-var">Orville.tableIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142932"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-350"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RelationKind
-&gt; (NamespaceName, RelationName)
-&gt; DatabaseDescription
-&gt; Maybe RelationDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupRelationOfKind"><span class="hs-identifier hs-var">PgCatalog.lookupRelationOfKind</span></a></span><span> </span><span class="annot"><span class="annottext">RelationKind
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#OrdinaryTable"><span class="hs-identifier hs-var">PgCatalog.OrdinaryTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142933"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142934"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142930"><span class="hs-identifier hs-var">dbDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-351"></span><span>            </span><span class="annot"><span class="annottext">Maybe RelationDescription
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>              </span><span class="annot"><span class="annottext">NamespaceName
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
forall key writeEntity readEntity.
NamespaceName
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkCreateTableSteps"><span class="hs-identifier hs-var">mkCreateTableSteps</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142932"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-353"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679142939"><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679142939"><span class="hs-identifier hs-var">relationDesc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>              </span><span class="annot"><span class="annottext">NamespaceName
-&gt; RelationDescription
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
forall key writeEntity readEntity.
NamespaceName
-&gt; RelationDescription
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterTableSteps"><span class="hs-identifier hs-var">mkAlterTableSteps</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679142939"><span class="hs-identifier hs-var">relationDesc</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142932"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropTable"><span class="hs-identifier hs-type">SchemaDropTable</span></a></span><span> </span><span id="local-6989586621679142941"><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679142941"><span class="hs-identifier hs-var">tableId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-358"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679142942"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142942"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142943"><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142943"><span class="hs-identifier hs-var">tableName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-359"></span><span>            </span><span class="annot"><span class="annottext">NamespaceName -&gt; TableIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-var">tableIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679142941"><span class="hs-identifier hs-var">tableId</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-361"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(NamespaceName, RelationName)
-&gt; DatabaseDescription -&gt; Maybe RelationDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupRelation"><span class="hs-identifier hs-var">PgCatalog.lookupRelation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142942"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142943"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142930"><span class="hs-identifier hs-var">dbDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-362"></span><span>            </span><span class="annot"><span class="annottext">Maybe RelationDescription
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-363"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>              </span><span class="hs-keyword">let</span><span>
</span><span id="line-366"></span><span>                </span><span id="local-6989586621679142945"><span class="annot"><span class="annottext">dropTableExpr :: DropTableExpr
</span><a href="#local-6989586621679142945"><span class="hs-identifier hs-var hs-var">dropTableExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>                  </span><span class="annot"><span class="annottext">Maybe IfExists -&gt; Qualified TableName -&gt; DropTableExpr
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#dropTableExpr"><span class="hs-identifier hs-var">Expr.dropTableExpr</span></a></span><span>
</span><span id="line-368"></span><span>                    </span><span class="annot"><span class="annottext">Maybe IfExists
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-369"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableIdentifier -&gt; Qualified TableName
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdQualifiedName"><span class="hs-identifier hs-var">Orville.tableIdQualifiedName</span></a></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679142941"><span class="hs-identifier hs-var">tableId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>              </span><span class="hs-keyword">in</span><span>
</span><span id="line-371"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StepType -&gt; DropTableExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span> </span><span class="annot"><span class="annottext">DropTableExpr
</span><a href="#local-6989586621679142945"><span class="hs-identifier hs-var">dropTableExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaSequence"><span class="hs-identifier hs-type">SchemaSequence</span></a></span><span> </span><span id="local-6989586621679142948"><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142948"><span class="hs-identifier hs-var">sequenceDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-373"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679142949"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142949"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142950"><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142950"><span class="hs-identifier hs-var">sequenceName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-375"></span><span>          </span><span class="annot"><span class="annottext">NamespaceName
-&gt; SequenceIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-var">sequenceIdToPgCatalogNames</span></a></span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceDefinition -&gt; SequenceIdentifier
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceIdentifier"><span class="hs-identifier hs-var">Orville.sequenceIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142948"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-keyword">in</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RelationKind
-&gt; (NamespaceName, RelationName)
-&gt; DatabaseDescription
-&gt; Maybe RelationDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupRelationOfKind"><span class="hs-identifier hs-var">PgCatalog.lookupRelationOfKind</span></a></span><span> </span><span class="annot"><span class="annottext">RelationKind
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#Sequence"><span class="hs-identifier hs-var">PgCatalog.Sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142949"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142950"><span class="hs-identifier hs-var">sequenceName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142930"><span class="hs-identifier hs-var">dbDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-380"></span><span>          </span><span class="annot"><span class="annottext">Maybe RelationDescription
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>            </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span>
</span><span id="line-382"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">StepType -&gt; CreateSequenceExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span>
</span><span id="line-383"></span><span>                  </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span>
</span><span id="line-384"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceDefinition -&gt; CreateSequenceExpr
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#mkCreateSequenceExpr"><span class="hs-identifier hs-var">Orville.mkCreateSequenceExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142948"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-386"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679142954"><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679142954"><span class="hs-identifier hs-var">relationDesc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-387"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RelationDescription -&gt; Maybe PgSequence
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationSequence"><span class="hs-identifier hs-var">PgCatalog.relationSequence</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679142954"><span class="hs-identifier hs-var">relationDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-388"></span><span>              </span><span class="annot"><span class="annottext">Maybe PgSequence
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-389"></span><span>                </span><span class="annot"><span class="annottext">MigrationDataError
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(MigrationDataError
 -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; (String -&gt; MigrationDataError)
-&gt; String
-&gt; Either MigrationDataError [MigrationStepWithType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; MigrationDataError
</span><a href="Orville.PostgreSQL.AutoMigration.html#PgCatalogInvariantViolated"><span class="hs-identifier hs-var">PgCatalogInvariantViolated</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; String -&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>                  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Sequence &quot;</span></span><span>
</span><span id="line-391"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">NamespaceName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#namespaceNameToString"><span class="hs-identifier hs-var">PgCatalog.namespaceNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142949"><span class="hs-identifier hs-var">schemaName</span></a></span><span>
</span><span id="line-392"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-393"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RelationName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#relationNameToString"><span class="hs-identifier hs-var">PgCatalog.relationNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142950"><span class="hs-identifier hs-var">sequenceName</span></a></span><span>
</span><span id="line-394"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; was found in the 'pg_class' table but no corresponding 'pg_sequence' row was found&quot;</span></span><span>
</span><span id="line-395"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679142958"><span class="annot"><span class="annottext">PgSequence
</span><a href="#local-6989586621679142958"><span class="hs-identifier hs-var">pgSequence</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>                </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-397"></span><span>                  </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; PgSequence -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterSequenceSteps"><span class="hs-identifier hs-var">mkAlterSequenceSteps</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679142948"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence
</span><a href="#local-6989586621679142958"><span class="hs-identifier hs-var">pgSequence</span></a></span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropSequence"><span class="hs-identifier hs-type">SchemaDropSequence</span></a></span><span> </span><span id="local-6989586621679142960"><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679142960"><span class="hs-identifier hs-var">sequenceId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">([MigrationStepWithType]
 -&gt; Either MigrationDataError [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; Either MigrationDataError [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-401"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679142961"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142961"><span class="hs-identifier hs-var">schemaName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679142962"><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142962"><span class="hs-identifier hs-var">sequenceName</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>            </span><span class="annot"><span class="annottext">NamespaceName
-&gt; SequenceIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-var">sequenceIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142929"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679142960"><span class="hs-identifier hs-var">sequenceId</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-404"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RelationKind
-&gt; (NamespaceName, RelationName)
-&gt; DatabaseDescription
-&gt; Maybe RelationDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupRelationOfKind"><span class="hs-identifier hs-var">PgCatalog.lookupRelationOfKind</span></a></span><span> </span><span class="annot"><span class="annottext">RelationKind
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#Sequence"><span class="hs-identifier hs-var">PgCatalog.Sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142961"><span class="hs-identifier hs-var">schemaName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679142962"><span class="hs-identifier hs-var">sequenceName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DatabaseDescription
</span><a href="#local-6989586621679142930"><span class="hs-identifier hs-var">dbDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-405"></span><span>            </span><span class="annot"><span class="annottext">Maybe RelationDescription
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-406"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-407"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-408"></span><span>              </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">StepType -&gt; DropSequenceExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span>
</span><span id="line-409"></span><span>                  </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span>
</span><span id="line-410"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe IfExists -&gt; Qualified SequenceName -&gt; DropSequenceExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#dropSequenceExpr"><span class="hs-identifier hs-var">Expr.dropSequenceExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe IfExists
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceIdentifier -&gt; Qualified SequenceName
</span><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#sequenceIdQualifiedName"><span class="hs-identifier hs-var">Orville.sequenceIdQualifiedName</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679142960"><span class="hs-identifier hs-var">sequenceId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="annot"><span class="hs-comment">{- |
  Builds 'MigrationStep's that will perform table creation. This function
  assumes the table does not exist. The migration step it produces will fail if
  the table already exists in its schema. Multiple steps may be required to
  create the table if foreign keys exist to that reference other tables, which
  may not have been created yet.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-422"></span><span id="local-6989586621679142463"><span id="local-6989586621679142464"><span id="local-6989586621679142465"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkCreateTableSteps"><span class="hs-identifier hs-type">mkCreateTableSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">Orville.TableDefinition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142463"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142464"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142465"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-426"></span><span id="mkCreateTableSteps"><span class="annot"><span class="annottext">mkCreateTableSteps :: forall key writeEntity readEntity.
NamespaceName
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkCreateTableSteps"><span class="hs-identifier hs-var hs-var">mkCreateTableSteps</span></a></span></span><span> </span><span id="local-6989586621679142971"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142971"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679142972"><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621679142973"><span class="annot"><span class="annottext">tableName :: Qualified TableName
</span><a href="#local-6989586621679142973"><span class="hs-identifier hs-var hs-var">tableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-429"></span><span>      </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; Qualified TableName
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; Qualified TableName
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableName"><span class="hs-identifier hs-var">Orville.tableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-comment">-- constraints are not included in the create table expression because</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-comment">-- they are added in a separate migration step to avoid ordering problems</span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-comment">-- when creating multiple tables with interrelated foreign keys.</span><span>
</span><span id="line-434"></span><span>    </span><span id="local-6989586621679142975"><span class="annot"><span class="annottext">createTableExpr :: CreateTableExpr
</span><a href="#local-6989586621679142975"><span class="hs-identifier hs-var hs-var">createTableExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><span class="annottext">Qualified TableName
-&gt; [ColumnDefinition]
-&gt; Maybe PrimaryKeyExpr
-&gt; [TableConstraint]
-&gt; CreateTableExpr
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#createTableExpr"><span class="hs-identifier hs-var">Expr.createTableExpr</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679142973"><span class="hs-identifier hs-var">tableName</span></a></span><span>
</span><span id="line-437"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; [ColumnDefinition]
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; [ColumnDefinition]
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#mkTableColumnDefinitions"><span class="hs-identifier hs-var">Orville.mkTableColumnDefinitions</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; Maybe PrimaryKeyExpr
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; Maybe PrimaryKeyExpr
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#mkTablePrimaryKeyExpr"><span class="hs-identifier hs-var">Orville.mkTablePrimaryKeyExpr</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679142979"><span class="annot"><span class="annottext">addConstraintActions :: [(StepType, AlterTableAction)]
</span><a href="#local-6989586621679142979"><span class="hs-identifier hs-var hs-var">addConstraintActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">(ConstraintDefinition -&gt; [(StepType, AlterTableAction)])
-&gt; [ConstraintDefinition] -&gt; [(StepType, AlterTableAction)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
-&gt; Set ConstraintMigrationKey
-&gt; ConstraintDefinition
-&gt; [(StepType, AlterTableAction)]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddConstraintActions"><span class="hs-identifier hs-var">mkAddConstraintActions</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679142971"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableConstraints -&gt; [ConstraintDefinition]
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#tableConstraintDefinitions"><span class="hs-identifier hs-var">Schema.tableConstraintDefinitions</span></a></span><span> </span><span class="annot"><span class="annottext">(TableConstraints -&gt; [ConstraintDefinition])
-&gt; TableConstraints -&gt; [ConstraintDefinition]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableConstraints
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableConstraints
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableConstraints"><span class="hs-identifier hs-var">Orville.tableConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>    </span><span id="local-6989586621679142985"><span class="annot"><span class="annottext">addIndexSteps :: [MigrationStepWithType]
</span><a href="#local-6989586621679142985"><span class="hs-identifier hs-var hs-var">addIndexSteps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-447"></span><span>      </span><span class="annot"><span class="annottext">(IndexDefinition -&gt; [MigrationStepWithType])
-&gt; Map IndexMigrationKey IndexDefinition -&gt; [MigrationStepWithType]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set IndexMigrationKey
-&gt; Qualified TableName
-&gt; IndexDefinition
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddIndexSteps"><span class="hs-identifier hs-var">mkAddIndexSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Set IndexMigrationKey
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679142973"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIndexes"><span class="hs-identifier hs-var">Orville.tableIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679142972"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">StepType -&gt; CreateTableExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span> </span><span class="annot"><span class="annottext">CreateTableExpr
</span><a href="#local-6989586621679142975"><span class="hs-identifier hs-var">createTableExpr</span></a></span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><span class="annottext">MigrationStepWithType
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
-&gt; [(StepType, AlterTableAction)] -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkConstraintSteps"><span class="hs-identifier hs-var">mkConstraintSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679142973"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
</span><a href="#local-6989586621679142979"><span class="hs-identifier hs-var">addConstraintActions</span></a></span><span>
</span><span id="line-453"></span><span>        </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679142985"><span class="hs-identifier hs-var">addIndexSteps</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="annot"><span class="hs-comment">{- |
  Builds migration steps that are required to create or alter the table's
  schema to make it match the given table definition.

  This function uses the given relation description to determine what
  alterations need to be performed. If there is nothing to do, an empty list
  will be returned.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-465"></span><span id="local-6989586621679142466"><span id="local-6989586621679142467"><span id="local-6989586621679142468"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterTableSteps"><span class="hs-identifier hs-type">mkAlterTableSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-466"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-467"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#RelationDescription"><span class="hs-identifier hs-type">PgCatalog.RelationDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-468"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">Orville.TableDefinition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142466"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142467"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142468"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-469"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-470"></span><span id="mkAlterTableSteps"><span class="annot"><span class="annottext">mkAlterTableSteps :: forall key writeEntity readEntity.
NamespaceName
-&gt; RelationDescription
-&gt; TableDefinition key writeEntity readEntity
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterTableSteps"><span class="hs-identifier hs-var hs-var">mkAlterTableSteps</span></a></span></span><span> </span><span id="local-6989586621679143006"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143006"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143007"><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span></span><span> </span><span id="local-6989586621679143008"><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621679143009"><span class="annot"><span class="annottext">addAlterColumnActions :: [AlterTableAction]
</span><a href="#local-6989586621679143009"><span class="hs-identifier hs-var hs-var">addAlterColumnActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>      </span><span class="annot"><span class="annottext">[[AlterTableAction]] -&gt; [AlterTableAction]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[AlterTableAction]] -&gt; [AlterTableAction])
-&gt; [[AlterTableAction]] -&gt; [AlterTableAction]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">SqlMarshaller writeEntity readEntity
-&gt; [[AlterTableAction]]
-&gt; (MarshallerField writeEntity
    -&gt; [[AlterTableAction]] -&gt; [[AlterTableAction]])
-&gt; [[AlterTableAction]]
forall writeEntity readEntity result.
SqlMarshaller writeEntity readEntity
-&gt; result
-&gt; (MarshallerField writeEntity -&gt; result -&gt; result)
-&gt; result
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#foldMarshallerFields"><span class="hs-identifier hs-var">Orville.foldMarshallerFields</span></a></span><span>
</span><span id="line-475"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnnotatedSqlMarshaller writeEntity readEntity
-&gt; SqlMarshaller writeEntity readEntity
forall writeEntity readEntity.
AnnotatedSqlMarshaller writeEntity readEntity
-&gt; SqlMarshaller writeEntity readEntity
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#unannotatedSqlMarshaller"><span class="hs-identifier hs-var">Orville.unannotatedSqlMarshaller</span></a></span><span> </span><span class="annot"><span class="annottext">(AnnotatedSqlMarshaller writeEntity readEntity
 -&gt; SqlMarshaller writeEntity readEntity)
-&gt; AnnotatedSqlMarshaller writeEntity readEntity
-&gt; SqlMarshaller writeEntity readEntity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
-&gt; AnnotatedSqlMarshaller writeEntity readEntity
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity
-&gt; AnnotatedSqlMarshaller writeEntity readEntity
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableMarshaller"><span class="hs-identifier hs-var">Orville.tableMarshaller</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-477"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReadOnlyColumnOption
-&gt; (forall nullability a.
    FieldDefinition nullability a -&gt; [AlterTableAction])
-&gt; MarshallerField writeEntity
-&gt; [[AlterTableAction]]
-&gt; [[AlterTableAction]]
forall result entity.
ReadOnlyColumnOption
-&gt; (forall nullability a. FieldDefinition nullability a -&gt; result)
-&gt; MarshallerField entity
-&gt; [result]
-&gt; [result]
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#collectFromField"><span class="hs-identifier hs-var">Orville.collectFromField</span></a></span><span> </span><span class="annot"><span class="annottext">ReadOnlyColumnOption
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#IncludeReadOnlyColumns"><span class="hs-identifier hs-var">Orville.IncludeReadOnlyColumns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelationDescription
-&gt; FieldDefinition nullability a -&gt; [AlterTableAction]
forall nullability a.
RelationDescription
-&gt; FieldDefinition nullability a -&gt; [AlterTableAction]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddAlterColumnActions"><span class="hs-identifier hs-var">mkAddAlterColumnActions</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621679143016"><span class="annot"><span class="annottext">dropColumnActions :: [AlterTableAction]
</span><a href="#local-6989586621679143016"><span class="hs-identifier hs-var hs-var">dropColumnActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-480"></span><span>      </span><span class="annot"><span class="annottext">(PgAttribute -&gt; [AlterTableAction])
-&gt; Map AttributeName PgAttribute -&gt; [AlterTableAction]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
-&gt; PgAttribute -&gt; [AlterTableAction]
forall key readEntity writeEntity.
TableDefinition key readEntity writeEntity
-&gt; PgAttribute -&gt; [AlterTableAction]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropColumnActions"><span class="hs-identifier hs-var">mkDropColumnActions</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelationDescription -&gt; Map AttributeName PgAttribute
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationAttributes"><span class="hs-identifier hs-var">PgCatalog.relationAttributes</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span>    </span><span id="local-6989586621679143019"><span class="annot"><span class="annottext">existingConstraints :: Set ConstraintMigrationKey
</span><a href="#local-6989586621679143019"><span class="hs-identifier hs-var hs-var">existingConstraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-485"></span><span>      </span><span class="annot"><span class="annottext">[ConstraintMigrationKey] -&gt; Set ConstraintMigrationKey
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">([ConstraintMigrationKey] -&gt; Set ConstraintMigrationKey)
-&gt; (RelationDescription -&gt; [ConstraintMigrationKey])
-&gt; RelationDescription
-&gt; Set ConstraintMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ConstraintDescription -&gt; Maybe ConstraintMigrationKey)
-&gt; [ConstraintDescription] -&gt; [ConstraintMigrationKey]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">Maybe.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; Maybe ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintMigrationKey"><span class="hs-identifier hs-var">pgConstraintMigrationKey</span></a></span><span>
</span><span id="line-487"></span><span>        </span><span class="annot"><span class="annottext">([ConstraintDescription] -&gt; [ConstraintMigrationKey])
-&gt; (RelationDescription -&gt; [ConstraintDescription])
-&gt; RelationDescription
-&gt; [ConstraintMigrationKey]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription -&gt; [ConstraintDescription]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationConstraints"><span class="hs-identifier hs-var">PgCatalog.relationConstraints</span></a></span><span>
</span><span id="line-488"></span><span>        </span><span class="annot"><span class="annottext">(RelationDescription -&gt; Set ConstraintMigrationKey)
-&gt; RelationDescription -&gt; Set ConstraintMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span>    </span><span id="local-6989586621679143024"><span class="annot"><span class="annottext">constraintsToKeep :: Set ConstraintMigrationKey
</span><a href="#local-6989586621679143024"><span class="hs-identifier hs-var hs-var">constraintsToKeep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-491"></span><span>      </span><span class="annot"><span class="annottext">(ConstraintMigrationKey -&gt; ConstraintMigrationKey)
-&gt; Set ConstraintMigrationKey -&gt; Set ConstraintMigrationKey
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName -&gt; ConstraintMigrationKey -&gt; ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#setDefaultSchemaNameOnConstraintKey"><span class="hs-identifier hs-var">setDefaultSchemaNameOnConstraintKey</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143006"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><span class="annottext">(Set ConstraintMigrationKey -&gt; Set ConstraintMigrationKey)
-&gt; (TableDefinition key writeEntity readEntity
    -&gt; Set ConstraintMigrationKey)
-&gt; TableDefinition key writeEntity readEntity
-&gt; Set ConstraintMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableConstraints -&gt; Set ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#tableConstraintKeys"><span class="hs-identifier hs-var">Schema.tableConstraintKeys</span></a></span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">(TableConstraints -&gt; Set ConstraintMigrationKey)
-&gt; (TableDefinition key writeEntity readEntity -&gt; TableConstraints)
-&gt; TableDefinition key writeEntity readEntity
-&gt; Set ConstraintMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableConstraints
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableConstraints
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableConstraints"><span class="hs-identifier hs-var">Orville.tableConstraints</span></a></span><span>
</span><span id="line-494"></span><span>        </span><span class="annot"><span class="annottext">(TableDefinition key writeEntity readEntity
 -&gt; Set ConstraintMigrationKey)
-&gt; TableDefinition key writeEntity readEntity
-&gt; Set ConstraintMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>    </span><span id="local-6989586621679143028"><span class="annot"><span class="annottext">addConstraintActions :: [(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143028"><span class="hs-identifier hs-var hs-var">addConstraintActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-497"></span><span>      </span><span class="annot"><span class="annottext">(ConstraintDefinition -&gt; [(StepType, AlterTableAction)])
-&gt; [ConstraintDefinition] -&gt; [(StepType, AlterTableAction)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-498"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
-&gt; Set ConstraintMigrationKey
-&gt; ConstraintDefinition
-&gt; [(StepType, AlterTableAction)]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddConstraintActions"><span class="hs-identifier hs-var">mkAddConstraintActions</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143006"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143019"><span class="hs-identifier hs-var">existingConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableConstraints -&gt; [ConstraintDefinition]
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#tableConstraintDefinitions"><span class="hs-identifier hs-var">Schema.tableConstraintDefinitions</span></a></span><span> </span><span class="annot"><span class="annottext">(TableConstraints -&gt; [ConstraintDefinition])
-&gt; TableConstraints -&gt; [ConstraintDefinition]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableConstraints
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableConstraints
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableConstraints"><span class="hs-identifier hs-var">Orville.tableConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>    </span><span id="local-6989586621679143029"><span class="annot"><span class="annottext">dropConstraintActions :: [(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143029"><span class="hs-identifier hs-var hs-var">dropConstraintActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>      </span><span class="annot"><span class="annottext">(ConstraintDescription -&gt; [(StepType, AlterTableAction)])
-&gt; [ConstraintDescription] -&gt; [(StepType, AlterTableAction)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
-&gt; ConstraintDescription -&gt; [(StepType, AlterTableAction)]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropConstraintActions"><span class="hs-identifier hs-var">mkDropConstraintActions</span></a></span><span> </span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143024"><span class="hs-identifier hs-var">constraintsToKeep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-504"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelationDescription -&gt; [ConstraintDescription]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationConstraints"><span class="hs-identifier hs-var">PgCatalog.relationConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621679143031"><span class="annot"><span class="annottext">systemIndexOids :: Set Oid
</span><a href="#local-6989586621679143031"><span class="hs-identifier hs-var hs-var">systemIndexOids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-507"></span><span>      </span><span class="annot"><span class="annottext">[Oid] -&gt; Set Oid
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-508"></span><span>        </span><span class="annot"><span class="annottext">([Oid] -&gt; Set Oid)
-&gt; (RelationDescription -&gt; [Oid]) -&gt; RelationDescription -&gt; Set Oid
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ConstraintDescription -&gt; Maybe Oid)
-&gt; [ConstraintDescription] -&gt; [Oid]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">Maybe.mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PgConstraint -&gt; Maybe Oid
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintImpliedIndexOid"><span class="hs-identifier hs-var">pgConstraintImpliedIndexOid</span></a></span><span> </span><span class="annot"><span class="annottext">(PgConstraint -&gt; Maybe Oid)
-&gt; (ConstraintDescription -&gt; PgConstraint)
-&gt; ConstraintDescription
-&gt; Maybe Oid
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; PgConstraint
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintRecord"><span class="hs-identifier hs-var">PgCatalog.constraintRecord</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>        </span><span class="annot"><span class="annottext">([ConstraintDescription] -&gt; [Oid])
-&gt; (RelationDescription -&gt; [ConstraintDescription])
-&gt; RelationDescription
-&gt; [Oid]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription -&gt; [ConstraintDescription]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationConstraints"><span class="hs-identifier hs-var">PgCatalog.relationConstraints</span></a></span><span>
</span><span id="line-510"></span><span>        </span><span class="annot"><span class="annottext">(RelationDescription -&gt; Set Oid) -&gt; RelationDescription -&gt; Set Oid
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>    </span><span id="local-6989586621679143034"><span class="annot"><span class="annottext">isSystemIndex :: IndexDescription -&gt; Bool
</span><a href="#local-6989586621679143034"><span class="hs-identifier hs-var hs-var">isSystemIndex</span></a></span></span><span> </span><span id="local-6989586621679143035"><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143035"><span class="hs-identifier hs-var">indexDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-513"></span><span>      </span><span class="annot"><span class="annottext">Oid -&gt; Set Oid -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PgIndex -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgIndex.html#pgIndexPgClassOid"><span class="hs-identifier hs-var">PgCatalog.pgIndexPgClassOid</span></a></span><span> </span><span class="annot"><span class="annottext">(PgIndex -&gt; Oid) -&gt; PgIndex -&gt; Oid
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; PgIndex
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#indexRecord"><span class="hs-identifier hs-var">PgCatalog.indexRecord</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143035"><span class="hs-identifier hs-var">indexDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>        </span><span class="annot"><span class="annottext">Set Oid
</span><a href="#local-6989586621679143031"><span class="hs-identifier hs-var">systemIndexOids</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>    </span><span id="local-6989586621679143039"><span class="annot"><span class="annottext">existingIndexes :: Set IndexMigrationKey
</span><a href="#local-6989586621679143039"><span class="hs-identifier hs-var hs-var">existingIndexes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-518"></span><span>      </span><span class="annot"><span class="annottext">[IndexMigrationKey] -&gt; Set IndexMigrationKey
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-519"></span><span>        </span><span class="annot"><span class="annottext">([IndexMigrationKey] -&gt; Set IndexMigrationKey)
-&gt; (RelationDescription -&gt; [IndexMigrationKey])
-&gt; RelationDescription
-&gt; Set IndexMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(IndexDescription -&gt; [IndexMigrationKey])
-&gt; [IndexDescription] -&gt; [IndexMigrationKey]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; [IndexMigrationKey]
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgIndexMigrationKeys"><span class="hs-identifier hs-var">pgIndexMigrationKeys</span></a></span><span>
</span><span id="line-520"></span><span>        </span><span class="annot"><span class="annottext">([IndexDescription] -&gt; [IndexMigrationKey])
-&gt; (RelationDescription -&gt; [IndexDescription])
-&gt; RelationDescription
-&gt; [IndexMigrationKey]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(IndexDescription -&gt; Bool)
-&gt; [IndexDescription] -&gt; [IndexDescription]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (IndexDescription -&gt; Bool) -&gt; IndexDescription -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; Bool
</span><a href="#local-6989586621679143034"><span class="hs-identifier hs-var">isSystemIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">([IndexDescription] -&gt; [IndexDescription])
-&gt; (RelationDescription -&gt; [IndexDescription])
-&gt; RelationDescription
-&gt; [IndexDescription]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription -&gt; [IndexDescription]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationIndexes"><span class="hs-identifier hs-var">PgCatalog.relationIndexes</span></a></span><span>
</span><span id="line-522"></span><span>        </span><span class="annot"><span class="annottext">(RelationDescription -&gt; Set IndexMigrationKey)
-&gt; RelationDescription -&gt; Set IndexMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621679143043"><span class="annot"><span class="annottext">indexesToKeep :: Set IndexMigrationKey
</span><a href="#local-6989586621679143043"><span class="hs-identifier hs-var hs-var">indexesToKeep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-525"></span><span>      </span><span class="annot"><span class="annottext">Map IndexMigrationKey IndexDefinition -&gt; Set IndexMigrationKey
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span>
</span><span id="line-526"></span><span>        </span><span class="annot"><span class="annottext">(Map IndexMigrationKey IndexDefinition -&gt; Set IndexMigrationKey)
-&gt; (TableDefinition key writeEntity readEntity
    -&gt; Map IndexMigrationKey IndexDefinition)
-&gt; TableDefinition key writeEntity readEntity
-&gt; Set IndexMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIndexes"><span class="hs-identifier hs-var">Orville.tableIndexes</span></a></span><span>
</span><span id="line-527"></span><span>        </span><span class="annot"><span class="annottext">(TableDefinition key writeEntity readEntity
 -&gt; Set IndexMigrationKey)
-&gt; TableDefinition key writeEntity readEntity
-&gt; Set IndexMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>    </span><span id="local-6989586621679143045"><span class="annot"><span class="annottext">addIndexSteps :: [MigrationStepWithType]
</span><a href="#local-6989586621679143045"><span class="hs-identifier hs-var hs-var">addIndexSteps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>      </span><span class="annot"><span class="annottext">(IndexDefinition -&gt; [MigrationStepWithType])
-&gt; Map IndexMigrationKey IndexDefinition -&gt; [MigrationStepWithType]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-531"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set IndexMigrationKey
-&gt; Qualified TableName
-&gt; IndexDefinition
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddIndexSteps"><span class="hs-identifier hs-var">mkAddIndexSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143039"><span class="hs-identifier hs-var">existingIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143046"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity
-&gt; Map IndexMigrationKey IndexDefinition
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIndexes"><span class="hs-identifier hs-var">Orville.tableIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621679143047"><span class="annot"><span class="annottext">dropIndexSteps :: [MigrationStepWithType]
</span><a href="#local-6989586621679143047"><span class="hs-identifier hs-var hs-var">dropIndexSteps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-535"></span><span>      </span><span class="annot"><span class="annottext">(IndexDescription -&gt; [MigrationStepWithType])
-&gt; [IndexDescription] -&gt; [MigrationStepWithType]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span>
</span><span id="line-536"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set IndexMigrationKey
-&gt; Set Oid -&gt; IndexDescription -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropIndexSteps"><span class="hs-identifier hs-var">mkDropIndexSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143043"><span class="hs-identifier hs-var">indexesToKeep</span></a></span><span> </span><span class="annot"><span class="annottext">Set Oid
</span><a href="#local-6989586621679143031"><span class="hs-identifier hs-var">systemIndexOids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelationDescription -&gt; [IndexDescription]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#relationIndexes"><span class="hs-identifier hs-var">PgCatalog.relationIndexes</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143007"><span class="hs-identifier hs-var">relationDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621679143046"><span class="annot"><span class="annottext">tableName :: Qualified TableName
</span><a href="#local-6989586621679143046"><span class="hs-identifier hs-var hs-var">tableName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-540"></span><span>      </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; Qualified TableName
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; Qualified TableName
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableName"><span class="hs-identifier hs-var">Orville.tableName</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143008"><span class="hs-identifier hs-var">tableDef</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><span class="annottext">Qualified TableName
-&gt; [AlterTableAction] -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterColumnSteps"><span class="hs-identifier hs-var">mkAlterColumnSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143046"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143009"><span class="hs-identifier hs-var">addAlterColumnActions</span></a></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction] -&gt; [AlterTableAction] -&gt; [AlterTableAction]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143016"><span class="hs-identifier hs-var">dropColumnActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
-&gt; [(StepType, AlterTableAction)] -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkConstraintSteps"><span class="hs-identifier hs-var">mkConstraintSteps</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143046"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143028"><span class="hs-identifier hs-var">addConstraintActions</span></a></span><span> </span><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
-&gt; [(StepType, AlterTableAction)] -&gt; [(StepType, AlterTableAction)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143029"><span class="hs-identifier hs-var">dropConstraintActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679143045"><span class="hs-identifier hs-var">addIndexSteps</span></a></span><span>
</span><span id="line-545"></span><span>      </span><span class="annot"><span class="annottext">[MigrationStepWithType]
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679143047"><span class="hs-identifier hs-var">dropIndexSteps</span></a></span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="annot"><span class="hs-comment">{- |
  Consolidates alter table actions (which should all be related to adding and
  dropping constraints) into migration steps based on their 'StepType'. Actions
  with the same 'StepType' will be performed togethir in a single @ALTER TABLE@
  statement.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-555"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkConstraintSteps"><span class="hs-identifier hs-type">mkConstraintSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-556"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.Qualified.html#Qualified"><span class="hs-identifier hs-type">Expr.Qualified</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.TableName.html#TableName"><span class="hs-identifier hs-type">Expr.TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-559"></span><span id="mkConstraintSteps"><span class="annot"><span class="annottext">mkConstraintSteps :: Qualified TableName
-&gt; [(StepType, AlterTableAction)] -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkConstraintSteps"><span class="hs-identifier hs-var hs-var">mkConstraintSteps</span></a></span></span><span> </span><span id="local-6989586621679143050"><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143050"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621679143051"><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143051"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-560"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-561"></span><span>    </span><span class="annot"><a href="#local-6989586621679143052"><span class="hs-identifier hs-type">mkMapEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-563"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>    </span><span id="local-6989586621679143052"><span class="annot"><span class="annottext">mkMapEntry :: (StepType, AlterTableAction)
-&gt; (StepType, NonEmpty AlterTableAction)
</span><a href="#local-6989586621679143052"><span class="hs-identifier hs-var hs-var">mkMapEntry</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679143053"><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143053"><span class="hs-identifier hs-var">keyType</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679143054"><span class="annot"><span class="annottext">AlterTableAction
</span><a href="#local-6989586621679143054"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-565"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143053"><span class="hs-identifier hs-var">keyType</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlterTableAction
</span><a href="#local-6989586621679143054"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">AlterTableAction -&gt; [AlterTableAction] -&gt; NonEmpty AlterTableAction
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span>    </span><span id="local-6989586621679143055"><span class="annot"><span class="annottext">addStep :: StepType
-&gt; NonEmpty AlterTableAction
-&gt; [MigrationStepWithType]
-&gt; [MigrationStepWithType]
</span><a href="#local-6989586621679143055"><span class="hs-identifier hs-var hs-var">addStep</span></a></span></span><span> </span><span id="local-6989586621679143056"><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143056"><span class="hs-identifier hs-var">stepType</span></a></span></span><span> </span><span id="local-6989586621679143057"><span class="annot"><span class="annottext">NonEmpty AlterTableAction
</span><a href="#local-6989586621679143057"><span class="hs-identifier hs-var">actionExprs</span></a></span></span><span> </span><span id="local-6989586621679143058"><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679143058"><span class="hs-identifier hs-var">steps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-568"></span><span>      </span><span class="annot"><span class="annottext">StepType -&gt; AlterTableExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143056"><span class="hs-identifier hs-var">stepType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Qualified TableName -&gt; NonEmpty AlterTableAction -&gt; AlterTableExpr
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterTableExpr"><span class="hs-identifier hs-var">Expr.alterTableExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143050"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty AlterTableAction
</span><a href="#local-6989586621679143057"><span class="hs-identifier hs-var">actionExprs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MigrationStepWithType
-&gt; [MigrationStepWithType] -&gt; [MigrationStepWithType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[MigrationStepWithType]
</span><a href="#local-6989586621679143058"><span class="hs-identifier hs-var">steps</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><span class="annottext">(StepType
 -&gt; NonEmpty AlterTableAction
 -&gt; [MigrationStepWithType]
 -&gt; [MigrationStepWithType])
-&gt; [MigrationStepWithType]
-&gt; Map StepType (NonEmpty AlterTableAction)
-&gt; [MigrationStepWithType]
forall k a b. (k -&gt; a -&gt; b -&gt; b) -&gt; b -&gt; Map k a -&gt; b
</span><span class="hs-identifier hs-var">Map.foldrWithKey</span></span><span> </span><span class="annot"><span class="annottext">StepType
-&gt; NonEmpty AlterTableAction
-&gt; [MigrationStepWithType]
-&gt; [MigrationStepWithType]
</span><a href="#local-6989586621679143055"><span class="hs-identifier hs-var">addStep</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-571"></span><span>      </span><span class="annot"><span class="annottext">(Map StepType (NonEmpty AlterTableAction)
 -&gt; [MigrationStepWithType])
-&gt; ([(StepType, AlterTableAction)]
    -&gt; Map StepType (NonEmpty AlterTableAction))
-&gt; [(StepType, AlterTableAction)]
-&gt; [MigrationStepWithType]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty AlterTableAction
 -&gt; NonEmpty AlterTableAction -&gt; NonEmpty AlterTableAction)
-&gt; [(StepType, NonEmpty AlterTableAction)]
-&gt; Map StepType (NonEmpty AlterTableAction)
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromListWith</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty AlterTableAction
-&gt; NonEmpty AlterTableAction -&gt; NonEmpty AlterTableAction
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span>
</span><span id="line-572"></span><span>      </span><span class="annot"><span class="annottext">([(StepType, NonEmpty AlterTableAction)]
 -&gt; Map StepType (NonEmpty AlterTableAction))
-&gt; ([(StepType, AlterTableAction)]
    -&gt; [(StepType, NonEmpty AlterTableAction)])
-&gt; [(StepType, AlterTableAction)]
-&gt; Map StepType (NonEmpty AlterTableAction)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((StepType, AlterTableAction)
 -&gt; (StepType, NonEmpty AlterTableAction))
-&gt; [(StepType, AlterTableAction)]
-&gt; [(StepType, NonEmpty AlterTableAction)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(StepType, AlterTableAction)
-&gt; (StepType, NonEmpty AlterTableAction)
</span><a href="#local-6989586621679143052"><span class="hs-identifier hs-var">mkMapEntry</span></a></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">([(StepType, AlterTableAction)] -&gt; [MigrationStepWithType])
-&gt; [(StepType, AlterTableAction)] -&gt; [MigrationStepWithType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(StepType, AlterTableAction)]
</span><a href="#local-6989586621679143051"><span class="hs-identifier hs-var">actions</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span class="annot"><span class="hs-comment">{- |
  If there are any alter table actions for adding or removing columns, creates a migration
  step to perform them. Otherwise returns an empty list.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-581"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterColumnSteps"><span class="hs-identifier hs-type">mkAlterColumnSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-582"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.Qualified.html#Qualified"><span class="hs-identifier hs-type">Expr.Qualified</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.TableName.html#TableName"><span class="hs-identifier hs-type">Expr.TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-585"></span><span id="mkAlterColumnSteps"><span class="annot"><span class="annottext">mkAlterColumnSteps :: Qualified TableName
-&gt; [AlterTableAction] -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterColumnSteps"><span class="hs-identifier hs-var hs-var">mkAlterColumnSteps</span></a></span></span><span> </span><span id="local-6989586621679143062"><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143062"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621679143063"><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143063"><span class="hs-identifier hs-var">actionExprs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[AlterTableAction] -&gt; Maybe (NonEmpty AlterTableAction)
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><span class="hs-identifier hs-var">nonEmpty</span></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143063"><span class="hs-identifier hs-var">actionExprs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-587"></span><span>    </span><span class="annot"><span class="annottext">Maybe (NonEmpty AlterTableAction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-588"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143064"><span class="annot"><span class="annottext">NonEmpty AlterTableAction
</span><a href="#local-6989586621679143064"><span class="hs-identifier hs-var">nonEmptyActionExprs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-590"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StepType -&gt; AlterTableExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Qualified TableName -&gt; NonEmpty AlterTableAction -&gt; AlterTableExpr
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterTableExpr"><span class="hs-identifier hs-var">Expr.alterTableExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143062"><span class="hs-identifier hs-var">tableName</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty AlterTableAction
</span><a href="#local-6989586621679143064"><span class="hs-identifier hs-var">nonEmptyActionExprs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-591"></span><span>
</span><span id="line-592"></span><span class="annot"><span class="hs-comment">{- |
  Builds 'Expr.AlterTableAction' expressions to bring the database schema in
  line with the given 'Orville.FieldDefinition', or none if no change is
  required.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-599"></span><span id="local-6989586621679142530"><span id="local-6989586621679142531"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAddAlterColumnActions"><span class="hs-identifier hs-type">mkAddAlterColumnActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-600"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#RelationDescription"><span class="hs-identifier hs-type">PgCatalog.RelationDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-601"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#FieldDefinition"><span class="hs-identifier hs-type">Orville.FieldDefinition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142530"><span class="hs-identifier hs-type">nullability</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142531"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-603"></span><span id="mkAddAlterColumnActions"><span class="annot"><span class="annottext">mkAddAlterColumnActions :: forall nullability a.
RelationDescription
-&gt; FieldDefinition nullability a -&gt; [AlterTableAction]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddAlterColumnActions"><span class="hs-identifier hs-var hs-var">mkAddAlterColumnActions</span></a></span></span><span> </span><span id="local-6989586621679143090"><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143090"><span class="hs-identifier hs-var">relationDesc</span></a></span></span><span> </span><span id="local-6989586621679143091"><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-605"></span><span>    </span><span id="local-6989586621679143092"><span class="annot"><span class="annottext">pgAttributeName :: AttributeName
</span><a href="#local-6989586621679143092"><span class="hs-identifier hs-var hs-var">pgAttributeName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-606"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; AttributeName
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">String.fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldName -&gt; String
</span><a href="Orville.PostgreSQL.Internal.FieldName.html#fieldNameToString"><span class="hs-identifier hs-var">Orville.fieldNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">(FieldName -&gt; String) -&gt; FieldName -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; FieldName
forall nullability a. FieldDefinition nullability a -&gt; FieldName
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldName"><span class="hs-identifier hs-var">Orville.fieldName</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AttributeName -&gt; RelationDescription -&gt; Maybe PgAttribute
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupAttribute"><span class="hs-identifier hs-var">PgCatalog.lookupAttribute</span></a></span><span> </span><span class="annot"><span class="annottext">AttributeName
</span><a href="#local-6989586621679143092"><span class="hs-identifier hs-var">pgAttributeName</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143090"><span class="hs-identifier hs-var">relationDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-609"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143096"><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span></span><span>
</span><span id="line-610"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; Bool
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#isOrdinaryColumn"><span class="hs-identifier hs-var">PgCatalog.isOrdinaryColumn</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-611"></span><span>            </span><span class="hs-keyword">let</span><span>
</span><span id="line-612"></span><span>              </span><span id="local-6989586621679143098"><span class="annot"><span class="annottext">sqlType :: SqlType a
</span><a href="#local-6989586621679143098"><span class="hs-identifier hs-var hs-var">sqlType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-613"></span><span>                </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; SqlType a
forall nullability a. FieldDefinition nullability a -&gt; SqlType a
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldType"><span class="hs-identifier hs-var">Orville.fieldType</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>              </span><span id="local-6989586621679143100"><span class="annot"><span class="annottext">typeIsChanged :: Bool
</span><a href="#local-6989586621679143100"><span class="hs-identifier hs-var hs-var">typeIsChanged</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-616"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SqlType a -&gt; Oid
forall a. SqlType a -&gt; Oid
</span><a href="Orville.PostgreSQL.Marshall.SqlType.html#sqlTypeOid"><span class="hs-identifier hs-var">Orville.sqlTypeOid</span></a></span><span> </span><span class="annot"><span class="annottext">SqlType a
</span><a href="#local-6989586621679143098"><span class="hs-identifier hs-var">sqlType</span></a></span><span> </span><span class="annot"><span class="annottext">Oid -&gt; Oid -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeTypeOid"><span class="hs-identifier hs-var">PgCatalog.pgAttributeTypeOid</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>                  </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SqlType a -&gt; Maybe Int32
forall a. SqlType a -&gt; Maybe Int32
</span><a href="Orville.PostgreSQL.Marshall.SqlType.html#sqlTypeMaximumLength"><span class="hs-identifier hs-var">Orville.sqlTypeMaximumLength</span></a></span><span> </span><span class="annot"><span class="annottext">SqlType a
</span><a href="#local-6989586621679143098"><span class="hs-identifier hs-var">sqlType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int32 -&gt; Maybe Int32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; Maybe Int32
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeMaxLength"><span class="hs-identifier hs-var">PgCatalog.pgAttributeMaxLength</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span>              </span><span id="local-6989586621679143107"><span class="annot"><span class="annottext">columnName :: ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var hs-var">columnName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-620"></span><span>                </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; ColumnName
forall nullability a. FieldDefinition nullability a -&gt; ColumnName
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldColumnName"><span class="hs-identifier hs-var">Orville.fieldColumnName</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span>              </span><span id="local-6989586621679143109"><span class="annot"><span class="annottext">dataType :: DataType
</span><a href="#local-6989586621679143109"><span class="hs-identifier hs-var hs-var">dataType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>                </span><span class="annot"><span class="annottext">SqlType a -&gt; DataType
forall a. SqlType a -&gt; DataType
</span><a href="Orville.PostgreSQL.Marshall.SqlType.html#sqlTypeExpr"><span class="hs-identifier hs-var">Orville.sqlTypeExpr</span></a></span><span> </span><span class="annot"><span class="annottext">SqlType a
</span><a href="#local-6989586621679143098"><span class="hs-identifier hs-var">sqlType</span></a></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span>              </span><span id="local-6989586621679143111"><span class="annot"><span class="annottext">alterType :: [AlterTableAction]
</span><a href="#local-6989586621679143111"><span class="hs-identifier hs-var hs-var">alterType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-626"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143100"><span class="hs-identifier hs-var">typeIsChanged</span></a></span><span>
</span><span id="line-627"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ColumnName -&gt; DataType -&gt; Maybe UsingClause -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnType"><span class="hs-identifier hs-var">Expr.alterColumnType</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span> </span><span class="annot"><span class="annottext">DataType
</span><a href="#local-6989586621679143109"><span class="hs-identifier hs-var">dataType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsingClause -&gt; Maybe UsingClause
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(UsingClause -&gt; Maybe UsingClause)
-&gt; UsingClause -&gt; Maybe UsingClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ColumnName -&gt; DataType -&gt; UsingClause
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#usingCast"><span class="hs-identifier hs-var">Expr.usingCast</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span> </span><span class="annot"><span class="annottext">DataType
</span><a href="#local-6989586621679143109"><span class="hs-identifier hs-var">dataType</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-628"></span><span>
</span><span id="line-629"></span><span>              </span><span id="local-6989586621679143114"><span class="annot"><span class="annottext">nullabilityIsChanged :: Bool
</span><a href="#local-6989586621679143114"><span class="hs-identifier hs-var hs-var">nullabilityIsChanged</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-630"></span><span>                </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; Bool
forall nullability a. FieldDefinition nullability a -&gt; Bool
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldIsNotNullable"><span class="hs-identifier hs-var">Orville.fieldIsNotNullable</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; Bool
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeIsNotNull"><span class="hs-identifier hs-var">PgCatalog.pgAttributeIsNotNull</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span><span>
</span><span id="line-631"></span><span>
</span><span id="line-632"></span><span>              </span><span id="local-6989586621679143117"><span class="annot"><span class="annottext">nullabilityAction :: AlterNotNull
</span><a href="#local-6989586621679143117"><span class="hs-identifier hs-var hs-var">nullabilityAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-633"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; Bool
forall nullability a. FieldDefinition nullability a -&gt; Bool
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldIsNotNullable"><span class="hs-identifier hs-var">Orville.fieldIsNotNullable</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span>
</span><span id="line-634"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">AlterNotNull
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#setNotNull"><span class="hs-identifier hs-var">Expr.setNotNull</span></a></span><span>
</span><span id="line-635"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">AlterNotNull
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#dropNotNull"><span class="hs-identifier hs-var">Expr.dropNotNull</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span>              </span><span id="local-6989586621679143120"><span class="annot"><span class="annottext">alterNullability :: [AlterTableAction]
</span><a href="#local-6989586621679143120"><span class="hs-identifier hs-var hs-var">alterNullability</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-638"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143114"><span class="hs-identifier hs-var">nullabilityIsChanged</span></a></span><span>
</span><span id="line-639"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ColumnName -&gt; AlterNotNull -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnNullability"><span class="hs-identifier hs-var">Expr.alterColumnNullability</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; ColumnName
forall nullability a. FieldDefinition nullability a -&gt; ColumnName
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldColumnName"><span class="hs-identifier hs-var">Orville.fieldColumnName</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlterNotNull
</span><a href="#local-6989586621679143117"><span class="hs-identifier hs-var">nullabilityAction</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span>              </span><span id="local-6989586621679143122"><span class="annot"><span class="annottext">maybeExistingDefault :: Maybe PgAttributeDefault
</span><a href="#local-6989586621679143122"><span class="hs-identifier hs-var hs-var">maybeExistingDefault</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-642"></span><span>                </span><span class="annot"><span class="annottext">PgAttribute -&gt; RelationDescription -&gt; Maybe PgAttributeDefault
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#lookupAttributeDefault"><span class="hs-identifier hs-var">PgCatalog.lookupAttributeDefault</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143096"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="annot"><span class="annottext">RelationDescription
</span><a href="#local-6989586621679143090"><span class="hs-identifier hs-var">relationDesc</span></a></span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>              </span><span id="local-6989586621679143124"><span class="annot"><span class="annottext">maybeDefaultExpr :: Maybe ValueExpression
</span><a href="#local-6989586621679143124"><span class="hs-identifier hs-var hs-var">maybeDefaultExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-645"></span><span>                </span><span class="annot"><span class="annottext">DefaultValue a -&gt; ValueExpression
forall a. DefaultValue a -&gt; ValueExpression
</span><a href="Orville.PostgreSQL.Marshall.DefaultValue.html#defaultValueExpression"><span class="hs-identifier hs-var">Orville.defaultValueExpression</span></a></span><span>
</span><span id="line-646"></span><span>                  </span><span class="annot"><span class="annottext">(DefaultValue a -&gt; ValueExpression)
-&gt; Maybe (DefaultValue a) -&gt; Maybe ValueExpression
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; Maybe (DefaultValue a)
forall nullability a.
FieldDefinition nullability a -&gt; Maybe (DefaultValue a)
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldDefaultValue"><span class="hs-identifier hs-var">Orville.fieldDefaultValue</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679143128"><span class="annot"><span class="annottext">Maybe AlterTableAction
</span><a href="#local-6989586621679143128"><span class="hs-identifier hs-var">dropDefault</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679143129"><span class="annot"><span class="annottext">Maybe AlterTableAction
</span><a href="#local-6989586621679143129"><span class="hs-identifier hs-var">setDefault</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-649"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe PgAttributeDefault
</span><a href="#local-6989586621679143122"><span class="hs-identifier hs-var">maybeExistingDefault</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ValueExpression
</span><a href="#local-6989586621679143124"><span class="hs-identifier hs-var">maybeDefaultExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-650"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe PgAttributeDefault
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ValueExpression
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-651"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">PgAttributeDefault
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ValueExpression
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-653"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SqlType a -&gt; Bool
forall a. SqlType a -&gt; Bool
</span><a href="Orville.PostgreSQL.Marshall.SqlType.html#sqlTypeDontDropImplicitDefaultDuringMigrate"><span class="hs-identifier hs-var">Orville.sqlTypeDontDropImplicitDefaultDuringMigrate</span></a></span><span> </span><span class="annot"><span class="annottext">SqlType a
</span><a href="#local-6989586621679143098"><span class="hs-identifier hs-var">sqlType</span></a></span><span>
</span><span id="line-654"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>                      </span><span class="hs-keyword">else</span><span>
</span><span id="line-656"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AlterTableAction -&gt; Maybe AlterTableAction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnName -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnDropDefault"><span class="hs-identifier hs-var">Expr.alterColumnDropDefault</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-658"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe PgAttributeDefault
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143132"><span class="annot"><span class="annottext">ValueExpression
</span><a href="#local-6989586621679143132"><span class="hs-identifier hs-var">newDefault</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-660"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-661"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlterTableAction -&gt; Maybe AlterTableAction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnName -&gt; ValueExpression -&gt; AlterTableAction
forall valueExpression.
SqlExpression valueExpression =&gt;
ColumnName -&gt; valueExpression -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnSetDefault"><span class="hs-identifier hs-var">Expr.alterColumnSetDefault</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span> </span><span class="annot"><span class="annottext">ValueExpression
</span><a href="#local-6989586621679143132"><span class="hs-identifier hs-var">newDefault</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-663"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143134"><span class="annot"><span class="annottext">PgAttributeDefault
</span><a href="#local-6989586621679143134"><span class="hs-identifier hs-var">oldDefault</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143135"><span class="annot"><span class="annottext">ValueExpression
</span><a href="#local-6989586621679143135"><span class="hs-identifier hs-var">newDefault</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-664"></span><span>                    </span><span class="hs-keyword">let</span><span>
</span><span id="line-665"></span><span>                      </span><span id="local-6989586621679143136"><span class="annot"><span class="annottext">oldDefaultExprBytes :: ByteString
</span><a href="#local-6989586621679143136"><span class="hs-identifier hs-var hs-var">oldDefaultExprBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-666"></span><span>                        </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">Enc.encodeUtf8</span></span><span>
</span><span id="line-667"></span><span>                          </span><span class="annot"><span class="annottext">(Text -&gt; ByteString)
-&gt; (PgAttributeDefault -&gt; Text) -&gt; PgAttributeDefault -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgAttributeDefault -&gt; Text
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttributeDefault.html#pgAttributeDefaultExpression"><span class="hs-identifier hs-var">PgCatalog.pgAttributeDefaultExpression</span></a></span><span>
</span><span id="line-668"></span><span>                          </span><span class="annot"><span class="annottext">(PgAttributeDefault -&gt; ByteString)
-&gt; PgAttributeDefault -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgAttributeDefault
</span><a href="#local-6989586621679143134"><span class="hs-identifier hs-var">oldDefault</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span>                      </span><span id="local-6989586621679143139"><span class="annot"><span class="annottext">newDefaultExprBytes :: ByteString
</span><a href="#local-6989586621679143139"><span class="hs-identifier hs-var hs-var">newDefaultExprBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-671"></span><span>                        </span><span class="annot"><span class="annottext">ValueExpression -&gt; ByteString
forall sql. SqlExpression sql =&gt; sql -&gt; ByteString
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#toExampleBytes"><span class="hs-identifier hs-var">RawSql.toExampleBytes</span></a></span><span> </span><span class="annot"><span class="annottext">ValueExpression
</span><a href="#local-6989586621679143135"><span class="hs-identifier hs-var">newDefault</span></a></span><span>
</span><span id="line-672"></span><span>                    </span><span class="hs-keyword">in</span><span>
</span><span id="line-673"></span><span>                      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679143136"><span class="hs-identifier hs-var">oldDefaultExprBytes</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679143139"><span class="hs-identifier hs-var">newDefaultExprBytes</span></a></span><span>
</span><span id="line-674"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>                        </span><span class="hs-keyword">else</span><span>
</span><span id="line-676"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AlterTableAction -&gt; Maybe AlterTableAction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnName -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnDropDefault"><span class="hs-identifier hs-var">Expr.alterColumnDropDefault</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlterTableAction -&gt; Maybe AlterTableAction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ColumnName -&gt; ValueExpression -&gt; AlterTableAction
forall valueExpression.
SqlExpression valueExpression =&gt;
ColumnName -&gt; valueExpression -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#alterColumnSetDefault"><span class="hs-identifier hs-var">Expr.alterColumnSetDefault</span></a></span><span> </span><span class="annot"><span class="annottext">ColumnName
</span><a href="#local-6989586621679143107"><span class="hs-identifier hs-var">columnName</span></a></span><span> </span><span class="annot"><span class="annottext">ValueExpression
</span><a href="#local-6989586621679143135"><span class="hs-identifier hs-var">newDefault</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>            </span><span class="hs-keyword">in</span><span>
</span><span id="line-680"></span><span>              </span><span class="annot"><span class="annottext">Maybe AlterTableAction -&gt; [AlterTableAction]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">Maybe.maybeToList</span></span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
</span><a href="#local-6989586621679143128"><span class="hs-identifier hs-var">dropDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction] -&gt; [AlterTableAction] -&gt; [AlterTableAction]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143111"><span class="hs-identifier hs-var">alterType</span></a></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction] -&gt; [AlterTableAction] -&gt; [AlterTableAction]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction -&gt; [AlterTableAction]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">Maybe.maybeToList</span></span><span> </span><span class="annot"><span class="annottext">Maybe AlterTableAction
</span><a href="#local-6989586621679143129"><span class="hs-identifier hs-var">setDefault</span></a></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction] -&gt; [AlterTableAction] -&gt; [AlterTableAction]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[AlterTableAction]
</span><a href="#local-6989586621679143120"><span class="hs-identifier hs-var">alterNullability</span></a></span><span>
</span><span id="line-681"></span><span>      </span><span class="annot"><span class="annottext">Maybe PgAttribute
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-682"></span><span>        </span><span class="hs-comment">-- Either the column doesn't exist in the table _OR_ it's a system</span><span>
</span><span id="line-683"></span><span>        </span><span class="hs-comment">-- column. If it's a system column, attempting to add it will result</span><span>
</span><span id="line-684"></span><span>        </span><span class="hs-comment">-- in an error that will be reported to the user. We could explicitly</span><span>
</span><span id="line-685"></span><span>        </span><span class="hs-comment">-- return an error from this function, but that would make the error</span><span>
</span><span id="line-686"></span><span>        </span><span class="hs-comment">-- reporting inconsistent with the handling in create table, where we</span><span>
</span><span id="line-687"></span><span>        </span><span class="hs-comment">-- must rely on the database to raise the error because the table</span><span>
</span><span id="line-688"></span><span>        </span><span class="hs-comment">-- does not yet exist for us to discover a conflict with system</span><span>
</span><span id="line-689"></span><span>        </span><span class="hs-comment">-- attributes.</span><span>
</span><span id="line-690"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ColumnDefinition -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#addColumn"><span class="hs-identifier hs-var">Expr.addColumn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldDefinition nullability a -&gt; ColumnDefinition
forall nullability a.
FieldDefinition nullability a -&gt; ColumnDefinition
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldColumnDefinition"><span class="hs-identifier hs-var">Orville.fieldColumnDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition nullability a
</span><a href="#local-6989586621679143091"><span class="hs-identifier hs-var">fieldDef</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span class="annot"><span class="hs-comment">{- |
  Builds 'Expr.AlterTableAction' expressions for the given attribute to make
  the database schema match the given 'Orville.TableDefinition'. This function
  is only responsible for handling cases where the attribute does not have a
  correspending 'Orville.FieldDefinition'. See 'mkFieldActions' for those
  cases.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-701"></span><span id="local-6989586621679142533"><span id="local-6989586621679142534"><span id="local-6989586621679142535"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkDropColumnActions"><span class="hs-identifier hs-type">mkDropColumnActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-702"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableDefinition.html#TableDefinition"><span class="hs-identifier hs-type">Orville.TableDefinition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142533"><span class="hs-identifier hs-type">key</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142534"><span class="hs-identifier hs-type">readEntity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142535"><span class="hs-identifier hs-type">writeEntity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-703"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#PgAttribute"><span class="hs-identifier hs-type">PgCatalog.PgAttribute</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-705"></span><span id="mkDropColumnActions"><span class="annot"><span class="annottext">mkDropColumnActions :: forall key readEntity writeEntity.
TableDefinition key readEntity writeEntity
-&gt; PgAttribute -&gt; [AlterTableAction]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropColumnActions"><span class="hs-identifier hs-var hs-var">mkDropColumnActions</span></a></span></span><span> </span><span id="local-6989586621679143150"><span class="annot"><span class="annottext">TableDefinition key readEntity writeEntity
</span><a href="#local-6989586621679143150"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span id="local-6989586621679143151"><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143151"><span class="hs-identifier hs-var">attr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-707"></span><span>    </span><span id="local-6989586621679143152"><span class="annot"><span class="annottext">attrName :: String
</span><a href="#local-6989586621679143152"><span class="hs-identifier hs-var hs-var">attrName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-708"></span><span>      </span><span class="annot"><span class="annottext">AttributeName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#attributeNameToString"><span class="hs-identifier hs-var">PgCatalog.attributeNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">(AttributeName -&gt; String) -&gt; AttributeName -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; AttributeName
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeName"><span class="hs-identifier hs-var">PgCatalog.pgAttributeName</span></a></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143151"><span class="hs-identifier hs-var">attr</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; [()]
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; [()]) -&gt; Bool -&gt; [()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Set String -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679143152"><span class="hs-identifier hs-var">attrName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key readEntity writeEntity -&gt; Set String
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; Set String
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#columnsToDrop"><span class="hs-identifier hs-var">Orville.columnsToDrop</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key readEntity writeEntity
</span><a href="#local-6989586621679143150"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ColumnName -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#dropColumn"><span class="hs-identifier hs-var">Expr.dropColumn</span></a></span><span> </span><span class="annot"><span class="annottext">(ColumnName -&gt; AlterTableAction) -&gt; ColumnName -&gt; AlterTableAction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ColumnName
</span><a href="Orville.PostgreSQL.Expr.Internal.Name.ColumnName.html#columnName"><span class="hs-identifier hs-var">Expr.columnName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679143152"><span class="hs-identifier hs-var">attrName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span class="annot"><span class="hs-comment">{- |
  Sets the schema name on a constraint to the given namespace when the
  constraint has no namespace explicitly given. This is important for Orville
  to discover whether a constraint from a table definition matches a constraint
  found to already exist in the database because constraints in the database
  always have schema names included with them.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-723"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#setDefaultSchemaNameOnConstraintKey"><span class="hs-identifier hs-type">setDefaultSchemaNameOnConstraintKey</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-724"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-725"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-726"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span>
</span><span id="line-727"></span><span id="setDefaultSchemaNameOnConstraintKey"><span class="annot"><span class="annottext">setDefaultSchemaNameOnConstraintKey :: NamespaceName -&gt; ConstraintMigrationKey -&gt; ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#setDefaultSchemaNameOnConstraintKey"><span class="hs-identifier hs-var hs-var">setDefaultSchemaNameOnConstraintKey</span></a></span></span><span> </span><span id="local-6989586621679143158"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143158"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143159"><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143159"><span class="hs-identifier hs-var">constraintKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-728"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; Maybe TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignTable"><span class="hs-identifier hs-var">Orville.constraintKeyForeignTable</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143159"><span class="hs-identifier hs-var">constraintKey</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-729"></span><span>    </span><span class="annot"><span class="annottext">Maybe TableIdentifier
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-730"></span><span>      </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143159"><span class="hs-identifier hs-var">constraintKey</span></a></span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143161"><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143161"><span class="hs-identifier hs-var">foreignTable</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-732"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TableIdentifier -&gt; Maybe String
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdSchemaNameString"><span class="hs-identifier hs-var">Orville.tableIdSchemaNameString</span></a></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143161"><span class="hs-identifier hs-var">foreignTable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-733"></span><span>        </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-734"></span><span>          </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143159"><span class="hs-identifier hs-var">constraintKey</span></a></span><span>
</span><span id="line-735"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">constraintKeyForeignTable :: Maybe TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignTable"><span class="hs-identifier hs-var">Orville.constraintKeyForeignTable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-736"></span><span>                </span><span class="annot"><span class="annottext">TableIdentifier -&gt; Maybe TableIdentifier
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TableIdentifier -&gt; Maybe TableIdentifier)
-&gt; TableIdentifier -&gt; Maybe TableIdentifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-737"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; TableIdentifier -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#setTableIdSchema"><span class="hs-identifier hs-var">Orville.setTableIdSchema</span></a></span><span>
</span><span id="line-738"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#namespaceNameToString"><span class="hs-identifier hs-var">PgCatalog.namespaceNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143158"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>                    </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143161"><span class="hs-identifier hs-var">foreignTable</span></a></span><span>
</span><span id="line-740"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-741"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-742"></span><span>          </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143159"><span class="hs-identifier hs-var">constraintKey</span></a></span><span>
</span><span id="line-743"></span><span>
</span><span id="line-744"></span><span class="annot"><span class="hs-comment">{- |
  Builds 'Expr.AlterTableAction' expressions to create the given table
  constraint if it does not exist.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-750"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAddConstraintActions"><span class="hs-identifier hs-type">mkAddConstraintActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-752"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-753"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintDefinition"><span class="hs-identifier hs-type">Orville.ConstraintDefinition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-755"></span><span id="mkAddConstraintActions"><span class="annot"><span class="annottext">mkAddConstraintActions :: NamespaceName
-&gt; Set ConstraintMigrationKey
-&gt; ConstraintDefinition
-&gt; [(StepType, AlterTableAction)]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddConstraintActions"><span class="hs-identifier hs-var hs-var">mkAddConstraintActions</span></a></span></span><span> </span><span id="local-6989586621679143164"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143164"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143165"><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143165"><span class="hs-identifier hs-var">existingConstraints</span></a></span></span><span> </span><span id="local-6989586621679143166"><span class="annot"><span class="annottext">ConstraintDefinition
</span><a href="#local-6989586621679143166"><span class="hs-identifier hs-var">constraintDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-757"></span><span>    </span><span id="local-6989586621679143167"><span class="annot"><span class="annottext">constraintKey :: ConstraintMigrationKey
</span><a href="#local-6989586621679143167"><span class="hs-identifier hs-var hs-var">constraintKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-758"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName -&gt; ConstraintMigrationKey -&gt; ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#setDefaultSchemaNameOnConstraintKey"><span class="hs-identifier hs-var">setDefaultSchemaNameOnConstraintKey</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143164"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">(ConstraintMigrationKey -&gt; ConstraintMigrationKey)
-&gt; ConstraintMigrationKey -&gt; ConstraintMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-759"></span><span>        </span><span class="annot"><span class="annottext">ConstraintDefinition -&gt; ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintMigrationKey"><span class="hs-identifier hs-var">Orville.constraintMigrationKey</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDefinition
</span><a href="#local-6989586621679143166"><span class="hs-identifier hs-var">constraintDef</span></a></span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>    </span><span id="local-6989586621679143169"><span class="annot"><span class="annottext">stepType :: StepType
</span><a href="#local-6989586621679143169"><span class="hs-identifier hs-var hs-var">stepType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-762"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyType"><span class="hs-identifier hs-var">Orville.constraintKeyType</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143167"><span class="hs-identifier hs-var">constraintKey</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#UniqueConstraint"><span class="hs-identifier hs-var">Orville.UniqueConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddUniqueConstraints"><span class="hs-identifier hs-var">AddUniqueConstraints</span></a></span><span>
</span><span id="line-764"></span><span>        </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ForeignKeyConstraint"><span class="hs-identifier hs-var">Orville.ForeignKeyConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddForeignKeys"><span class="hs-identifier hs-var">AddForeignKeys</span></a></span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; Set ConstraintMigrationKey -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143167"><span class="hs-identifier hs-var">constraintKey</span></a></span><span> </span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143165"><span class="hs-identifier hs-var">existingConstraints</span></a></span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143169"><span class="hs-identifier hs-var">stepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TableConstraint -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#addConstraint"><span class="hs-identifier hs-var">Expr.addConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstraintDefinition -&gt; TableConstraint
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintSqlExpr"><span class="hs-identifier hs-var">Orville.constraintSqlExpr</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDefinition
</span><a href="#local-6989586621679143166"><span class="hs-identifier hs-var">constraintDef</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-769"></span><span>
</span><span id="line-770"></span><span class="annot"><span class="hs-comment">{- |
  Builds 'Expr.AlterTableAction' expressions to drop the given table
  constraint if it should not exist.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-776"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkDropConstraintActions"><span class="hs-identifier hs-type">mkDropConstraintActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-777"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-778"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#ConstraintDescription"><span class="hs-identifier hs-type">PgCatalog.ConstraintDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-779"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#StepType"><span class="hs-identifier hs-type">StepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.TableDefinition.html#AlterTableAction"><span class="hs-identifier hs-type">Expr.AlterTableAction</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-780"></span><span id="mkDropConstraintActions"><span class="annot"><span class="annottext">mkDropConstraintActions :: Set ConstraintMigrationKey
-&gt; ConstraintDescription -&gt; [(StepType, AlterTableAction)]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropConstraintActions"><span class="hs-identifier hs-var hs-var">mkDropConstraintActions</span></a></span></span><span> </span><span id="local-6989586621679143175"><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143175"><span class="hs-identifier hs-var">constraintsToKeep</span></a></span></span><span> </span><span id="local-6989586621679143176"><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143176"><span class="hs-identifier hs-var">constraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; Maybe ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintMigrationKey"><span class="hs-identifier hs-var">pgConstraintMigrationKey</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143176"><span class="hs-identifier hs-var">constraint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-782"></span><span>    </span><span class="annot"><span class="annottext">Maybe ConstraintMigrationKey
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-783"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143177"><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143177"><span class="hs-identifier hs-var">constraintKey</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-785"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; Set ConstraintMigrationKey -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143177"><span class="hs-identifier hs-var">constraintKey</span></a></span><span> </span><span class="annot"><span class="annottext">Set ConstraintMigrationKey
</span><a href="#local-6989586621679143175"><span class="hs-identifier hs-var">constraintsToKeep</span></a></span><span>
</span><span id="line-786"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-787"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-788"></span><span>          </span><span class="hs-keyword">let</span><span>
</span><span id="line-789"></span><span>            </span><span id="local-6989586621679143178"><span class="annot"><span class="annottext">constraintName :: ConstraintName
</span><a href="#local-6989586621679143178"><span class="hs-identifier hs-var hs-var">constraintName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-790"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; ConstraintName
</span><a href="Orville.PostgreSQL.Expr.Internal.Name.ConstraintName.html#constraintName"><span class="hs-identifier hs-var">Expr.constraintName</span></a></span><span>
</span><span id="line-791"></span><span>                </span><span class="annot"><span class="annottext">(String -&gt; ConstraintName)
-&gt; (ConstraintDescription -&gt; String)
-&gt; ConstraintDescription
-&gt; ConstraintName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstraintName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#constraintNameToString"><span class="hs-identifier hs-var">PgCatalog.constraintNameToString</span></a></span><span>
</span><span id="line-792"></span><span>                </span><span class="annot"><span class="annottext">(ConstraintName -&gt; String)
-&gt; (ConstraintDescription -&gt; ConstraintName)
-&gt; ConstraintDescription
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgConstraint -&gt; ConstraintName
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintName"><span class="hs-identifier hs-var">PgCatalog.pgConstraintName</span></a></span><span>
</span><span id="line-793"></span><span>                </span><span class="annot"><span class="annottext">(PgConstraint -&gt; ConstraintName)
-&gt; (ConstraintDescription -&gt; PgConstraint)
-&gt; ConstraintDescription
-&gt; ConstraintName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; PgConstraint
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintRecord"><span class="hs-identifier hs-var">PgCatalog.constraintRecord</span></a></span><span>
</span><span id="line-794"></span><span>                </span><span class="annot"><span class="annottext">(ConstraintDescription -&gt; ConstraintName)
-&gt; ConstraintDescription -&gt; ConstraintName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143176"><span class="hs-identifier hs-var">constraint</span></a></span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>            </span><span id="local-6989586621679143182"><span class="annot"><span class="annottext">stepType :: StepType
</span><a href="#local-6989586621679143182"><span class="hs-identifier hs-var hs-var">stepType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-797"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyType"><span class="hs-identifier hs-var">Orville.constraintKeyType</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintMigrationKey
</span><a href="#local-6989586621679143177"><span class="hs-identifier hs-var">constraintKey</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-798"></span><span>                </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#UniqueConstraint"><span class="hs-identifier hs-var">Orville.UniqueConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropUniqueConstraints"><span class="hs-identifier hs-var">DropUniqueConstraints</span></a></span><span>
</span><span id="line-799"></span><span>                </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ForeignKeyConstraint"><span class="hs-identifier hs-var">Orville.ForeignKeyConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropForeignKeys"><span class="hs-identifier hs-var">DropForeignKeys</span></a></span><span>
</span><span id="line-800"></span><span>          </span><span class="hs-keyword">in</span><span>
</span><span id="line-801"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143182"><span class="hs-identifier hs-var">stepType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConstraintName -&gt; AlterTableAction
</span><a href="Orville.PostgreSQL.Expr.TableDefinition.html#dropConstraint"><span class="hs-identifier hs-var">Expr.dropConstraint</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintName
</span><a href="#local-6989586621679143178"><span class="hs-identifier hs-var">constraintName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span class="annot"><span class="hs-comment">{- |
  Builds the orville migration key for a description of an existing constraint
  so that it can be compared with constraints found in a table definition.
  Constraint keys built this way always have a schema name populated, so it's
  important to set the schema names for the constraints found in the table
  definition before comparing them. See 'setDefaultSchemaNameOnConstraintKey'.

  If the description is for a kind of constraint that Orville does not support,
  'Nothing' is returned.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-815"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintMigrationKey"><span class="hs-identifier hs-type">pgConstraintMigrationKey</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-816"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#ConstraintDescription"><span class="hs-identifier hs-type">PgCatalog.ConstraintDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-817"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span>
</span><span id="line-818"></span><span id="pgConstraintMigrationKey"><span class="annot"><span class="annottext">pgConstraintMigrationKey :: ConstraintDescription -&gt; Maybe ConstraintMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintMigrationKey"><span class="hs-identifier hs-var hs-var">pgConstraintMigrationKey</span></a></span></span><span> </span><span id="local-6989586621679143184"><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-819"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-820"></span><span>    </span><span id="local-6989586621679143185"><span class="annot"><span class="annottext">toOrvilleConstraintKeyType :: ConstraintType -&gt; Maybe ConstraintKeyType
</span><a href="#local-6989586621679143185"><span class="hs-identifier hs-var hs-var">toOrvilleConstraintKeyType</span></a></span></span><span> </span><span id="local-6989586621679143186"><span class="annot"><span class="annottext">ConstraintType
</span><a href="#local-6989586621679143186"><span class="hs-identifier hs-var">pgConType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-821"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="#local-6989586621679143186"><span class="hs-identifier hs-var">pgConType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#UniqueConstraint"><span class="hs-identifier hs-var">PgCatalog.UniqueConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConstraintKeyType -&gt; Maybe ConstraintKeyType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#UniqueConstraint"><span class="hs-identifier hs-var">Orville.UniqueConstraint</span></a></span><span>
</span><span id="line-823"></span><span>        </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#ForeignKeyConstraint"><span class="hs-identifier hs-var">PgCatalog.ForeignKeyConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConstraintKeyType -&gt; Maybe ConstraintKeyType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ForeignKeyConstraint"><span class="hs-identifier hs-var">Orville.ForeignKeyConstraint</span></a></span><span>
</span><span id="line-824"></span><span>        </span><span class="annot"><span class="annottext">ConstraintType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ConstraintKeyType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span>    </span><span id="local-6989586621679143189"><span class="annot"><span class="annottext">constraint :: PgConstraint
</span><a href="#local-6989586621679143189"><span class="hs-identifier hs-var hs-var">constraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-827"></span><span>      </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; PgConstraint
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintRecord"><span class="hs-identifier hs-var">PgCatalog.constraintRecord</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span>
</span><span id="line-828"></span><span>
</span><span id="line-829"></span><span>    </span><span id="local-6989586621679143190"><span class="annot"><span class="annottext">pgAttributeNamesToFieldNames :: [PgAttribute] -&gt; [FieldName]
</span><a href="#local-6989586621679143190"><span class="hs-identifier hs-var hs-var">pgAttributeNamesToFieldNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-830"></span><span>      </span><span class="annot"><span class="annottext">(PgAttribute -&gt; FieldName) -&gt; [PgAttribute] -&gt; [FieldName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FieldName
</span><a href="Orville.PostgreSQL.Internal.FieldName.html#stringToFieldName"><span class="hs-identifier hs-var">Orville.stringToFieldName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; FieldName)
-&gt; (PgAttribute -&gt; String) -&gt; PgAttribute -&gt; FieldName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AttributeName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#attributeNameToString"><span class="hs-identifier hs-var">PgCatalog.attributeNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">(AttributeName -&gt; String)
-&gt; (PgAttribute -&gt; AttributeName) -&gt; PgAttribute -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; AttributeName
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeName"><span class="hs-identifier hs-var">PgCatalog.pgAttributeName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span>    </span><span class="annot"><a href="#local-6989586621679143192"><span class="hs-identifier hs-type">foreignRelationTableId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#ForeignRelationDescription"><span class="hs-identifier hs-type">PgCatalog.ForeignRelationDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#TableIdentifier"><span class="hs-identifier hs-type">Orville.TableIdentifier</span></a></span><span>
</span><span id="line-833"></span><span>    </span><span id="local-6989586621679143192"><span class="annot"><span class="annottext">foreignRelationTableId :: ForeignRelationDescription -&gt; TableIdentifier
</span><a href="#local-6989586621679143192"><span class="hs-identifier hs-var hs-var">foreignRelationTableId</span></a></span></span><span> </span><span id="local-6989586621679143193"><span class="annot"><span class="annottext">ForeignRelationDescription
</span><a href="#local-6989586621679143193"><span class="hs-identifier hs-var">foreignRelationDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-834"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-835"></span><span>        </span><span id="local-6989586621679143194"><span class="annot"><span class="annottext">relationName :: String
</span><a href="#local-6989586621679143194"><span class="hs-identifier hs-var hs-var">relationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-836"></span><span>          </span><span class="annot"><span class="annottext">RelationName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#relationNameToString"><span class="hs-identifier hs-var">PgCatalog.relationNameToString</span></a></span><span>
</span><span id="line-837"></span><span>            </span><span class="annot"><span class="annottext">(RelationName -&gt; String)
-&gt; (ForeignRelationDescription -&gt; RelationName)
-&gt; ForeignRelationDescription
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgClass -&gt; RelationName
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#pgClassRelationName"><span class="hs-identifier hs-var">PgCatalog.pgClassRelationName</span></a></span><span>
</span><span id="line-838"></span><span>            </span><span class="annot"><span class="annottext">(PgClass -&gt; RelationName)
-&gt; (ForeignRelationDescription -&gt; PgClass)
-&gt; ForeignRelationDescription
-&gt; RelationName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ForeignRelationDescription -&gt; PgClass
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#foreignRelationClass"><span class="hs-identifier hs-var">PgCatalog.foreignRelationClass</span></a></span><span>
</span><span id="line-839"></span><span>            </span><span class="annot"><span class="annottext">(ForeignRelationDescription -&gt; String)
-&gt; ForeignRelationDescription -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ForeignRelationDescription
</span><a href="#local-6989586621679143193"><span class="hs-identifier hs-var">foreignRelationDesc</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span>        </span><span id="local-6989586621679143197"><span class="annot"><span class="annottext">namespaceName :: String
</span><a href="#local-6989586621679143197"><span class="hs-identifier hs-var hs-var">namespaceName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-842"></span><span>          </span><span class="annot"><span class="annottext">NamespaceName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#namespaceNameToString"><span class="hs-identifier hs-var">PgCatalog.namespaceNameToString</span></a></span><span>
</span><span id="line-843"></span><span>            </span><span class="annot"><span class="annottext">(NamespaceName -&gt; String)
-&gt; (ForeignRelationDescription -&gt; NamespaceName)
-&gt; ForeignRelationDescription
-&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgNamespace -&gt; NamespaceName
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#pgNamespaceName"><span class="hs-identifier hs-var">PgCatalog.pgNamespaceName</span></a></span><span>
</span><span id="line-844"></span><span>            </span><span class="annot"><span class="annottext">(PgNamespace -&gt; NamespaceName)
-&gt; (ForeignRelationDescription -&gt; PgNamespace)
-&gt; ForeignRelationDescription
-&gt; NamespaceName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ForeignRelationDescription -&gt; PgNamespace
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#foreignRelationNamespace"><span class="hs-identifier hs-var">PgCatalog.foreignRelationNamespace</span></a></span><span>
</span><span id="line-845"></span><span>            </span><span class="annot"><span class="annottext">(ForeignRelationDescription -&gt; String)
-&gt; ForeignRelationDescription -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ForeignRelationDescription
</span><a href="#local-6989586621679143193"><span class="hs-identifier hs-var">foreignRelationDesc</span></a></span><span>
</span><span id="line-846"></span><span>      </span><span class="hs-keyword">in</span><span>
</span><span id="line-847"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TableIdentifier -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#setTableIdSchema"><span class="hs-identifier hs-var">Orville.setTableIdSchema</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679143197"><span class="hs-identifier hs-var">namespaceName</span></a></span><span> </span><span class="annot"><span class="annottext">(TableIdentifier -&gt; TableIdentifier)
-&gt; TableIdentifier -&gt; TableIdentifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-848"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#unqualifiedNameToTableId"><span class="hs-identifier hs-var">Orville.unqualifiedNameToTableId</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679143194"><span class="hs-identifier hs-var">relationName</span></a></span><span>
</span><span id="line-849"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-keyword">do</span><span>
</span><span id="line-851"></span><span>      </span><span id="local-6989586621679143201"><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="#local-6989586621679143201"><span class="hs-identifier hs-var">keyType</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ConstraintType -&gt; Maybe ConstraintKeyType
</span><a href="#local-6989586621679143185"><span class="hs-identifier hs-var">toOrvilleConstraintKeyType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PgConstraint -&gt; ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintType"><span class="hs-identifier hs-var">PgCatalog.pgConstraintType</span></a></span><span> </span><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143189"><span class="hs-identifier hs-var">constraint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span>      </span><span class="annot"><span class="annottext">ConstraintMigrationKey -&gt; Maybe ConstraintMigrationKey
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ConstraintMigrationKey -&gt; Maybe ConstraintMigrationKey)
-&gt; ConstraintMigrationKey -&gt; Maybe ConstraintMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-853"></span><span>        </span><span class="annot"><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#ConstraintMigrationKey"><span class="hs-identifier hs-type">Orville.ConstraintMigrationKey</span></a></span><span>
</span><span id="line-854"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">constraintKeyType :: ConstraintKeyType
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyType"><span class="hs-identifier hs-var">Orville.constraintKeyType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstraintKeyType
</span><a href="#local-6989586621679143201"><span class="hs-identifier hs-var">keyType</span></a></span><span>
</span><span id="line-855"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">constraintKeyColumns :: Maybe [FieldName]
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyColumns"><span class="hs-identifier hs-var">Orville.constraintKeyColumns</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-856"></span><span>              </span><span class="annot"><span class="annottext">([PgAttribute] -&gt; [FieldName])
-&gt; Maybe [PgAttribute] -&gt; Maybe [FieldName]
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-857"></span><span>                </span><span class="annot"><span class="annottext">[PgAttribute] -&gt; [FieldName]
</span><a href="#local-6989586621679143190"><span class="hs-identifier hs-var">pgAttributeNamesToFieldNames</span></a></span><span>
</span><span id="line-858"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstraintDescription -&gt; Maybe [PgAttribute]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintKey"><span class="hs-identifier hs-var">PgCatalog.constraintKey</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-859"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">constraintKeyForeignTable :: Maybe TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignTable"><span class="hs-identifier hs-var">Orville.constraintKeyForeignTable</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>              </span><span class="annot"><span class="annottext">(ForeignRelationDescription -&gt; TableIdentifier)
-&gt; Maybe ForeignRelationDescription -&gt; Maybe TableIdentifier
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ForeignRelationDescription -&gt; TableIdentifier
</span><a href="#local-6989586621679143192"><span class="hs-identifier hs-var">foreignRelationTableId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstraintDescription -&gt; Maybe ForeignRelationDescription
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintForeignRelation"><span class="hs-identifier hs-var">PgCatalog.constraintForeignRelation</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-861"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">constraintKeyForeignColumns :: Maybe [FieldName]
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignColumns"><span class="hs-identifier hs-var">Orville.constraintKeyForeignColumns</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-862"></span><span>              </span><span class="annot"><span class="annottext">([PgAttribute] -&gt; [FieldName])
-&gt; Maybe [PgAttribute] -&gt; Maybe [FieldName]
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span>
</span><span id="line-863"></span><span>                </span><span class="annot"><span class="annottext">[PgAttribute] -&gt; [FieldName]
</span><a href="#local-6989586621679143190"><span class="hs-identifier hs-var">pgAttributeNamesToFieldNames</span></a></span><span>
</span><span id="line-864"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstraintDescription -&gt; Maybe [PgAttribute]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintForeignKey"><span class="hs-identifier hs-var">PgCatalog.constraintForeignKey</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">constraintKeyForeignKeyOnUpdateAction :: Maybe ForeignKeyAction
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignKeyOnUpdateAction"><span class="hs-identifier hs-var">Orville.constraintKeyForeignKeyOnUpdateAction</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-866"></span><span>              </span><span class="annot"><span class="annottext">PgConstraint -&gt; Maybe ForeignKeyAction
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintForeignKeyOnUpdateType"><span class="hs-identifier hs-var">PgCatalog.pgConstraintForeignKeyOnUpdateType</span></a></span><span> </span><span class="annot"><span class="annottext">(PgConstraint -&gt; Maybe ForeignKeyAction)
-&gt; PgConstraint -&gt; Maybe ForeignKeyAction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; PgConstraint
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintRecord"><span class="hs-identifier hs-var">PgCatalog.constraintRecord</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span>
</span><span id="line-867"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">constraintKeyForeignKeyOnDeleteAction :: Maybe ForeignKeyAction
</span><a href="Orville.PostgreSQL.Schema.ConstraintDefinition.html#constraintKeyForeignKeyOnDeleteAction"><span class="hs-identifier hs-var">Orville.constraintKeyForeignKeyOnDeleteAction</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-868"></span><span>              </span><span class="annot"><span class="annottext">PgConstraint -&gt; Maybe ForeignKeyAction
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintForeignKeyOnDeleteType"><span class="hs-identifier hs-var">PgCatalog.pgConstraintForeignKeyOnDeleteType</span></a></span><span> </span><span class="annot"><span class="annottext">(PgConstraint -&gt; Maybe ForeignKeyAction)
-&gt; PgConstraint -&gt; Maybe ForeignKeyAction
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription -&gt; PgConstraint
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#constraintRecord"><span class="hs-identifier hs-var">PgCatalog.constraintRecord</span></a></span><span> </span><span class="annot"><span class="annottext">ConstraintDescription
</span><a href="#local-6989586621679143184"><span class="hs-identifier hs-var">constraintDesc</span></a></span><span>
</span><span id="line-869"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span class="annot"><span class="hs-comment">{- |
  Builds migration steps to create an index if it does not exist.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-876"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAddIndexSteps"><span class="hs-identifier hs-type">mkAddIndexSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-877"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#IndexMigrationKey"><span class="hs-identifier hs-type">IndexDefinition.IndexMigrationKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-878"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.Qualified.html#Qualified"><span class="hs-identifier hs-type">Expr.Qualified</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Internal.Name.TableName.html#TableName"><span class="hs-identifier hs-type">Expr.TableName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#IndexDefinition"><span class="hs-identifier hs-type">Orville.IndexDefinition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-881"></span><span id="mkAddIndexSteps"><span class="annot"><span class="annottext">mkAddIndexSteps :: Set IndexMigrationKey
-&gt; Qualified TableName
-&gt; IndexDefinition
-&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAddIndexSteps"><span class="hs-identifier hs-var hs-var">mkAddIndexSteps</span></a></span></span><span> </span><span id="local-6989586621679143213"><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143213"><span class="hs-identifier hs-var">existingIndexes</span></a></span></span><span> </span><span id="local-6989586621679143214"><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143214"><span class="hs-identifier hs-var">tableName</span></a></span></span><span> </span><span id="local-6989586621679143215"><span class="annot"><span class="annottext">IndexDefinition
</span><a href="#local-6989586621679143215"><span class="hs-identifier hs-var">indexDef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-882"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-883"></span><span>    </span><span id="local-6989586621679143216"><span class="annot"><span class="annottext">indexKey :: IndexMigrationKey
</span><a href="#local-6989586621679143216"><span class="hs-identifier hs-var hs-var">indexKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-884"></span><span>      </span><span class="annot"><span class="annottext">IndexDefinition -&gt; IndexMigrationKey
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#indexMigrationKey"><span class="hs-identifier hs-var">IndexDefinition.indexMigrationKey</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDefinition
</span><a href="#local-6989586621679143215"><span class="hs-identifier hs-var">indexDef</span></a></span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span>    </span><span id="local-6989586621679143218"><span class="annot"><span class="annottext">indexStep :: StepType
</span><a href="#local-6989586621679143218"><span class="hs-identifier hs-var hs-var">indexStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-887"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IndexDefinition -&gt; IndexCreationStrategy
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#indexCreationStrategy"><span class="hs-identifier hs-var">Orville.indexCreationStrategy</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDefinition
</span><a href="#local-6989586621679143215"><span class="hs-identifier hs-var">indexDef</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-888"></span><span>        </span><span class="annot"><span class="annottext">IndexCreationStrategy
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#Transactional"><span class="hs-identifier hs-var">Orville.Transactional</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesTransactionally"><span class="hs-identifier hs-var">AddIndexesTransactionally</span></a></span><span>
</span><span id="line-889"></span><span>        </span><span class="annot"><span class="annottext">IndexCreationStrategy
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#Asynchronous"><span class="hs-identifier hs-var">Orville.Asynchronous</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddIndexesAsynchronously"><span class="hs-identifier hs-var">AddIndexesAsynchronously</span></a></span><span>
</span><span id="line-890"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-891"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IndexMigrationKey -&gt; Set IndexMigrationKey -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">IndexMigrationKey
</span><a href="#local-6989586621679143216"><span class="hs-identifier hs-var">indexKey</span></a></span><span> </span><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143213"><span class="hs-identifier hs-var">existingIndexes</span></a></span><span>
</span><span id="line-892"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-893"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StepType -&gt; CreateIndexExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="#local-6989586621679143218"><span class="hs-identifier hs-var">indexStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IndexDefinition -&gt; Qualified TableName -&gt; CreateIndexExpr
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#indexCreateExpr"><span class="hs-identifier hs-var">Orville.indexCreateExpr</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDefinition
</span><a href="#local-6989586621679143215"><span class="hs-identifier hs-var">indexDef</span></a></span><span> </span><span class="annot"><span class="annottext">Qualified TableName
</span><a href="#local-6989586621679143214"><span class="hs-identifier hs-var">tableName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span class="annot"><span class="hs-comment">{- |
  Builds migration steps to drop an index if it should not exist.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-900"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkDropIndexSteps"><span class="hs-identifier hs-type">mkDropIndexSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-901"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#IndexMigrationKey"><span class="hs-identifier hs-type">IndexDefinition.IndexMigrationKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-902"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set.Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LibPQ.Oid</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-903"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#IndexDescription"><span class="hs-identifier hs-type">PgCatalog.IndexDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-904"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-905"></span><span id="mkDropIndexSteps"><span class="annot"><span class="annottext">mkDropIndexSteps :: Set IndexMigrationKey
-&gt; Set Oid -&gt; IndexDescription -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkDropIndexSteps"><span class="hs-identifier hs-var hs-var">mkDropIndexSteps</span></a></span></span><span> </span><span id="local-6989586621679143222"><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143222"><span class="hs-identifier hs-var">indexesToKeep</span></a></span></span><span> </span><span id="local-6989586621679143223"><span class="annot"><span class="annottext">Set Oid
</span><a href="#local-6989586621679143223"><span class="hs-identifier hs-var">systemIndexOids</span></a></span></span><span> </span><span id="local-6989586621679143224"><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143224"><span class="hs-identifier hs-var">indexDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; [IndexMigrationKey]
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgIndexMigrationKeys"><span class="hs-identifier hs-var">pgIndexMigrationKeys</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143224"><span class="hs-identifier hs-var">indexDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-907"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-908"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-909"></span><span>    </span><span id="local-6989586621679143225"><span class="annot"><span class="annottext">[IndexMigrationKey]
</span><a href="#local-6989586621679143225"><span class="hs-identifier hs-var">indexKeys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-910"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-911"></span><span>        </span><span id="local-6989586621679143226"><span class="annot"><span class="annottext">pgClass :: PgClass
</span><a href="#local-6989586621679143226"><span class="hs-identifier hs-var hs-var">pgClass</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-912"></span><span>          </span><span class="annot"><span class="annottext">IndexDescription -&gt; PgClass
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#indexPgClass"><span class="hs-identifier hs-var">PgCatalog.indexPgClass</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143224"><span class="hs-identifier hs-var">indexDesc</span></a></span><span>
</span><span id="line-913"></span><span>
</span><span id="line-914"></span><span>        </span><span id="local-6989586621679143228"><span class="annot"><span class="annottext">indexName :: IndexName
</span><a href="#local-6989586621679143228"><span class="hs-identifier hs-var hs-var">indexName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-915"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; IndexName
</span><a href="Orville.PostgreSQL.Expr.Internal.Name.IndexName.html#indexName"><span class="hs-identifier hs-var">Expr.indexName</span></a></span><span>
</span><span id="line-916"></span><span>            </span><span class="annot"><span class="annottext">(String -&gt; IndexName)
-&gt; (PgClass -&gt; String) -&gt; PgClass -&gt; IndexName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RelationName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#relationNameToString"><span class="hs-identifier hs-var">PgCatalog.relationNameToString</span></a></span><span>
</span><span id="line-917"></span><span>            </span><span class="annot"><span class="annottext">(RelationName -&gt; String)
-&gt; (PgClass -&gt; RelationName) -&gt; PgClass -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgClass -&gt; RelationName
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#pgClassRelationName"><span class="hs-identifier hs-var">PgCatalog.pgClassRelationName</span></a></span><span>
</span><span id="line-918"></span><span>            </span><span class="annot"><span class="annottext">(PgClass -&gt; IndexName) -&gt; PgClass -&gt; IndexName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgClass
</span><a href="#local-6989586621679143226"><span class="hs-identifier hs-var">pgClass</span></a></span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span>        </span><span id="local-6989586621679143230"><span class="annot"><span class="annottext">indexOid :: Oid
</span><a href="#local-6989586621679143230"><span class="hs-identifier hs-var hs-var">indexOid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-921"></span><span>          </span><span class="annot"><span class="annottext">PgClass -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#pgClassOid"><span class="hs-identifier hs-var">PgCatalog.pgClassOid</span></a></span><span> </span><span class="annot"><span class="annottext">PgClass
</span><a href="#local-6989586621679143226"><span class="hs-identifier hs-var">pgClass</span></a></span><span>
</span><span id="line-922"></span><span>      </span><span class="hs-keyword">in</span><span>
</span><span id="line-923"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(IndexMigrationKey -&gt; Bool) -&gt; [IndexMigrationKey] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IndexMigrationKey -&gt; Set IndexMigrationKey -&gt; Bool)
-&gt; Set IndexMigrationKey -&gt; IndexMigrationKey -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">IndexMigrationKey -&gt; Set IndexMigrationKey -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">Set IndexMigrationKey
</span><a href="#local-6989586621679143222"><span class="hs-identifier hs-var">indexesToKeep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[IndexMigrationKey]
</span><a href="#local-6989586621679143225"><span class="hs-identifier hs-var">indexKeys</span></a></span><span>
</span><span id="line-924"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Oid -&gt; Set Oid -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">Oid
</span><a href="#local-6989586621679143230"><span class="hs-identifier hs-var">indexOid</span></a></span><span> </span><span class="annot"><span class="annottext">Set Oid
</span><a href="#local-6989586621679143223"><span class="hs-identifier hs-var">systemIndexOids</span></a></span><span>
</span><span id="line-925"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-926"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StepType -&gt; DropIndexExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#DropIndexes"><span class="hs-identifier hs-var">DropIndexes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IndexName -&gt; DropIndexExpr
</span><a href="Orville.PostgreSQL.Expr.Index.html#dropIndexExpr"><span class="hs-identifier hs-var">Expr.dropIndexExpr</span></a></span><span> </span><span class="annot"><span class="annottext">IndexName
</span><a href="#local-6989586621679143228"><span class="hs-identifier hs-var">indexName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-927"></span><span>
</span><span id="line-928"></span><span class="annot"><span class="hs-comment">{- |
  Primary Key, Unique, and Exclusion constraints automatically create indexes
  that we don't want orville to consider for the purposes of migrations. This
  function checks the constraint type and returns the OID of the supporting
  index if the constraint is one of these types.

  Foreign key constraints also have a supporting index OID in @pg_catalog@, but
  this index is not automatically created due to the constraint, so we don't
  return the index's OID for that case.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-940"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintImpliedIndexOid"><span class="hs-identifier hs-type">pgConstraintImpliedIndexOid</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#PgConstraint"><span class="hs-identifier hs-type">PgCatalog.PgConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LibPQ.Oid</span></span><span>
</span><span id="line-941"></span><span id="pgConstraintImpliedIndexOid"><span class="annot"><span class="annottext">pgConstraintImpliedIndexOid :: PgConstraint -&gt; Maybe Oid
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgConstraintImpliedIndexOid"><span class="hs-identifier hs-var hs-var">pgConstraintImpliedIndexOid</span></a></span></span><span> </span><span id="local-6989586621679143235"><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143235"><span class="hs-identifier hs-var">pgConstraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-942"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PgConstraint -&gt; ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintType"><span class="hs-identifier hs-var">PgCatalog.pgConstraintType</span></a></span><span> </span><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143235"><span class="hs-identifier hs-var">pgConstraint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-943"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#PrimaryKeyConstraint"><span class="hs-identifier hs-var">PgCatalog.PrimaryKeyConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-944"></span><span>      </span><span class="annot"><span class="annottext">Oid -&gt; Maybe Oid
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Oid -&gt; Maybe Oid) -&gt; Oid -&gt; Maybe Oid
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgConstraint -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintIndexOid"><span class="hs-identifier hs-var">PgCatalog.pgConstraintIndexOid</span></a></span><span> </span><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143235"><span class="hs-identifier hs-var">pgConstraint</span></a></span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#UniqueConstraint"><span class="hs-identifier hs-var">PgCatalog.UniqueConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-946"></span><span>      </span><span class="annot"><span class="annottext">Oid -&gt; Maybe Oid
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Oid -&gt; Maybe Oid) -&gt; Oid -&gt; Maybe Oid
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgConstraint -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintIndexOid"><span class="hs-identifier hs-var">PgCatalog.pgConstraintIndexOid</span></a></span><span> </span><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143235"><span class="hs-identifier hs-var">pgConstraint</span></a></span><span>
</span><span id="line-947"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#ExclusionConstraint"><span class="hs-identifier hs-var">PgCatalog.ExclusionConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-948"></span><span>      </span><span class="annot"><span class="annottext">Oid -&gt; Maybe Oid
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Oid -&gt; Maybe Oid) -&gt; Oid -&gt; Maybe Oid
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgConstraint -&gt; Oid
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#pgConstraintIndexOid"><span class="hs-identifier hs-var">PgCatalog.pgConstraintIndexOid</span></a></span><span> </span><span class="annot"><span class="annottext">PgConstraint
</span><a href="#local-6989586621679143235"><span class="hs-identifier hs-var">pgConstraint</span></a></span><span>
</span><span id="line-949"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#CheckConstraint"><span class="hs-identifier hs-var">PgCatalog.CheckConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-950"></span><span>      </span><span class="annot"><span class="annottext">Maybe Oid
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-951"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#ForeignKeyConstraint"><span class="hs-identifier hs-var">PgCatalog.ForeignKeyConstraint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-952"></span><span>      </span><span class="annot"><span class="annottext">Maybe Oid
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-953"></span><span>    </span><span class="annot"><span class="annottext">ConstraintType
</span><a href="Orville.PostgreSQL.PgCatalog.PgConstraint.html#ConstraintTrigger"><span class="hs-identifier hs-var">PgCatalog.ConstraintTrigger</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-954"></span><span>      </span><span class="annot"><span class="annottext">Maybe Oid
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-955"></span><span>
</span><span id="line-956"></span><span class="annot"><span class="hs-comment">{- |
  Builds the orville migration keys given a description of an existing index
  so that it can be compared with indexs found in a table definition.

  If the description includes expressions as members of the index rather than
  simple attributes, 'Nothing' is returned.

@since 1.0.0.0
-}</span></span><span>
</span><span id="line-965"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#pgIndexMigrationKeys"><span class="hs-identifier hs-type">pgIndexMigrationKeys</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-966"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#IndexDescription"><span class="hs-identifier hs-type">PgCatalog.IndexDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-967"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#IndexMigrationKey"><span class="hs-identifier hs-type">IndexDefinition.IndexMigrationKey</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-968"></span><span id="pgIndexMigrationKeys"><span class="annot"><span class="annottext">pgIndexMigrationKeys :: IndexDescription -&gt; [IndexMigrationKey]
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgIndexMigrationKeys"><span class="hs-identifier hs-var hs-var">pgIndexMigrationKeys</span></a></span></span><span> </span><span id="local-6989586621679143241"><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143241"><span class="hs-identifier hs-var">indexDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-969"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-970"></span><span>    </span><span id="local-6989586621679143242"><span class="annot"><span class="annottext">mkNamedIndexKey :: IndexMigrationKey
</span><a href="#local-6989586621679143242"><span class="hs-identifier hs-var hs-var">mkNamedIndexKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-971"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; IndexMigrationKey
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#NamedIndexKey"><span class="hs-identifier hs-var">IndexDefinition.NamedIndexKey</span></a></span><span>
</span><span id="line-972"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; IndexMigrationKey)
-&gt; (IndexDescription -&gt; String)
-&gt; IndexDescription
-&gt; IndexMigrationKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RelationName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#relationNameToString"><span class="hs-identifier hs-var">PgCatalog.relationNameToString</span></a></span><span>
</span><span id="line-973"></span><span>        </span><span class="annot"><span class="annottext">(RelationName -&gt; String)
-&gt; (IndexDescription -&gt; RelationName) -&gt; IndexDescription -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgClass -&gt; RelationName
</span><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#pgClassRelationName"><span class="hs-identifier hs-var">PgCatalog.pgClassRelationName</span></a></span><span>
</span><span id="line-974"></span><span>        </span><span class="annot"><span class="annottext">(PgClass -&gt; RelationName)
-&gt; (IndexDescription -&gt; PgClass)
-&gt; IndexDescription
-&gt; RelationName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; PgClass
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#indexPgClass"><span class="hs-identifier hs-var">PgCatalog.indexPgClass</span></a></span><span>
</span><span id="line-975"></span><span>        </span><span class="annot"><span class="annottext">(IndexDescription -&gt; IndexMigrationKey)
-&gt; IndexDescription -&gt; IndexMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143241"><span class="hs-identifier hs-var">indexDesc</span></a></span><span>
</span><span id="line-976"></span><span>    </span><span id="local-6989586621679143244"><span class="annot"><span class="annottext">mkAttributeBasedIndexKey :: [IndexMigrationKey]
</span><a href="#local-6989586621679143244"><span class="hs-identifier hs-var hs-var">mkAttributeBasedIndexKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-977"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IndexDescription -&gt; Maybe AttributeBasedIndexMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgAttributeBasedIndexMigrationKey"><span class="hs-identifier hs-var">pgAttributeBasedIndexMigrationKey</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143241"><span class="hs-identifier hs-var">indexDesc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679143246"><span class="annot"><span class="annottext">AttributeBasedIndexMigrationKey
</span><a href="#local-6989586621679143246"><span class="hs-identifier hs-var">standardKey</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-979"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AttributeBasedIndexMigrationKey -&gt; IndexMigrationKey
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#AttributeBasedIndexKey"><span class="hs-identifier hs-var">IndexDefinition.AttributeBasedIndexKey</span></a></span><span> </span><span class="annot"><span class="annottext">AttributeBasedIndexMigrationKey
</span><a href="#local-6989586621679143246"><span class="hs-identifier hs-var">standardKey</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-980"></span><span>        </span><span class="annot"><span class="annottext">Maybe AttributeBasedIndexMigrationKey
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-981"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-983"></span><span>    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IndexMigrationKey
</span><a href="#local-6989586621679143242"><span class="hs-identifier hs-var">mkNamedIndexKey</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[IndexMigrationKey] -&gt; [IndexMigrationKey] -&gt; [IndexMigrationKey]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[IndexMigrationKey]
</span><a href="#local-6989586621679143244"><span class="hs-identifier hs-var">mkAttributeBasedIndexKey</span></a></span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#pgAttributeBasedIndexMigrationKey"><span class="hs-identifier hs-type">pgAttributeBasedIndexMigrationKey</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-986"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#IndexDescription"><span class="hs-identifier hs-type">PgCatalog.IndexDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-987"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#AttributeBasedIndexMigrationKey"><span class="hs-identifier hs-type">IndexDefinition.AttributeBasedIndexMigrationKey</span></a></span><span>
</span><span id="line-988"></span><span id="pgAttributeBasedIndexMigrationKey"><span class="annot"><span class="annottext">pgAttributeBasedIndexMigrationKey :: IndexDescription -&gt; Maybe AttributeBasedIndexMigrationKey
</span><a href="Orville.PostgreSQL.AutoMigration.html#pgAttributeBasedIndexMigrationKey"><span class="hs-identifier hs-var hs-var">pgAttributeBasedIndexMigrationKey</span></a></span></span><span> </span><span id="local-6989586621679143248"><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143248"><span class="hs-identifier hs-var">indexDesc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-989"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-990"></span><span>    </span><span id="local-6989586621679143249"><span class="annot"><span class="annottext">indexMemberToFieldName :: IndexMember -&gt; Maybe FieldName
</span><a href="#local-6989586621679143249"><span class="hs-identifier hs-var hs-var">indexMemberToFieldName</span></a></span></span><span> </span><span id="local-6989586621679143250"><span class="annot"><span class="annottext">IndexMember
</span><a href="#local-6989586621679143250"><span class="hs-identifier hs-var">member</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-991"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IndexMember
</span><a href="#local-6989586621679143250"><span class="hs-identifier hs-var">member</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-992"></span><span>        </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#IndexAttribute"><span class="hs-identifier hs-type">PgCatalog.IndexAttribute</span></a></span><span> </span><span id="local-6989586621679143252"><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143252"><span class="hs-identifier hs-var">attr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-993"></span><span>          </span><span class="annot"><span class="annottext">FieldName -&gt; Maybe FieldName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FieldName
</span><a href="Orville.PostgreSQL.Internal.FieldName.html#stringToFieldName"><span class="hs-identifier hs-var">Orville.stringToFieldName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; FieldName)
-&gt; (PgAttribute -&gt; String) -&gt; PgAttribute -&gt; FieldName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">AttributeName -&gt; String
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#attributeNameToString"><span class="hs-identifier hs-var">PgCatalog.attributeNameToString</span></a></span><span> </span><span class="annot"><span class="annottext">(AttributeName -&gt; String)
-&gt; (PgAttribute -&gt; AttributeName) -&gt; PgAttribute -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute -&gt; AttributeName
</span><a href="Orville.PostgreSQL.PgCatalog.PgAttribute.html#pgAttributeName"><span class="hs-identifier hs-var">PgCatalog.pgAttributeName</span></a></span><span> </span><span class="annot"><span class="annottext">(PgAttribute -&gt; FieldName) -&gt; PgAttribute -&gt; FieldName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PgAttribute
</span><a href="#local-6989586621679143252"><span class="hs-identifier hs-var">attr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-994"></span><span>        </span><span class="annot"><span class="annottext">IndexMember
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#IndexExpression"><span class="hs-identifier hs-var">PgCatalog.IndexExpression</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-995"></span><span>          </span><span class="annot"><span class="annottext">Maybe FieldName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>    </span><span id="local-6989586621679143254"><span class="annot"><span class="annottext">uniqueness :: IndexUniqueness
</span><a href="#local-6989586621679143254"><span class="hs-identifier hs-var hs-var">uniqueness</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-998"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PgIndex -&gt; Bool
</span><a href="Orville.PostgreSQL.PgCatalog.PgIndex.html#pgIndexIsUnique"><span class="hs-identifier hs-var">PgCatalog.pgIndexIsUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IndexDescription -&gt; PgIndex
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#indexRecord"><span class="hs-identifier hs-var">PgCatalog.indexRecord</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143248"><span class="hs-identifier hs-var">indexDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IndexUniqueness
</span><a href="Orville.PostgreSQL.Expr.Index.html#UniqueIndex"><span class="hs-identifier hs-var">Orville.UniqueIndex</span></a></span><span>
</span><span id="line-1000"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IndexUniqueness
</span><a href="Orville.PostgreSQL.Expr.Index.html#NonUniqueIndex"><span class="hs-identifier hs-var">Orville.NonUniqueIndex</span></a></span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span>  </span><span id="local-6989586621679143258"><span class="annot"><span class="annottext">[FieldName]
</span><a href="#local-6989586621679143258"><span class="hs-identifier hs-var">fieldNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IndexMember -&gt; Maybe FieldName)
-&gt; [IndexMember] -&gt; Maybe [FieldName]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">IndexMember -&gt; Maybe FieldName
</span><a href="#local-6989586621679143249"><span class="hs-identifier hs-var">indexMemberToFieldName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IndexDescription -&gt; [IndexMember]
</span><a href="Orville.PostgreSQL.PgCatalog.DatabaseDescription.html#indexMembers"><span class="hs-identifier hs-var">PgCatalog.indexMembers</span></a></span><span> </span><span class="annot"><span class="annottext">IndexDescription
</span><a href="#local-6989586621679143248"><span class="hs-identifier hs-var">indexDesc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1003"></span><span>  </span><span class="annot"><span class="annottext">AttributeBasedIndexMigrationKey
-&gt; Maybe AttributeBasedIndexMigrationKey
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(AttributeBasedIndexMigrationKey
 -&gt; Maybe AttributeBasedIndexMigrationKey)
-&gt; AttributeBasedIndexMigrationKey
-&gt; Maybe AttributeBasedIndexMigrationKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1004"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#AttributeBasedIndexMigrationKey"><span class="hs-identifier hs-type">IndexDefinition.AttributeBasedIndexMigrationKey</span></a></span><span>
</span><span id="line-1005"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">indexKeyUniqueness :: IndexUniqueness
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#indexKeyUniqueness"><span class="hs-identifier hs-var">IndexDefinition.indexKeyUniqueness</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IndexUniqueness
</span><a href="#local-6989586621679143254"><span class="hs-identifier hs-var">uniqueness</span></a></span><span>
</span><span id="line-1006"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">indexKeyColumns :: [FieldName]
</span><a href="Orville.PostgreSQL.Internal.IndexDefinition.html#indexKeyColumns"><span class="hs-identifier hs-var">IndexDefinition.indexKeyColumns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FieldName]
</span><a href="#local-6989586621679143258"><span class="hs-identifier hs-var">fieldNames</span></a></span><span>
</span><span id="line-1007"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1008"></span><span>
</span><span id="line-1009"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemPgCatalogRelation"><span class="hs-identifier hs-type">schemaItemPgCatalogRelation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1010"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1011"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaItem"><span class="hs-identifier hs-type">SchemaItem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#RelationName"><span class="hs-identifier hs-type">PgCatalog.RelationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span id="schemaItemPgCatalogRelation"><span class="annot"><span class="annottext">schemaItemPgCatalogRelation :: NamespaceName -&gt; SchemaItem -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#schemaItemPgCatalogRelation"><span class="hs-identifier hs-var hs-var">schemaItemPgCatalogRelation</span></a></span></span><span> </span><span id="local-6989586621679143263"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143263"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143264"><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679143264"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SchemaItem
</span><a href="#local-6989586621679143264"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1015"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaTable"><span class="hs-identifier hs-type">SchemaTable</span></a></span><span> </span><span id="local-6989586621679143265"><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143265"><span class="hs-identifier hs-var">tableDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1016"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName -&gt; TableIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-var">tableIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143263"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity -&gt; TableIdentifier
forall key writeEntity readEntity.
TableDefinition key writeEntity readEntity -&gt; TableIdentifier
</span><a href="Orville.PostgreSQL.Schema.TableDefinition.html#tableIdentifier"><span class="hs-identifier hs-var">Orville.tableIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">TableDefinition key writeEntity readEntity
</span><a href="#local-6989586621679143265"><span class="hs-identifier hs-var">tableDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1017"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropTable"><span class="hs-identifier hs-type">SchemaDropTable</span></a></span><span> </span><span id="local-6989586621679143266"><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143266"><span class="hs-identifier hs-var">tableId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1018"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName -&gt; TableIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-var">tableIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143263"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143266"><span class="hs-identifier hs-var">tableId</span></a></span><span>
</span><span id="line-1019"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaSequence"><span class="hs-identifier hs-type">SchemaSequence</span></a></span><span> </span><span id="local-6989586621679143267"><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143267"><span class="hs-identifier hs-var">sequenceDef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1020"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName
-&gt; SequenceIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-var">sequenceIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143263"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceDefinition -&gt; SequenceIdentifier
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceIdentifier"><span class="hs-identifier hs-var">Orville.sequenceIdentifier</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143267"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>    </span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#SchemaDropSequence"><span class="hs-identifier hs-type">SchemaDropSequence</span></a></span><span> </span><span id="local-6989586621679143268"><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679143268"><span class="hs-identifier hs-var">sequenceId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1022"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName
-&gt; SequenceIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-var">sequenceIdToPgCatalogNames</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143263"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679143268"><span class="hs-identifier hs-var">sequenceId</span></a></span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-type">tableIdToPgCatalogNames</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1025"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1026"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#TableIdentifier"><span class="hs-identifier hs-type">Orville.TableIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1027"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#RelationName"><span class="hs-identifier hs-type">PgCatalog.RelationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1028"></span><span id="tableIdToPgCatalogNames"><span class="annot"><span class="annottext">tableIdToPgCatalogNames :: NamespaceName -&gt; TableIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#tableIdToPgCatalogNames"><span class="hs-identifier hs-var hs-var">tableIdToPgCatalogNames</span></a></span></span><span> </span><span id="local-6989586621679143269"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143269"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143270"><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143270"><span class="hs-identifier hs-var">tableId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1029"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-1030"></span><span>    </span><span id="local-6989586621679143271"><span class="annot"><span class="annottext">actualNamespace :: NamespaceName
</span><a href="#local-6989586621679143271"><span class="hs-identifier hs-var hs-var">actualNamespace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1031"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName
-&gt; (String -&gt; NamespaceName) -&gt; Maybe String -&gt; NamespaceName
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143269"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; NamespaceName
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">String.fromString</span></span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><span class="annottext">(Maybe String -&gt; NamespaceName)
-&gt; (TableIdentifier -&gt; Maybe String)
-&gt; TableIdentifier
-&gt; NamespaceName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier -&gt; Maybe String
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdSchemaNameString"><span class="hs-identifier hs-var">Orville.tableIdSchemaNameString</span></a></span><span>
</span><span id="line-1033"></span><span>        </span><span class="annot"><span class="annottext">(TableIdentifier -&gt; NamespaceName)
-&gt; TableIdentifier -&gt; NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143270"><span class="hs-identifier hs-var">tableId</span></a></span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span>    </span><span id="local-6989586621679143273"><span class="annot"><span class="annottext">relationName :: RelationName
</span><a href="#local-6989586621679143273"><span class="hs-identifier hs-var hs-var">relationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1036"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; RelationName
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">String.fromString</span></span><span>
</span><span id="line-1037"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; RelationName)
-&gt; (TableIdentifier -&gt; String) -&gt; TableIdentifier -&gt; RelationName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.TableIdentifier.html#tableIdUnqualifiedNameString"><span class="hs-identifier hs-var">Orville.tableIdUnqualifiedNameString</span></a></span><span>
</span><span id="line-1038"></span><span>        </span><span class="annot"><span class="annottext">(TableIdentifier -&gt; RelationName)
-&gt; TableIdentifier -&gt; RelationName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableIdentifier
</span><a href="#local-6989586621679143270"><span class="hs-identifier hs-var">tableId</span></a></span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-1040"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143271"><span class="hs-identifier hs-var">actualNamespace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679143273"><span class="hs-identifier hs-var">relationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterSequenceSteps"><span class="hs-identifier hs-type">mkAlterSequenceSteps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1043"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#SequenceDefinition"><span class="hs-identifier hs-type">Orville.SequenceDefinition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1044"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#PgSequence"><span class="hs-identifier hs-type">PgCatalog.PgSequence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1045"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#MigrationStepWithType"><span class="hs-identifier hs-type">MigrationStepWithType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1046"></span><span id="mkAlterSequenceSteps"><span class="annot"><span class="annottext">mkAlterSequenceSteps :: SequenceDefinition -&gt; PgSequence -&gt; [MigrationStepWithType]
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkAlterSequenceSteps"><span class="hs-identifier hs-var hs-var">mkAlterSequenceSteps</span></a></span></span><span> </span><span id="local-6989586621679143275"><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143275"><span class="hs-identifier hs-var">sequenceDef</span></a></span></span><span> </span><span id="local-6989586621679143276"><span class="annot"><span class="annottext">PgSequence
</span><a href="#local-6989586621679143276"><span class="hs-identifier hs-var">pgSequence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1047"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-1048"></span><span>    </span><span id="local-6989586621679142625"><span id="local-6989586621679142626"><span class="annot"><a href="#local-6989586621679143277"><span class="hs-identifier hs-type">ifChanged</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1049"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679142625"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1050"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679142625"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142626"><span class="hs-identifier hs-type">expr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1051"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#PgSequence"><span class="hs-identifier hs-type">PgCatalog.PgSequence</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142625"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1052"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#SequenceDefinition"><span class="hs-identifier hs-type">Orville.SequenceDefinition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142625"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1053"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679142626"><span class="hs-identifier hs-type">expr</span></a></span></span></span><span>
</span><span id="line-1054"></span><span>    </span><span id="local-6989586621679143277"><span class="annot"><span class="annottext">ifChanged :: forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var hs-var">ifChanged</span></a></span></span><span> </span><span id="local-6989586621679143280"><span class="annot"><span class="annottext">a -&gt; expr
</span><a href="#local-6989586621679143280"><span class="hs-identifier hs-var">mkChange</span></a></span></span><span> </span><span id="local-6989586621679143281"><span class="annot"><span class="annottext">PgSequence -&gt; a
</span><a href="#local-6989586621679143281"><span class="hs-identifier hs-var">getOld</span></a></span></span><span> </span><span id="local-6989586621679143282"><span class="annot"><span class="annottext">SequenceDefinition -&gt; a
</span><a href="#local-6989586621679143282"><span class="hs-identifier hs-var">getNew</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1055"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; a
</span><a href="#local-6989586621679143281"><span class="hs-identifier hs-var">getOld</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence
</span><a href="#local-6989586621679143276"><span class="hs-identifier hs-var">pgSequence</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; a
</span><a href="#local-6989586621679143282"><span class="hs-identifier hs-var">getNew</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143275"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span>
</span><span id="line-1056"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe expr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1057"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">expr -&gt; Maybe expr
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(expr -&gt; Maybe expr)
-&gt; (SequenceDefinition -&gt; expr) -&gt; SequenceDefinition -&gt; Maybe expr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; expr
</span><a href="#local-6989586621679143280"><span class="hs-identifier hs-var">mkChange</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; expr)
-&gt; (SequenceDefinition -&gt; a) -&gt; SequenceDefinition -&gt; expr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; a
</span><a href="#local-6989586621679143282"><span class="hs-identifier hs-var">getNew</span></a></span><span> </span><span class="annot"><span class="annottext">(SequenceDefinition -&gt; Maybe expr)
-&gt; SequenceDefinition -&gt; Maybe expr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143275"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span>
</span><span id="line-1058"></span><span>
</span><span id="line-1059"></span><span>    </span><span id="local-6989586621679143285"><span class="annot"><span class="annottext">mbIncrementByExpr :: Maybe IncrementByExpr
</span><a href="#local-6989586621679143285"><span class="hs-identifier hs-var hs-var">mbIncrementByExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1060"></span><span>      </span><span class="annot"><span class="annottext">(Int64 -&gt; IncrementByExpr)
-&gt; (PgSequence -&gt; Int64)
-&gt; (SequenceDefinition -&gt; Int64)
-&gt; Maybe IncrementByExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; IncrementByExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#incrementBy"><span class="hs-identifier hs-var">Expr.incrementBy</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Int64
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceIncrement"><span class="hs-identifier hs-var">PgCatalog.pgSequenceIncrement</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Int64
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceIncrement"><span class="hs-identifier hs-var">Orville.sequenceIncrement</span></a></span><span>
</span><span id="line-1061"></span><span>
</span><span id="line-1062"></span><span>    </span><span id="local-6989586621679143290"><span class="annot"><span class="annottext">mbMinValueExpr :: Maybe MinValueExpr
</span><a href="#local-6989586621679143290"><span class="hs-identifier hs-var hs-var">mbMinValueExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1063"></span><span>      </span><span class="annot"><span class="annottext">(Int64 -&gt; MinValueExpr)
-&gt; (PgSequence -&gt; Int64)
-&gt; (SequenceDefinition -&gt; Int64)
-&gt; Maybe MinValueExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; MinValueExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#minValue"><span class="hs-identifier hs-var">Expr.minValue</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Int64
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceMin"><span class="hs-identifier hs-var">PgCatalog.pgSequenceMin</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Int64
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceMinValue"><span class="hs-identifier hs-var">Orville.sequenceMinValue</span></a></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span>    </span><span id="local-6989586621679143295"><span class="annot"><span class="annottext">mbMaxValueExpr :: Maybe MaxValueExpr
</span><a href="#local-6989586621679143295"><span class="hs-identifier hs-var hs-var">mbMaxValueExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1066"></span><span>      </span><span class="annot"><span class="annottext">(Int64 -&gt; MaxValueExpr)
-&gt; (PgSequence -&gt; Int64)
-&gt; (SequenceDefinition -&gt; Int64)
-&gt; Maybe MaxValueExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; MaxValueExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#maxValue"><span class="hs-identifier hs-var">Expr.maxValue</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Int64
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceMax"><span class="hs-identifier hs-var">PgCatalog.pgSequenceMax</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Int64
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceMaxValue"><span class="hs-identifier hs-var">Orville.sequenceMaxValue</span></a></span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span>    </span><span id="local-6989586621679143300"><span class="annot"><span class="annottext">mbStartWithExpr :: Maybe StartWithExpr
</span><a href="#local-6989586621679143300"><span class="hs-identifier hs-var hs-var">mbStartWithExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1069"></span><span>      </span><span class="annot"><span class="annottext">(Int64 -&gt; StartWithExpr)
-&gt; (PgSequence -&gt; Int64)
-&gt; (SequenceDefinition -&gt; Int64)
-&gt; Maybe StartWithExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; StartWithExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#startWith"><span class="hs-identifier hs-var">Expr.startWith</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Int64
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceStart"><span class="hs-identifier hs-var">PgCatalog.pgSequenceStart</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Int64
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceStart"><span class="hs-identifier hs-var">Orville.sequenceStart</span></a></span><span>
</span><span id="line-1070"></span><span>
</span><span id="line-1071"></span><span>    </span><span id="local-6989586621679143305"><span class="annot"><span class="annottext">mbCacheExpr :: Maybe CacheExpr
</span><a href="#local-6989586621679143305"><span class="hs-identifier hs-var hs-var">mbCacheExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1072"></span><span>      </span><span class="annot"><span class="annottext">(Int64 -&gt; CacheExpr)
-&gt; (PgSequence -&gt; Int64)
-&gt; (SequenceDefinition -&gt; Int64)
-&gt; Maybe CacheExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; CacheExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#cache"><span class="hs-identifier hs-var">Expr.cache</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Int64
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceCache"><span class="hs-identifier hs-var">PgCatalog.pgSequenceCache</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Int64
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceCache"><span class="hs-identifier hs-var">Orville.sequenceCache</span></a></span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span>    </span><span id="local-6989586621679143310"><span class="annot"><span class="annottext">mbCycleExpr :: Maybe CycleExpr
</span><a href="#local-6989586621679143310"><span class="hs-identifier hs-var hs-var">mbCycleExpr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1075"></span><span>      </span><span class="annot"><span class="annottext">(Bool -&gt; CycleExpr)
-&gt; (PgSequence -&gt; Bool)
-&gt; (SequenceDefinition -&gt; Bool)
-&gt; Maybe CycleExpr
forall a expr.
Eq a =&gt;
(a -&gt; expr)
-&gt; (PgSequence -&gt; a) -&gt; (SequenceDefinition -&gt; a) -&gt; Maybe expr
</span><a href="#local-6989586621679143277"><span class="hs-identifier hs-var">ifChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; CycleExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#cycleIfTrue"><span class="hs-identifier hs-var">Expr.cycleIfTrue</span></a></span><span> </span><span class="annot"><span class="annottext">PgSequence -&gt; Bool
</span><a href="Orville.PostgreSQL.PgCatalog.PgSequence.html#pgSequenceCycle"><span class="hs-identifier hs-var">PgCatalog.pgSequenceCycle</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Bool
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceCycle"><span class="hs-identifier hs-var">Orville.sequenceCycle</span></a></span><span>
</span><span id="line-1076"></span><span>
</span><span id="line-1077"></span><span>    </span><span id="local-6989586621679142635"><span id="local-6989586621679142636"><span class="annot"><a href="#local-6989586621679143314"><span class="hs-identifier hs-type">applyChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679142635"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679142635"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679142636"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1078"></span><span>    </span><span id="local-6989586621679143314"><span class="annot"><span class="annottext">applyChange :: forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-identifier hs-var hs-var">applyChange</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679143315"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143315"><span class="hs-identifier hs-var">changed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679143316"><span class="annot"><span class="annottext">Maybe a -&gt; b
</span><a href="#local-6989586621679143316"><span class="hs-identifier hs-var">exprF</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679143317"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679143317"><span class="hs-identifier hs-var">mbArg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1079"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143315"><span class="hs-identifier hs-var">changed</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">Maybe.isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679143317"><span class="hs-identifier hs-var">mbArg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; b
</span><a href="#local-6989586621679143316"><span class="hs-identifier hs-var">exprF</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679143317"><span class="hs-identifier hs-var">mbArg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1080"></span><span>
</span><span id="line-1081"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679143319"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143319"><span class="hs-identifier hs-var">anyChanges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679143320"><span class="annot"><span class="annottext">AlterSequenceExpr
</span><a href="#local-6989586621679143320"><span class="hs-identifier hs-var">migrateSequenceExpr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1082"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Qualified SequenceName
-&gt; Maybe IncrementByExpr
-&gt; Maybe MinValueExpr
-&gt; Maybe MaxValueExpr
-&gt; Maybe StartWithExpr
-&gt; Maybe CacheExpr
-&gt; Maybe CycleExpr
-&gt; AlterSequenceExpr
</span><a href="Orville.PostgreSQL.Expr.SequenceDefinition.html#alterSequenceExpr"><span class="hs-identifier hs-var">Expr.alterSequenceExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SequenceDefinition -&gt; Qualified SequenceName
</span><a href="Orville.PostgreSQL.Schema.SequenceDefinition.html#sequenceName"><span class="hs-identifier hs-var">Orville.sequenceName</span></a></span><span> </span><span class="annot"><span class="annottext">SequenceDefinition
</span><a href="#local-6989586621679143275"><span class="hs-identifier hs-var">sequenceDef</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1083"></span><span>        </span><span class="annot"><span class="annottext">(Bool,
 Maybe IncrementByExpr
 -&gt; Maybe MinValueExpr
 -&gt; Maybe MaxValueExpr
 -&gt; Maybe StartWithExpr
 -&gt; Maybe CacheExpr
 -&gt; Maybe CycleExpr
 -&gt; AlterSequenceExpr)
-&gt; Maybe IncrementByExpr
-&gt; (Bool,
    Maybe MinValueExpr
    -&gt; Maybe MaxValueExpr
    -&gt; Maybe StartWithExpr
    -&gt; Maybe CacheExpr
    -&gt; Maybe CycleExpr
    -&gt; AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe IncrementByExpr
</span><a href="#local-6989586621679143285"><span class="hs-identifier hs-var">mbIncrementByExpr</span></a></span><span>
</span><span id="line-1084"></span><span>        </span><span class="annot"><span class="annottext">(Bool,
 Maybe MinValueExpr
 -&gt; Maybe MaxValueExpr
 -&gt; Maybe StartWithExpr
 -&gt; Maybe CacheExpr
 -&gt; Maybe CycleExpr
 -&gt; AlterSequenceExpr)
-&gt; Maybe MinValueExpr
-&gt; (Bool,
    Maybe MaxValueExpr
    -&gt; Maybe StartWithExpr
    -&gt; Maybe CacheExpr
    -&gt; Maybe CycleExpr
    -&gt; AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MinValueExpr
</span><a href="#local-6989586621679143290"><span class="hs-identifier hs-var">mbMinValueExpr</span></a></span><span>
</span><span id="line-1085"></span><span>        </span><span class="annot"><span class="annottext">(Bool,
 Maybe MaxValueExpr
 -&gt; Maybe StartWithExpr
 -&gt; Maybe CacheExpr
 -&gt; Maybe CycleExpr
 -&gt; AlterSequenceExpr)
-&gt; Maybe MaxValueExpr
-&gt; (Bool,
    Maybe StartWithExpr
    -&gt; Maybe CacheExpr -&gt; Maybe CycleExpr -&gt; AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MaxValueExpr
</span><a href="#local-6989586621679143295"><span class="hs-identifier hs-var">mbMaxValueExpr</span></a></span><span>
</span><span id="line-1086"></span><span>        </span><span class="annot"><span class="annottext">(Bool,
 Maybe StartWithExpr
 -&gt; Maybe CacheExpr -&gt; Maybe CycleExpr -&gt; AlterSequenceExpr)
-&gt; Maybe StartWithExpr
-&gt; (Bool, Maybe CacheExpr -&gt; Maybe CycleExpr -&gt; AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StartWithExpr
</span><a href="#local-6989586621679143300"><span class="hs-identifier hs-var">mbStartWithExpr</span></a></span><span>
</span><span id="line-1087"></span><span>        </span><span class="annot"><span class="annottext">(Bool, Maybe CacheExpr -&gt; Maybe CycleExpr -&gt; AlterSequenceExpr)
-&gt; Maybe CacheExpr -&gt; (Bool, Maybe CycleExpr -&gt; AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CacheExpr
</span><a href="#local-6989586621679143305"><span class="hs-identifier hs-var">mbCacheExpr</span></a></span><span>
</span><span id="line-1088"></span><span>        </span><span class="annot"><span class="annottext">(Bool, Maybe CycleExpr -&gt; AlterSequenceExpr)
-&gt; Maybe CycleExpr -&gt; (Bool, AlterSequenceExpr)
forall a b. (Bool, Maybe a -&gt; b) -&gt; Maybe a -&gt; (Bool, b)
</span><a href="#local-6989586621679143314"><span class="hs-operator hs-var">`applyChange`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CycleExpr
</span><a href="#local-6989586621679143310"><span class="hs-identifier hs-var">mbCycleExpr</span></a></span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-1090"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679143319"><span class="hs-identifier hs-var">anyChanges</span></a></span><span>
</span><span id="line-1091"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">StepType -&gt; AlterSequenceExpr -&gt; MigrationStepWithType
forall sql.
SqlExpression sql =&gt;
StepType -&gt; sql -&gt; MigrationStepWithType
</span><a href="Orville.PostgreSQL.AutoMigration.html#mkMigrationStepWithType"><span class="hs-identifier hs-var">mkMigrationStepWithType</span></a></span><span> </span><span class="annot"><span class="annottext">StepType
</span><a href="Orville.PostgreSQL.AutoMigration.html#AddRemoveTablesAndColumns"><span class="hs-identifier hs-var">AddRemoveTablesAndColumns</span></a></span><span> </span><span class="annot"><span class="annottext">AlterSequenceExpr
</span><a href="#local-6989586621679143320"><span class="hs-identifier hs-var">migrateSequenceExpr</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1092"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-type">sequenceIdToPgCatalogNames</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1095"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1096"></span><span>  </span><span class="annot"><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#SequenceIdentifier"><span class="hs-identifier hs-type">Orville.SequenceIdentifier</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgClass.html#RelationName"><span class="hs-identifier hs-type">PgCatalog.RelationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span id="sequenceIdToPgCatalogNames"><span class="annot"><span class="annottext">sequenceIdToPgCatalogNames :: NamespaceName
-&gt; SequenceIdentifier -&gt; (NamespaceName, RelationName)
</span><a href="Orville.PostgreSQL.AutoMigration.html#sequenceIdToPgCatalogNames"><span class="hs-identifier hs-var hs-var">sequenceIdToPgCatalogNames</span></a></span></span><span> </span><span id="local-6989586621679143323"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143323"><span class="hs-identifier hs-var">currentNamespace</span></a></span></span><span> </span><span id="local-6989586621679143324"><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679143324"><span class="hs-identifier hs-var">sequenceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1099"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-1100"></span><span>    </span><span id="local-6989586621679143325"><span class="annot"><span class="annottext">actualNamespace :: NamespaceName
</span><a href="#local-6989586621679143325"><span class="hs-identifier hs-var hs-var">actualNamespace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1101"></span><span>      </span><span class="annot"><span class="annottext">NamespaceName
-&gt; (String -&gt; NamespaceName) -&gt; Maybe String -&gt; NamespaceName
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143323"><span class="hs-identifier hs-var">currentNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; NamespaceName
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">String.fromString</span></span><span>
</span><span id="line-1102"></span><span>        </span><span class="annot"><span class="annottext">(Maybe String -&gt; NamespaceName)
-&gt; (SequenceIdentifier -&gt; Maybe String)
-&gt; SequenceIdentifier
-&gt; NamespaceName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier -&gt; Maybe String
</span><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#sequenceIdSchemaNameString"><span class="hs-identifier hs-var">Orville.sequenceIdSchemaNameString</span></a></span><span>
</span><span id="line-1103"></span><span>        </span><span class="annot"><span class="annottext">(SequenceIdentifier -&gt; NamespaceName)
-&gt; SequenceIdentifier -&gt; NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679143324"><span class="hs-identifier hs-var">sequenceId</span></a></span><span>
</span><span id="line-1104"></span><span>
</span><span id="line-1105"></span><span>    </span><span id="local-6989586621679143327"><span class="annot"><span class="annottext">relationName :: RelationName
</span><a href="#local-6989586621679143327"><span class="hs-identifier hs-var hs-var">relationName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1106"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; RelationName
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">String.fromString</span></span><span>
</span><span id="line-1107"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; RelationName)
-&gt; (SequenceIdentifier -&gt; String)
-&gt; SequenceIdentifier
-&gt; RelationName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier -&gt; String
</span><a href="Orville.PostgreSQL.Schema.SequenceIdentifier.html#sequenceIdUnqualifiedNameString"><span class="hs-identifier hs-var">Orville.sequenceIdUnqualifiedNameString</span></a></span><span>
</span><span id="line-1108"></span><span>        </span><span class="annot"><span class="annottext">(SequenceIdentifier -&gt; RelationName)
-&gt; SequenceIdentifier -&gt; RelationName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SequenceIdentifier
</span><a href="#local-6989586621679143324"><span class="hs-identifier hs-var">sequenceId</span></a></span><span>
</span><span id="line-1109"></span><span>  </span><span class="hs-keyword">in</span><span>
</span><span id="line-1110"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143325"><span class="hs-identifier hs-var">actualNamespace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RelationName
</span><a href="#local-6989586621679143327"><span class="hs-identifier hs-var">relationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1111"></span><span>
</span><span id="line-1112"></span><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#currentNamespaceQuery"><span class="hs-identifier hs-type">currentNamespaceQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Expr.Query.html#QueryExpr"><span class="hs-identifier hs-type">Expr.QueryExpr</span></a></span><span>
</span><span id="line-1113"></span><span id="currentNamespaceQuery"><span class="annot"><span class="annottext">currentNamespaceQuery :: QueryExpr
</span><a href="Orville.PostgreSQL.AutoMigration.html#currentNamespaceQuery"><span class="hs-identifier hs-var hs-var">currentNamespaceQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1114"></span><span>  </span><span class="annot"><span class="annottext">SelectClause -&gt; SelectList -&gt; Maybe TableExpr -&gt; QueryExpr
</span><a href="Orville.PostgreSQL.Expr.Query.html#queryExpr"><span class="hs-identifier hs-var">Expr.queryExpr</span></a></span><span>
</span><span id="line-1115"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SelectExpr -&gt; SelectClause
</span><a href="Orville.PostgreSQL.Expr.Select.html#selectClause"><span class="hs-identifier hs-var">Expr.selectClause</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Distinct -&gt; SelectExpr
</span><a href="Orville.PostgreSQL.Expr.Select.html#selectExpr"><span class="hs-identifier hs-var">Expr.selectExpr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Distinct
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[DerivedColumn] -&gt; SelectList
</span><a href="Orville.PostgreSQL.Expr.Query.html#selectDerivedColumns"><span class="hs-identifier hs-var">Expr.selectDerivedColumns</span></a></span><span>
</span><span id="line-1117"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ValueExpression -&gt; ColumnName -&gt; DerivedColumn
</span><a href="Orville.PostgreSQL.Expr.Query.html#deriveColumnAs"><span class="hs-identifier hs-var">Expr.deriveColumnAs</span></a></span><span>
</span><span id="line-1118"></span><span>            </span><span class="hs-comment">-- current_schema is a special reserved word in postgresql. If you</span><span>
</span><span id="line-1119"></span><span>            </span><span class="hs-comment">-- put it in quotes it tries to treat it as a regular column name,</span><span>
</span><span id="line-1120"></span><span>            </span><span class="hs-comment">-- which then can't be found as a column in the query.</span><span>
</span><span id="line-1121"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ValueExpression
forall a. SqlExpression a =&gt; String -&gt; a
</span><a href="Orville.PostgreSQL.Raw.RawSql.html#unsafeSqlExpression"><span class="hs-identifier hs-var">RawSql.unsafeSqlExpression</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;current_schema&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1122"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FieldDefinition NotNull NamespaceName -&gt; ColumnName
forall nullability a. FieldDefinition nullability a -&gt; ColumnName
</span><a href="Orville.PostgreSQL.Marshall.FieldDefinition.html#fieldColumnName"><span class="hs-identifier hs-var">Orville.fieldColumnName</span></a></span><span> </span><span class="annot"><span class="annottext">FieldDefinition NotNull NamespaceName
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#namespaceNameField"><span class="hs-identifier hs-var">PgCatalog.namespaceNameField</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-1124"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>    </span><span class="annot"><span class="annottext">Maybe TableExpr
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span id="local-6989586621679142427"><span class="annot"><a href="Orville.PostgreSQL.AutoMigration.html#findCurrentNamespace"><span class="hs-identifier hs-type">findCurrentNamespace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Orville.PostgreSQL.Monad.MonadOrville.html#MonadOrville"><span class="hs-identifier hs-type">Orville.MonadOrville</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679142427"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679142427"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#NamespaceName"><span class="hs-identifier hs-type">PgCatalog.NamespaceName</span></a></span></span><span>
</span><span id="line-1128"></span><span id="findCurrentNamespace"><span class="annot"><span class="annottext">findCurrentNamespace :: forall (m :: * -&gt; *). MonadOrville m =&gt; m NamespaceName
</span><a href="Orville.PostgreSQL.AutoMigration.html#findCurrentNamespace"><span class="hs-identifier hs-var hs-var">findCurrentNamespace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1129"></span><span>  </span><span id="local-6989586621679143351"><span class="annot"><span class="annottext">[NamespaceName]
</span><a href="#local-6989586621679143351"><span class="hs-identifier hs-var">results</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1130"></span><span>    </span><span class="annot"><span class="annottext">QueryType
-&gt; QueryExpr
-&gt; AnnotatedSqlMarshaller NamespaceName NamespaceName
-&gt; m [NamespaceName]
forall (m :: * -&gt; *) sql writeEntity readEntity.
(MonadOrville m, SqlExpression sql) =&gt;
QueryType
-&gt; sql
-&gt; AnnotatedSqlMarshaller writeEntity readEntity
-&gt; m [readEntity]
</span><a href="Orville.PostgreSQL.Execution.Execute.html#executeAndDecode"><span class="hs-identifier hs-var">Orville.executeAndDecode</span></a></span><span>
</span><span id="line-1131"></span><span>      </span><span class="annot"><span class="annottext">QueryType
</span><a href="Orville.PostgreSQL.Execution.QueryType.html#SelectQuery"><span class="hs-identifier hs-var">Orville.SelectQuery</span></a></span><span>
</span><span id="line-1132"></span><span>      </span><span class="annot"><span class="annottext">QueryExpr
</span><a href="Orville.PostgreSQL.AutoMigration.html#currentNamespaceQuery"><span class="hs-identifier hs-var">currentNamespaceQuery</span></a></span><span>
</span><span id="line-1133"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SqlMarshaller NamespaceName NamespaceName
-&gt; AnnotatedSqlMarshaller NamespaceName NamespaceName
forall writeEntity readEntity.
SqlMarshaller writeEntity readEntity
-&gt; AnnotatedSqlMarshaller writeEntity readEntity
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#annotateSqlMarshallerEmptyAnnotation"><span class="hs-identifier hs-var">Orville.annotateSqlMarshallerEmptyAnnotation</span></a></span><span> </span><span class="annot"><span class="annottext">(SqlMarshaller NamespaceName NamespaceName
 -&gt; AnnotatedSqlMarshaller NamespaceName NamespaceName)
-&gt; SqlMarshaller NamespaceName NamespaceName
-&gt; AnnotatedSqlMarshaller NamespaceName NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(NamespaceName -&gt; NamespaceName)
-&gt; FieldDefinition NotNull NamespaceName
-&gt; SqlMarshaller NamespaceName NamespaceName
forall writeEntity fieldValue nullability.
(writeEntity -&gt; fieldValue)
-&gt; FieldDefinition nullability fieldValue
-&gt; SqlMarshaller writeEntity fieldValue
</span><a href="Orville.PostgreSQL.Marshall.SqlMarshaller.html#marshallField"><span class="hs-identifier hs-var">Orville.marshallField</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceName -&gt; NamespaceName
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">FieldDefinition NotNull NamespaceName
</span><a href="Orville.PostgreSQL.PgCatalog.PgNamespace.html#namespaceNameField"><span class="hs-identifier hs-var">PgCatalog.namespaceNameField</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span>
</span><span id="line-1135"></span><span>  </span><span class="annot"><span class="annottext">IO NamespaceName -&gt; m NamespaceName
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO NamespaceName -&gt; m NamespaceName)
-&gt; IO NamespaceName -&gt; m NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1136"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[NamespaceName]
</span><a href="#local-6989586621679143351"><span class="hs-identifier hs-var">results</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1137"></span><span>      </span><span class="hs-special">[</span><span id="local-6989586621679143357"><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143357"><span class="hs-identifier hs-var">schemaAndCatalog</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1138"></span><span>        </span><span class="annot"><span class="annottext">NamespaceName -&gt; IO NamespaceName
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">NamespaceName
</span><a href="#local-6989586621679143357"><span class="hs-identifier hs-var">schemaAndCatalog</span></a></span><span>
</span><span id="line-1139"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1140"></span><span>        </span><span class="annot"><span class="annottext">MigrationDataError -&gt; IO NamespaceName
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(MigrationDataError -&gt; IO NamespaceName)
-&gt; MigrationDataError -&gt; IO NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; MigrationDataError
</span><a href="Orville.PostgreSQL.AutoMigration.html#UnableToDiscoverCurrentSchema"><span class="hs-identifier hs-var">UnableToDiscoverCurrentSchema</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No results returned by current_schema query&quot;</span></span><span>
</span><span id="line-1141"></span><span>      </span><span class="annot"><span class="annottext">[NamespaceName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1142"></span><span>        </span><span class="annot"><span class="annottext">MigrationDataError -&gt; IO NamespaceName
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(MigrationDataError -&gt; IO NamespaceName)
-&gt; MigrationDataError -&gt; IO NamespaceName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; MigrationDataError
</span><a href="Orville.PostgreSQL.AutoMigration.html#UnableToDiscoverCurrentSchema"><span class="hs-identifier hs-var">UnableToDiscoverCurrentSchema</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Multiple results returned by current_schema query&quot;</span></span><span>
</span><span id="line-1143"></span></pre></body></html>