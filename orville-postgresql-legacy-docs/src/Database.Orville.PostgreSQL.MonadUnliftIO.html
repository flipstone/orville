<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.PostgreSQL.Internal.Monad
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT

'Database.Orville.PostgreSQL.MonadUnliftIO' provides functions and instances for using
'MonadOrville' and 'OrvilleT' for Monad transformer stacks that are using
'MonadUnliftIO'.  The most common way to do this is simply to add the
following 'MonadOrvilleControl' instance:

@
 instance MonadOrvilleControl MyMonad where
   liftWithConnection = liftWithConnectionViaUnliftIO
   liftFinally = liftFinallyViaUnliftIO
@

This module also provides a 'MonadUnliftIO' instance for 'OrvilleT' and 'OrvilleTrigger'.
|-}</span><span>
</span><a name="line-19"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-20"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.MonadUnliftIO</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Database.Orville.PostgreSQL.MonadUnliftIO.html#liftWithConnectionViaUnliftIO"><span class="hs-identifier hs-var">liftWithConnectionViaUnliftIO</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.MonadUnliftIO.html#liftFinallyViaUnliftIO"><span class="hs-identifier hs-var">liftFinallyViaUnliftIO</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.IO.Unlift</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">UL</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.html"><span class="hs-identifier">Database.Orville.PostgreSQL</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">O</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">InternalMonad</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Trigger</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">InternalTrigger</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Trigger.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Trigger</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">OT</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">{-|
   liftWithConnectionViaUnliftIO can be use as the implementation of
   'liftWithConnection' for 'MonadOrvilleControl' when the 'Monad'
   implements 'MonadUnliftIO'.
 |-}</span><span>
</span><a name="line-39"></a><span class="hs-identifier">liftWithConnectionViaUnliftIO</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-40"></a><span>     </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><a href="#local-6989586621679151994"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679151997"><a href="#local-6989586621679151997"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679151995"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679151997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679151997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679151995"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151994"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679151996"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151994"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679151996"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-44"></a><a name="liftWithConnectionViaUnliftIO"><a href="Database.Orville.PostgreSQL.MonadUnliftIO.html#liftWithConnectionViaUnliftIO"><span class="hs-identifier">liftWithConnectionViaUnliftIO</span></a></a><span> </span><a name="local-6989586621679151998"><a href="#local-6989586621679151998"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><a name="local-6989586621679151999"><a href="#local-6989586621679151999"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-identifier hs-var">UL.withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679152000"><a href="#local-6989586621679152000"><span class="hs-identifier">runInIO</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151998"><span class="hs-identifier hs-var">ioWithConn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679152000"><span class="hs-identifier hs-var">runInIO</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679151999"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">{-|
   liftFinallyViaUnliftIO can be use as the implementation of
   'liftFinally' for 'MonadOrvilleControl' when the 'Monad'
   implements 'MonadUnliftIO'.
 |-}</span><span>
</span><a name="line-52"></a><span class="hs-identifier">liftFinallyViaUnliftIO</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-53"></a><span>     </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><a href="#local-6989586621679151989"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679151992"><a href="#local-6989586621679151992"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679151993"><a href="#local-6989586621679151993"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679151992"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679151993"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679151992"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151989"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679151990"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151989"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679151991"><span class="hs-identifier hs-type">d</span></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679151989"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679151990"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-58"></a><a name="liftFinallyViaUnliftIO"><a href="Database.Orville.PostgreSQL.MonadUnliftIO.html#liftFinallyViaUnliftIO"><span class="hs-identifier">liftFinallyViaUnliftIO</span></a></a><span> </span><a name="local-6989586621679152001"><a href="#local-6989586621679152001"><span class="hs-identifier">ioFinally</span></a></a><span> </span><a name="local-6989586621679152002"><a href="#local-6989586621679152002"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679152003"><a href="#local-6989586621679152003"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-59"></a><span>  </span><a name="local-6989586621679152004"><a href="#local-6989586621679152004"><span class="hs-identifier">unlio</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">UL.askUnliftIO</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier hs-var">UL.liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679152001"><span class="hs-identifier hs-var">ioFinally</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">UL.unliftIO</span><span> </span><a href="#local-6989586621679152004"><span class="hs-identifier hs-var">unlio</span></a><span> </span><a href="#local-6989586621679152002"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">UL.unliftIO</span><span> </span><a href="#local-6989586621679152004"><span class="hs-identifier hs-var">unlio</span></a><span> </span><a href="#local-6989586621679152003"><span class="hs-identifier hs-var">cleanup</span></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><a href="#local-6989586621679151986"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">O.OrvilleT</span></a><span> </span><a href="#local-6989586621679151987"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679151986"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-63"></a><span class="hs-cpp">#if MIN_VERSION_unliftio_core(0,2,0)
</span><span>  </span><span class="hs-identifier">withRunInIO</span><span> </span><span class="hs-identifier">inner</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-65"></a><span>    </span><span class="hs-identifier">InternalMonad.OrvilleT</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-66"></a><span>      </span><span class="hs-identifier">UL.withRunInIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-identifier">inner</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">run</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">InternalMonad.unOrvilleT</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-cpp">#else
</span><span>  </span><a name="local-8214565720323889965"><span class="hs-identifier">askUnliftIO</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-70"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">InternalMonad.OrvilleT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>      </span><a name="local-6989586621679151988"><a href="#local-6989586621679151988"><span class="hs-identifier">unlio</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">UL.askUnliftIO</span><span>
</span><a name="line-72"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">UL.UnliftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">UL.unliftIO</span><span> </span><a href="#local-6989586621679151988"><span class="hs-identifier hs-var">unlio</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">InternalMonad.unOrvilleT</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-75"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><a href="#local-6989586621679151982"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-76"></a><span>         </span><span class="hs-identifier hs-type">UL.MonadUnliftIO</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OT.OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679151983"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679151984"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679151982"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-77"></a><span class="hs-cpp">#if MIN_VERSION_unliftio_core(0,2,0)
</span><span>  </span><span class="hs-identifier">withRunInIO</span><span> </span><span class="hs-identifier">inner</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier">InternalTrigger.OrvilleTriggerT</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-80"></a><span>      </span><span class="hs-identifier">UL.withRunInIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-81"></a><span>        </span><span class="hs-identifier">inner</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">run</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">InternalTrigger.unTriggerT</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-cpp">#else
</span><span>  </span><a name="local-8214565720323889965"><span class="hs-identifier">askUnliftIO</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">InternalTrigger.OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>      </span><a name="local-6989586621679151985"><a href="#local-6989586621679151985"><span class="hs-identifier">unlio</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">UL.askUnliftIO</span><span>
</span><a name="line-86"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">UL.UnliftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">UL.unliftIO</span><span> </span><a href="#local-6989586621679151985"><span class="hs-identifier hs-var">unlio</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">InternalTrigger.unTriggerT</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-cpp">#endif
</span></pre></body></html>