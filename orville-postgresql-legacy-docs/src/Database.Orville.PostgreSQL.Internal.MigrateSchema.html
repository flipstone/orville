<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.PostgreSQL.Internal.MigrateSchema
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT
-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrateSchema</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#migrateSchema"><span class="hs-identifier hs-var">migrateSchema</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#generateMigrationPlan"><span class="hs-identifier hs-var">generateMigrationPlan</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#createIndexesConcurrently"><span class="hs-identifier hs-var">createIndexesConcurrently</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#dropIndexesConcurrently"><span class="hs-identifier hs-var">dropIndexesConcurrently</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exc</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Int</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.String</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MappendCompat.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MappendCompat</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Execute.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Execute</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Expr.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Expr</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.FromClause.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.FromClause</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.FromSql.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.FromSql</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateConstraint.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrateConstraint</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateIndex.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrateIndex</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSequence.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrateSequence</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateTable.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrateTable</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationError.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrationError</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MigrationPlan</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SchemaState.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.SchemaState</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Select</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Types</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Raw.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Raw</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Select</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">orvilleLockScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-46"></a><a name="orvilleLockScope"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier">orvilleLockScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">17772</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-identifier">migrationLockId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-49"></a><a name="migrationLockId"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier">migrationLockId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">7995632</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">tryLockExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Expr.SelectExpr.html#SelectExpr"><span class="hs-identifier hs-type">SelectExpr</span></a><span>
</span><a name="line-52"></a><a name="tryLockExpr"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#tryLockExpr"><span class="hs-identifier">tryLockExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-53"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Expr.Expr.html#rawSqlExpr"><span class="hs-identifier hs-var">rawSqlExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-54"></a><span>  </span><span class="hs-string">&quot;pg_try_advisory_xact_lock(&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier hs-var">orvilleLockScope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier hs-var">migrationLockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-56"></a><span>  </span><span class="hs-string">&quot;) as result&quot;</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-identifier">waitForLockExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Expr.SelectExpr.html#SelectExpr"><span class="hs-identifier hs-type">SelectExpr</span></a><span>
</span><a name="line-59"></a><a name="waitForLockExpr"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#waitForLockExpr"><span class="hs-identifier">waitForLockExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-60"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Expr.Expr.html#rawSqlExpr"><span class="hs-identifier hs-var">rawSqlExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-string">&quot;pg_advisory_xact_lock(&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier hs-var">orvilleLockScope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier hs-var">migrationLockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-string">&quot;) as result&quot;</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-identifier">lockResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FromSql"><span class="hs-identifier hs-type">FromSql</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-66"></a><a name="lockResult"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#lockResult"><span class="hs-identifier">lockResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.FromSql.html#col"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;result&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-identifier">withLockedTransaction</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131843"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131844"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679131844"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679131844"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679131845"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131844"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679131845"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-69"></a><a name="withLockedTransaction"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier">withLockedTransaction</span></a></a><span> </span><a name="local-6989586621679131846"><a href="#local-6989586621679131846"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-70"></a><span>  </span><a href="#local-6989586621679131847"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>    </span><a name="local-6989586621679131847"><a href="#local-6989586621679131847"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679131849"><a href="#local-6989586621679131849"><span class="hs-identifier">attempts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-73"></a><span>      </span><a name="local-6989586621679131850"><a href="#local-6989586621679131850"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679131848"><span class="hs-identifier hs-var">runWithTransaction</span></a><span>
</span><a name="line-74"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679131850"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679131851"><a href="#local-6989586621679131851"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679131851"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-77"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679131849"><span class="hs-identifier hs-var">attempts</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">25</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>            </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-79"></a><span>              </span><a href="Database.Orville.PostgreSQL.Internal.MigrationError.html#MigrationLockExcessiveRetryError"><span class="hs-identifier hs-var">MigrationLockExcessiveRetryError</span></a><span>
</span><a name="line-80"></a><span>                </span><span class="hs-string">&quot;Giving up after 25 attempts to aquire the migration lock.&quot;</span><span>
</span><a name="line-81"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">10000</span><span>
</span><a name="line-82"></a><span>          </span><a href="#local-6989586621679131847"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679131849"><span class="hs-identifier hs-var">attempts</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679131848"><a href="#local-6989586621679131848"><span class="hs-identifier">runWithTransaction</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>      </span><a href="Database.Orville.PostgreSQL.Raw.html#withTransaction"><span class="hs-identifier hs-var">withTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621679131890"><a href="#local-6989586621679131890"><span class="hs-identifier">locked</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-86"></a><span>          </span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">runSelect</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-87"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#selectQueryColumns"><span class="hs-identifier hs-var">selectQueryColumns</span></a><span> </span><span class="hs-special">[</span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#tryLockExpr"><span class="hs-identifier hs-var">tryLockExpr</span></a><span class="hs-special">]</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#lockResult"><span class="hs-identifier hs-var">lockResult</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.FromClause.html#fromClauseRaw"><span class="hs-identifier hs-var">fromClauseRaw</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-88"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679131890"><span class="hs-identifier hs-var">locked</span></a><span>
</span><a name="line-89"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679131846"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-90"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-91"></a><span>            </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-92"></a><span>              </span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">runSelect</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-93"></a><span>              </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#selectQueryColumns"><span class="hs-identifier hs-var">selectQueryColumns</span></a><span>
</span><a name="line-94"></a><span>                </span><span class="hs-special">[</span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#waitForLockExpr"><span class="hs-identifier hs-var">waitForLockExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-95"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>                </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.FromClause.html#fromClauseRaw"><span class="hs-identifier hs-var">fromClauseRaw</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>                </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-98"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">{-|
   Migration Guide: @migrateSchema@ has been renamed to @autoMigrateSchema@

   migrateSchema will attempt to make changes to the actual database schema
   that it it matches the provided SchemaDefinition. Unsafe migrations such as
   dropping tables or columns are never attempted unless the SchemaDefinition
   explicitly states that the items are safe to drop. Column types may be changed,
   but will fail if the database cannot successfully make the request type change.
  -}</span><span>
</span><a name="line-109"></a><span class="hs-identifier">migrateSchema</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131841"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131842"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131842"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><a name="migrateSchema"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#migrateSchema"><span class="hs-identifier">migrateSchema</span></a></a><span> </span><a name="local-6989586621679131891"><a href="#local-6989586621679131891"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-111"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679131892"><a href="#local-6989586621679131892"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier hs-var">withLockedTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>      </span><a name="local-6989586621679131893"><a href="#local-6989586621679131893"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyGenerateMigrationPlan</span></a><span> </span><a href="#local-6989586621679131892"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679131891"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-114"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679131893"><span class="hs-identifier hs-var">plan</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679131894"><a href="#local-6989586621679131894"><span class="hs-identifier">somethingToDo</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-117"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#nonTransactionallyExecuteMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyExecuteMigrationPlan</span></a><span> </span><a href="#local-6989586621679131892"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679131894"><span class="hs-identifier hs-var">somethingToDo</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">{-|
   Migration Guide: @generateMigrationPlan@ retains the same name. It has
   changed to always return a @MigrationPlan@. You can use check whether
   @migrationPlanSteps@ is as empty list if you wish to determine whether any
   migrations will be performed by the plan.


   generateMigrationPlan inspects the state of the actual database schema and
   constructs a plan describing what changes would be made to make it match the
   provided SchemaDefinition. If the actual schema already matches the
   definition, Nothing will be returned.
 -}</span><span>
</span><a name="line-131"></a><span class="hs-identifier">generateMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-132"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131839"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131840"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131840"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span class="hs-special">)</span><span>
</span><a name="line-133"></a><a name="generateMigrationPlan"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#generateMigrationPlan"><span class="hs-identifier">generateMigrationPlan</span></a></a><span> </span><a name="local-6989586621679131895"><a href="#local-6989586621679131895"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-134"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679131896"><a href="#local-6989586621679131896"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier hs-var">withLockedTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyGenerateMigrationPlan</span></a><span> </span><a href="#local-6989586621679131896"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679131895"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">nonTransactionallyGenerateMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-139"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131837"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131838"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679131837"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131838"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><a name="nonTransactionallyGenerateMigrationPlan"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier">nonTransactionallyGenerateMigrationPlan</span></a></a><span> </span><a name="local-6989586621679131897"><a href="#local-6989586621679131897"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679131898"><a href="#local-6989586621679131898"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#buildMigrationPlan"><span class="hs-identifier hs-var">buildMigrationPlan</span></a><span> </span><a href="#local-6989586621679131898"><span class="hs-identifier hs-var">schemaDef</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SchemaState.html#loadSchemaState"><span class="hs-identifier hs-var">loadSchemaState</span></a><span> </span><a href="#local-6989586621679131897"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-identifier">nonTransactionallyExecuteMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-144"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131835"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131836"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679131835"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131836"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><a name="nonTransactionallyExecuteMigrationPlan"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#nonTransactionallyExecuteMigrationPlan"><span class="hs-identifier">nonTransactionallyExecuteMigrationPlan</span></a></a><span> </span><a name="local-6989586621679131899"><a href="#local-6989586621679131899"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679131900"><a href="#local-6989586621679131900"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#migrationPlanItems"><span class="hs-identifier hs-var">migrationPlanItems</span></a><span> </span><a href="#local-6989586621679131900"><span class="hs-identifier hs-var">plan</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#MigrationItem"><span class="hs-identifier hs-var">MigrationItem</span></a><span> </span><a name="local-6989586621679131901"><a href="#local-6989586621679131901"><span class="hs-identifier">schemaItem</span></a></a><span> </span><a name="local-6989586621679131902"><a href="#local-6989586621679131902"><span class="hs-identifier">ddl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-147"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Execute.html#executingSql"><span class="hs-identifier hs-var">executingSql</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DDLQuery"><span class="hs-identifier hs-var">DDLQuery</span></a><span> </span><a href="#local-6989586621679131902"><span class="hs-identifier hs-var">ddl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-148"></a><span>      </span><a name="local-6989586621679131903"><a href="#local-6989586621679131903"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679131899"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679131902"><span class="hs-identifier hs-var">ddl</span></a><span>
</span><a name="line-149"></a><span>      </span><span class="hs-identifier">executeRaw</span><span> </span><a href="#local-6989586621679131903"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Exc.catch</span><span class="hs-special">`</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Exc.throw</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationError.html#MigrationExecutionError"><span class="hs-identifier hs-var">MigrationExecutionError</span></a><span> </span><a href="#local-6989586621679131901"><span class="hs-identifier hs-var">schemaItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">buildMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SchemaState.html#SchemaState"><span class="hs-identifier hs-type">SchemaState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span>
</span><a name="line-153"></a><a name="buildMigrationPlan"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#buildMigrationPlan"><span class="hs-identifier">buildMigrationPlan</span></a></a><span> </span><a name="local-6989586621679132030"><a href="#local-6989586621679132030"><span class="hs-identifier">schemaDef</span></a></a><span> </span><a name="local-6989586621679132031"><a href="#local-6989586621679132031"><span class="hs-identifier">schemaState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><a href="#local-6989586621679132032"><span class="hs-identifier hs-var">mkPlan</span></a><span> </span><a href="#local-6989586621679132030"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-154"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-155"></a><span>    </span><a name="local-6989586621679132032"><a href="#local-6989586621679132032"><span class="hs-identifier">mkPlan</span></a></a><span> </span><a name="local-6989586621679132033"><a href="#local-6989586621679132033"><span class="hs-identifier">element</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-156"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679132033"><span class="hs-identifier hs-var">element</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-157"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#Table"><span class="hs-identifier hs-var">Table</span></a><span> </span><a name="local-6989586621679132034"><a href="#local-6989586621679132034"><span class="hs-identifier">tableDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateTable.html#migrateTablePlan"><span class="hs-identifier hs-var">migrateTablePlan</span></a><span> </span><a href="#local-6989586621679132034"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-158"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#DropTable"><span class="hs-identifier hs-var">DropTable</span></a><span> </span><a name="local-6989586621679132035"><a href="#local-6989586621679132035"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateTable.html#dropTablePlan"><span class="hs-identifier hs-var">dropTablePlan</span></a><span> </span><a href="#local-6989586621679132035"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-159"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#Index"><span class="hs-identifier hs-var">Index</span></a><span> </span><a name="local-6989586621679132036"><a href="#local-6989586621679132036"><span class="hs-identifier">indexDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateIndex.html#createIndexPlan"><span class="hs-identifier hs-var">createIndexPlan</span></a><span> </span><a href="#local-6989586621679132036"><span class="hs-identifier hs-var">indexDef</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-160"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#DropIndex"><span class="hs-identifier hs-var">DropIndex</span></a><span> </span><a name="local-6989586621679132037"><a href="#local-6989586621679132037"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.MigrateIndex.html#dropIndexPlan"><span class="hs-identifier hs-var">dropIndexPlan</span></a><span> </span><a href="#local-6989586621679132037"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-161"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#Constraint"><span class="hs-identifier hs-var">Constraint</span></a><span> </span><a name="local-6989586621679132038"><a href="#local-6989586621679132038"><span class="hs-identifier">constraintDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-162"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.MigrateConstraint.html#createConstraintPlan"><span class="hs-identifier hs-var">createConstraintPlan</span></a><span> </span><a href="#local-6989586621679132038"><span class="hs-identifier hs-var">constraintDef</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-163"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#DropConstraint"><span class="hs-identifier hs-var">DropConstraint</span></a><span> </span><a name="local-6989586621679132039"><a href="#local-6989586621679132039"><span class="hs-identifier">tablName</span></a></a><span> </span><a name="local-6989586621679132040"><a href="#local-6989586621679132040"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-164"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.MigrateConstraint.html#dropConstraintPlan"><span class="hs-identifier hs-var">dropConstraintPlan</span></a><span> </span><a href="#local-6989586621679132039"><span class="hs-identifier hs-var">tablName</span></a><span> </span><a href="#local-6989586621679132040"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-165"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a><span> </span><a name="local-6989586621679132041"><a href="#local-6989586621679132041"><span class="hs-identifier">seqDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-166"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSequence.html#createSequencePlan"><span class="hs-identifier hs-var">createSequencePlan</span></a><span> </span><a href="#local-6989586621679132041"><span class="hs-identifier hs-var">seqDef</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-167"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#DropSequence"><span class="hs-identifier hs-var">DropSequence</span></a><span> </span><a name="local-6989586621679132042"><a href="#local-6989586621679132042"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-168"></a><span>          </span><a href="Database.Orville.PostgreSQL.Internal.MigrateSequence.html#dropSequencePlan"><span class="hs-identifier hs-var">dropSequencePlan</span></a><span> </span><a href="#local-6989586621679132042"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679132031"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">{-|
   Migration Plan: @createIndexesConcurrently@ has been removed. You should now
   use @setIndexCreationStrategy Asynchronous@ instead.

   createIndexesConcurrently will create the given indexes, if they do not exist using the
    PostgreSQL concurrently feature. However, this does *not* mean the the function happens
    concurrently. This will wait for PostgreSQL to return, but other operations to the table will be
    allowed during index creation.

   Note: PostgreSQL does not allow CREATE INDEX CONCURRENTLY to appear inside of a transaction. Use
   this function with care.
-}</span><span>
</span><a name="line-182"></a><span class="hs-identifier">createIndexesConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131833"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131834"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-183"></a><span>                          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Database.Orville.PostgreSQL.Internal.Types.html#IndexDefinition"><span class="hs-identifier hs-type">IndexDefinition</span></a><span class="hs-special">]</span><span>
</span><a name="line-184"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131834"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><a name="createIndexesConcurrently"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#createIndexesConcurrently"><span class="hs-identifier">createIndexesConcurrently</span></a></a><span> </span><a name="local-6989586621679132043"><a href="#local-6989586621679132043"><span class="hs-identifier">indexDefs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679132044"><a href="#local-6989586621679132044"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-identifier hs-var">traverse_</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#createIndexConcurrently"><span class="hs-identifier hs-var">createIndexConcurrently</span></a><span> </span><a href="#local-6989586621679132044"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679132043"><span class="hs-identifier hs-var">indexDefs</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- internal helper function that takes a connection and performs a single index creation.</span><span>
</span><a name="line-190"></a><span class="hs-identifier">createIndexConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131831"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131832"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-191"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679131831"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-192"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#IndexDefinition"><span class="hs-identifier hs-type">IndexDefinition</span></a><span>
</span><a name="line-193"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131832"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><a name="createIndexConcurrently"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#createIndexConcurrently"><span class="hs-identifier">createIndexConcurrently</span></a></a><span> </span><a name="local-6989586621679132045"><a href="#local-6989586621679132045"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679132046"><a href="#local-6989586621679132046"><span class="hs-identifier">indexDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679132047"><a href="#local-6989586621679132047"><span class="hs-identifier">ddl</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span>
</span><a name="line-197"></a><span>          </span><span class="hs-string">&quot; &quot;</span><span>
</span><a name="line-198"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;CREATE&quot;</span><span>
</span><a name="line-199"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">indexUnique</span><span> </span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">indexDef</span></a><span>
</span><a name="line-200"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;UNIQUE&quot;</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-202"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;INDEX&quot;</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;CONCURRENTLY&quot;</span><span>
</span><a name="line-204"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;IF NOT EXISTS&quot;</span><span>
</span><a name="line-205"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">indexName</span><span> </span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">indexDef</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span>
</span><a name="line-206"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ON&quot;</span><span>
</span><a name="line-207"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">indexTable</span><span> </span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">indexDef</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span>
</span><a name="line-208"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">indexBody</span><span> </span><a href="#local-6989586621679132046"><span class="hs-identifier hs-var">indexDef</span></a><span>
</span><a name="line-209"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-211"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Execute.html#executingSql"><span class="hs-identifier hs-var">executingSql</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DDLQuery"><span class="hs-identifier hs-var">DDLQuery</span></a><span> </span><a href="#local-6989586621679132047"><span class="hs-identifier hs-var">ddl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-212"></a><span>      </span><a name="local-6989586621679132048"><a href="#local-6989586621679132048"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679132045"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679132047"><span class="hs-identifier hs-var">ddl</span></a><span>
</span><a name="line-213"></a><span>      </span><span class="hs-identifier">executeRaw</span><span> </span><a href="#local-6989586621679132048"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">{-|
   Migration Guide: @dropIndexesConcurrently@ has been removed.

   dropIndexesConcurrently will drop each of the given indexes with the CONCURRENTLY keyword,
   allowing for other table operations to continue while the index is dropped. However there are
   several caveats that come with this as noted at
   https://www.postgresql.org/docs/9.6/sql-dropindex.html . Much like 'createIndexesConcurrently'
   this cannot be used in a transaction. But further this cannot drop indexes that support UNIQUE or
   PRIMARY KEY constraints.

   Use this with care.
-}</span><span>
</span><a name="line-228"></a><span class="hs-identifier">dropIndexesConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131829"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131830"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-229"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-230"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131830"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><a name="dropIndexesConcurrently"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#dropIndexesConcurrently"><span class="hs-identifier">dropIndexesConcurrently</span></a></a><span> </span><a name="local-6989586621679132049"><a href="#local-6989586621679132049"><span class="hs-identifier">idxNames</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679132050"><a href="#local-6989586621679132050"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-233"></a><span>    </span><span class="hs-identifier hs-var">traverse_</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#dropIndexConcurrently"><span class="hs-identifier hs-var">dropIndexConcurrently</span></a><span> </span><a href="#local-6989586621679132050"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679132049"><span class="hs-identifier hs-var">idxNames</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-identifier">dropIndexConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679131827"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679131828"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-236"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679131827"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-237"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-238"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679131828"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-239"></a><a name="dropIndexConcurrently"><a href="Database.Orville.PostgreSQL.Internal.MigrateSchema.html#dropIndexConcurrently"><span class="hs-identifier">dropIndexConcurrently</span></a></a><span> </span><a name="local-6989586621679132051"><a href="#local-6989586621679132051"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679132052"><a href="#local-6989586621679132052"><span class="hs-identifier">idxName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679132053"><a href="#local-6989586621679132053"><span class="hs-identifier">ddl</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span>
</span><a name="line-242"></a><span>          </span><span class="hs-string">&quot; &quot;</span><span>
</span><a name="line-243"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;DROP&quot;</span><span>
</span><a name="line-244"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;INDEX&quot;</span><span>
</span><a name="line-245"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;CONCURRENTLY&quot;</span><span>
</span><a name="line-246"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;IF EXISTS&quot;</span><span>
</span><a name="line-247"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679132052"><span class="hs-identifier hs-var">idxName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span>
</span><a name="line-248"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-250"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Execute.html#executingSql"><span class="hs-identifier hs-var">executingSql</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DDLQuery"><span class="hs-identifier hs-var">DDLQuery</span></a><span> </span><a href="#local-6989586621679132053"><span class="hs-identifier hs-var">ddl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-251"></a><span>      </span><a name="local-6989586621679132054"><a href="#local-6989586621679132054"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679132051"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679132053"><span class="hs-identifier hs-var">ddl</span></a><span>
</span><a name="line-252"></a><span>      </span><span class="hs-identifier">executeRaw</span><span> </span><a href="#local-6989586621679132054"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-253"></a></pre></body></html>