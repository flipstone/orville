<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.PostgreSQL.Internal.Monad
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT
-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadPlus</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Base</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Except</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">local</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runReaderT</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.State</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapStateT</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadTrans</span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Pool</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFail</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-30"></a><span class="hs-keyword">data</span><span> </span><a name="ConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier">ConnectionEnv</span></a></a><span> </span><a name="local-6989586621679071167"><a href="#local-6989586621679071167"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier">ConnectionEnv</span></a></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ormTransactionOpen"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormTransactionOpen"><span class="hs-identifier">ormTransactionOpen</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormConnection"><span class="hs-identifier">ormConnection</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679071167"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">data</span><span> </span><a name="QueryType"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier">QueryType</span></a></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SelectQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#SelectQuery"><span class="hs-identifier">SelectQuery</span></a></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InsertQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#InsertQuery"><span class="hs-identifier">InsertQuery</span></a></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UpdateQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#UpdateQuery"><span class="hs-identifier">UpdateQuery</span></a></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DeleteQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DeleteQuery"><span class="hs-identifier">DeleteQuery</span></a></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DDLQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#DDLQuery"><span class="hs-identifier">DDLQuery</span></a></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-comment">{-|
  Migration Guide: @OrvilleEnv@ has been renamed to @OrvilleState@. It no
  longer has any type paremeters. The connection type is fixed and cannot be
  changed.

 'OrvilleEnv' tracks all the environment information required for an
 'OrvilleT conn m' Monad to operate. Use 'newOrvilleEnv' to construct
 one.
  -}</span><span>
</span><a name="line-52"></a><span class="hs-keyword">data</span><span> </span><a name="OrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier">OrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071114"><a href="#local-6989586621679071114"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier">OrvilleEnv</span></a></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ormEnvConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvConnectionEnv"><span class="hs-identifier">ormEnvConnectionEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071114"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvStartTransactionSQL"><span class="hs-identifier">ormEnvStartTransactionSQL</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvRunningQuery"><span class="hs-identifier">ormEnvRunningQuery</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071166"><a href="#local-6989586621679071166"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071166"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071166"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvTransactionCallback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvTransactionCallback"><span class="hs-identifier">ormEnvTransactionCallback</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ormEnvPool"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ormEnvPool"><span class="hs-identifier">ormEnvPool</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679071114"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">data</span><span> </span><a name="TransactionEvent"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier">TransactionEvent</span></a></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TransactionStart"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionStart"><span class="hs-identifier">TransactionStart</span></a></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TransactionCommit"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionCommit"><span class="hs-identifier">TransactionCommit</span></a></a><span>
</span><a name="line-63"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TransactionRollback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionRollback"><span class="hs-identifier">TransactionRollback</span></a></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-identifier">defaultStartTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-67"></a><a name="defaultStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultStartTransactionSQL"><span class="hs-identifier">defaultStartTransactionSQL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;START TRANSACTION&quot;</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{- |
  Migration Guide: @setStartTransactionSQL@ has been renamed to @setBeginTransactionExpr@
-}</span><span>
</span><a name="line-72"></a><span class="hs-identifier">setStartTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071531"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071531"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-73"></a><a name="setStartTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#setStartTransactionSQL"><span class="hs-identifier">setStartTransactionSQL</span></a></a><span> </span><a name="local-6989586621679071532"><a href="#local-6989586621679071532"><span class="hs-identifier">sql</span></a></a><span> </span><a name="local-6989586621679071533"><a href="#local-6989586621679071533"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071533"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvStartTransactionSQL</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071532"><span class="hs-identifier hs-var">sql</span></a><span class="hs-special">}</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">defaultRunningQuery</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071530"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071530"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-76"></a><a name="defaultRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultRunningQuery"><span class="hs-identifier">defaultRunningQuery</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679071534"><a href="#local-6989586621679071534"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071534"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">defaultTransactionCallback</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><a name="defaultTransactionCallback"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultTransactionCallback"><span class="hs-identifier">defaultTransactionCallback</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">{- |
  Migration Guide: @aroundRunningQuery@ has been renamed to @addSqlExecutionCallback@
-}</span><span>
</span><a name="line-84"></a><span class="hs-identifier">aroundRunningQuery</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-85"></a><span>     </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071529"><a href="#local-6989586621679071529"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071529"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071529"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071528"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-87"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071528"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-88"></a><a name="aroundRunningQuery"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#aroundRunningQuery"><span class="hs-identifier">aroundRunningQuery</span></a></a><span> </span><a name="local-6989586621679071535"><a href="#local-6989586621679071535"><span class="hs-identifier">outside</span></a></a><span> </span><a name="local-6989586621679071536"><a href="#local-6989586621679071536"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071536"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvRunningQuery</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071537"><span class="hs-identifier hs-var">layeredAround</span></a><span class="hs-special">}</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-identifier">layeredAround</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inside</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#QueryType"><span class="hs-identifier hs-type">QueryType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071539"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071539"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-91"></a><span>    </span><a name="local-6989586621679071537"><a href="#local-6989586621679071537"><span class="hs-identifier">layeredAround</span></a></a><span> </span><a name="local-6989586621679071540"><a href="#local-6989586621679071540"><span class="hs-identifier">queryType</span></a></a><span> </span><a name="local-6989586621679071541"><a href="#local-6989586621679071541"><span class="hs-identifier">sql</span></a></a><span> </span><a name="local-6989586621679071542"><a href="#local-6989586621679071542"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-92"></a><span>      </span><a href="#local-6989586621679071535"><span class="hs-identifier hs-var">outside</span></a><span> </span><a href="#local-6989586621679071540"><span class="hs-identifier hs-var">queryType</span></a><span> </span><a href="#local-6989586621679071541"><span class="hs-identifier hs-var">sql</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071538"><span class="hs-identifier hs-var">inside</span></a><span> </span><a href="#local-6989586621679071540"><span class="hs-identifier hs-var">queryType</span></a><span> </span><a href="#local-6989586621679071541"><span class="hs-identifier hs-var">sql</span></a><span> </span><a href="#local-6989586621679071542"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>    </span><a name="local-6989586621679071538"><a href="#local-6989586621679071538"><span class="hs-identifier">inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ormEnvRunningQuery</span><span> </span><a href="#local-6989586621679071536"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">{- |
  Migration Guide: @addTransactionCallBack@ retains the same name
-}</span><span>
</span><a name="line-98"></a><span class="hs-identifier">addTransactionCallBack</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-99"></a><span>     </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071527"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071527"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-100"></a><a name="addTransactionCallBack"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#addTransactionCallBack"><span class="hs-identifier">addTransactionCallBack</span></a></a><span> </span><a name="local-6989586621679071543"><a href="#local-6989586621679071543"><span class="hs-identifier">callback</span></a></a><span> </span><a name="local-6989586621679071544"><a href="#local-6989586621679071544"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-101"></a><span>  </span><a href="#local-6989586621679071544"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvTransactionCallback</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071545"><span class="hs-identifier hs-var">wrappedCallback</span></a><span class="hs-special">}</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621679071545"><a href="#local-6989586621679071545"><span class="hs-identifier">wrappedCallback</span></a></a><span> </span><a name="local-6989586621679071546"><a href="#local-6989586621679071546"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>      </span><span class="hs-identifier">ormEnvTransactionCallback</span><span> </span><a href="#local-6989586621679071544"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679071546"><span class="hs-identifier hs-var">event</span></a><span>
</span><a name="line-105"></a><span>      </span><a href="#local-6989586621679071543"><span class="hs-identifier hs-var">callback</span></a><span> </span><a href="#local-6989586621679071546"><span class="hs-identifier hs-var">event</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">{-|
  Migration Guide: @newOrvilleEnv@ has been renamed to @newOrvilleState@. The
  new function requires a parameter to be passed before the connection pool to
  specify the level of detail to be used when Orville reports errors.

 'newOrvilleEnv' initialized an 'OrvilleEnv' for service. The connection
 pool provided will be used to obtain connections to the database ase
 required. You can use the 'Database.Orville.PostgreSQL.Connection.createConnectionPool'
 utility function to create a connection pool to a PosgreSQL server.
-}</span><span>
</span><a name="line-117"></a><span class="hs-identifier">newOrvilleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679071526"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071526"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-118"></a><a name="newOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newOrvilleEnv"><span class="hs-identifier">newOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-119"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-var">OrvilleEnv</span></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-121"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultStartTransactionSQL"><span class="hs-identifier hs-var">defaultStartTransactionSQL</span></a><span>
</span><a name="line-122"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultRunningQuery"><span class="hs-identifier hs-var">defaultRunningQuery</span></a><span>
</span><a name="line-123"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultTransactionCallback"><span class="hs-identifier hs-var">defaultTransactionCallback</span></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">setConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071525"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071525"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071525"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-126"></a><a name="setConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#setConnectionEnv"><span class="hs-identifier">setConnectionEnv</span></a></a><span> </span><a name="local-6989586621679071547"><a href="#local-6989586621679071547"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679071548"><a href="#local-6989586621679071548"><span class="hs-identifier">ormEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071548"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679071547"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">}</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">{- |
  Migration Guide: @OrvilleT@ has been removed. In its place you can simply use
  a @ReaderT OrvilleState@. If you have another @ReaderT@ layer in your monad
  stack you can add the @OrvilleState@ to the reader context for that layer
  instead, which is more efficient than having multiple @ReaderT@ layers. If
  you have a simple case of @OrvilleT conn IO@ the new Orville offers a simpler
  @Orville@ monad (not a transformer) to get you started.
-}</span><span>
</span><a name="line-136"></a><span class="hs-keyword">newtype</span><span> </span><a name="OrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier">OrvilleT</span></a></a><span> </span><a name="local-6989586621679069143"><a href="#local-6989586621679069143"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679069144"><a href="#local-6989586621679069144"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679069145"><a href="#local-6989586621679069145"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier">OrvilleT</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="unOrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#unOrvilleT"><span class="hs-identifier">unOrvilleT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679069143"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679069144"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069145"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span>
</span><a name="line-139"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span>
</span><a name="line-140"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span>
</span><a name="line-141"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-142"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadPlus</span><span>
</span><a name="line-143"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>
</span><a name="line-144"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span>
</span><a name="line-145"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span>
</span><a name="line-146"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span>
</span><a name="line-147"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span>
</span><a name="line-149"></a><span class="hs-cpp">#endif
</span><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">{- |
  Migration Guide: @mapOrvilleT@ has been removed because @OrvilleT@ has been
  removed. If you're replacing @OrvilleT@ with @ReaderT@ then @mapOrvilleT@
  should be replaced with @mapReaderT@.
-}</span><span>
</span><a name="line-157"></a><span class="hs-identifier">mapOrvilleT</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-158"></a><span>     </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071520"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071521"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071522"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071520"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071523"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071524"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071521"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071522"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071524"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071520"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071523"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-159"></a><a name="mapOrvilleT"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#mapOrvilleT"><span class="hs-identifier">mapOrvilleT</span></a></a><span> </span><a name="local-6989586621679071549"><a href="#local-6989586621679071549"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><a name="local-6989586621679071550"><a href="#local-6989586621679071550"><span class="hs-identifier">action</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><a href="#local-6989586621679071549"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679071550"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">{- |
  Migration Guide: @runOrville@ now operates on the concrete @Orville@ monad
  becase @OrvilleT@ has been removed. Assuming you are replacing usages of
  @OrvilleT@ with @ReaderT@ you will want to replace usages of @runOrville@
  with @runReaderT@.
-}</span><span>
</span><a name="line-167"></a><span class="hs-identifier">runOrville</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071517"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071518"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071519"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679071517"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071518"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071519"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-168"></a><a name="runOrville"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#runOrville"><span class="hs-identifier">runOrville</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">newConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679071516"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071516"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-171"></a><a name="newConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newConnectionEnv"><span class="hs-identifier">newConnectionEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-var">ConnectionEnv</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">withConnectionEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071513"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071514"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#ConnectionEnv"><span class="hs-identifier hs-type">ConnectionEnv</span></a><span> </span><a href="#local-6989586621679071513"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071514"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071515"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071514"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071515"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-174"></a><a name="withConnectionEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnectionEnv"><span class="hs-identifier">withConnectionEnv</span></a></a><span> </span><a name="local-6989586621679071551"><a href="#local-6989586621679071551"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>  </span><a name="local-6989586621679071552"><a href="#local-6989586621679071552"><span class="hs-identifier">ormEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-176"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><a href="#local-6989586621679071552"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679071553"><a href="#local-6989586621679071553"><span class="hs-identifier">connected</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071551"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071553"><span class="hs-identifier hs-var">connected</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-179"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withResource</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ormEnvPool</span><span> </span><a href="#local-6989586621679071552"><span class="hs-identifier hs-var">ormEnv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071554"><a href="#local-6989586621679071554"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679071555"><a href="#local-6989586621679071555"><span class="hs-identifier">connected</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newConnectionEnv"><span class="hs-identifier hs-var">newConnectionEnv</span></a><span> </span><a href="#local-6989586621679071554"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-181"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679071552"><span class="hs-identifier hs-var">ormEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ormEnvConnectionEnv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679071555"><span class="hs-identifier hs-var">connected</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-182"></a><span>          </span><a href="#local-6989586621679071551"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071555"><span class="hs-identifier hs-var">connected</span></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">withConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071510"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071511"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071510"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071511"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071512"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071511"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071512"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-185"></a><a name="withConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-6989586621679071556"><a href="#local-6989586621679071556"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#withConnectionEnv"><span class="hs-identifier hs-var">withConnectionEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071556"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ormConnection</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadTrans</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071492"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>  </span><a name="local-8214565720323793700"><span class="hs-identifier">lift</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679071487"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679071488"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679071487"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071489"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071488"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-191"></a><span>  </span><a name="local-8214565720323793790"><span class="hs-identifier">throwError</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwError</span><span>
</span><a name="line-192"></a><span>  </span><a name="local-8214565720323793789"><span class="hs-identifier">catchError</span></a><span> </span><a name="local-6989586621679071490"><a href="#local-6989586621679071490"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071491"><a href="#local-6989586621679071491"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-193"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">unOrvilleT</span><span> </span><a href="#local-6989586621679071490"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchError</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unOrvilleT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071491"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadBase</span><span> </span><a href="#local-6989586621679071484"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621679071485"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">MonadBase</span><span> </span><a href="#local-6989586621679071484"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071486"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071485"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-196"></a><span>  </span><a name="local-8214565720323823463"><span class="hs-identifier">liftBase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">liftBase</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">{-|
  Migration Guide: @HasOrvilleContext@ has been renamed to @HasOrvilleState@.
  @getOrvilleEnv@ and @localOrvilleEnv@ have been renamed to @askOrvilleState@
  and @localOrvilleState@.

  'HasOrvilleContext' defines the operations that must be available in your own
  monad for managing the connection pool that Orville functions will use to
  access the database and manage transaction state. In most cases you can
  include 'OrvilleT' in your Monad stack and then automatically derive an
  instance of 'HasOrvilleContext'.

  You could also provide your own implementations of these functions
  instead of using 'OrvilleT', if that is the easiest approach for
  your Monad.
 -}</span><span>
</span><a name="line-213"></a><span class="hs-keyword">class</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679069140"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-214"></a><span>      </span><a name="HasOrvilleContext"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier">HasOrvilleContext</span></a></a><span> </span><a name="local-6989586621679069140"><a href="#local-6989586621679069140"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679069141"><a href="#local-6989586621679069141"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">conn</span><span>
</span><a name="line-216"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>  </span><a name="getOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679069141"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679069140"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-comment">-- ^ getOrvilleEnv fetches the Orville environment from the Monad context.</span><span>
</span><a name="line-219"></a><span>  </span><span class="hs-comment">-- Analogous to 'ask' from the 'Reader' monad.</span><span>
</span><a name="line-220"></a><span>  </span><a name="localOrvilleEnv"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679069140"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleEnv"><span class="hs-identifier hs-type">OrvilleEnv</span></a><span> </span><a href="#local-6989586621679069140"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069141"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069142"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069141"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069142"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">-- ^ localOrvilleEnv locally modifies the Orville environment for the</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-comment">-- scope of the provided action. This allows Orville to track with</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-comment">-- a connection is acquired, open transactions, etc. Analogous to 'local'</span><span>
</span><a name="line-223"></a><span>  </span><span class="hs-comment">-- from the 'Reader' monad.</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">{-|
   Migration Guide: @MonadOrvilleControl@ retains the same name. The
   @liftFinally@ member has been removed. There are new @liftCatch@ and
   @liftMask@ members that must be implemented, however. Instances of the new
   @MonadOrvilleControl@ are provided for @IO@ and @ReaderT@. Helper functions
   for implmenting the members via @UnliftIO@ can be found in
   @Orville.PostgreSQL.UnliftIO@.

   'MonadOrvilleControl' provides an interface for the kinds of IO operations
   that Orville functions need to lift into the Monad providing the
   'MonadOrville' instance. This typeclass allows users to provide their
   own lifting strategies in case the Monad stack in question has special
   needs. If you are only using 'ReaderT' and 'OrvilleT' layers in your
   monad stack, you can probably implement this for your own Monad wrapper
   type using the provided default functions and providing functions to
   wrap and unwrapper your Monad layer:

   @
    instance MonadOrvilleControl MyMonad where
      liftWithConnection = defaultLiftWithConnection wrapMyMonad unWrapMyMonad
      liftFinally = defaultLiftFinally wrapMyMonad unWrapMyMonad
   @

   If you are using transformers in your monad stack beyond 'ReaderT', they
   probably don't provide 'MonadOrvilleControl' instances (e.g. third party
   libraries). In this case, see 'Database.Orville.PostgreSQL.MonadUnliftIO' for more
   help. If you're still stuck (because your library doesn't support
   'MonadTransControl'), try 'Database.Orville.PostgreSQL.MonadBaseControl' instead. If
   you're *still* stuck after that, please file an issue on Github at
   https://github.com/flipstone/orville so we can can help out!
  -}</span><span>
</span><a name="line-256"></a><span class="hs-keyword">class</span><span> </span><a name="MonadOrvilleControl"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier">MonadOrvilleControl</span></a></a><span> </span><a name="local-6989586621679069132"><a href="#local-6989586621679069132"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-257"></a><span>  </span><a name="liftWithConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-258"></a><span>       </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679069135"><a href="#local-6989586621679069135"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069133"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679069135"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679069135"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679069133"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069132"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069134"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069132"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069134"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-259"></a><span>  </span><a name="liftFinally"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679069138"><a href="#local-6989586621679069138"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679069139"><a href="#local-6989586621679069139"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679069138"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679069139"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679069138"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069132"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069136"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069132"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069137"><span class="hs-identifier hs-type">d</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679069132"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679069136"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-comment">{-|
  Migration Guide: @MonadOrville@ retains the same name, but the @conn@
  parameter has been removed. @MonadFail@ and @MonadThrow@ have been removed as
  superclass constraints.

  'MonadOrville' does not have any methods of its own. Instead it brings all
  the typeclass constraints required by Orville functions that need to access
  the database into a single typeclass. In some cases you can include
  'OrvilleT' in your Monad stack and then automatically derive an instance of
  'MonadOrville'. However, more likely you are using some third party monad
  somewhere in your stack that does not han a 'MonadOrvilleControl' instance.
  In this case you won't be able to derive 'MonadOrville', but providing a
  simple empty instance will do:

  @
    instance O.MonadOrville Postgres.Connection MyMonad
  @
 -}</span><span>
</span><a name="line-279"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-281"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679069130"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-282"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-283"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-284"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679069131"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-286"></a><span class="hs-cpp">#endif
</span><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-288"></a><span>      </span><a name="MonadOrville"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier">MonadOrville</span></a></a><span> </span><a name="local-6989586621679069130"><a href="#local-6989586621679069130"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679069131"><a href="#local-6989586621679069131"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-292"></a><span>  </span><a name="local-8214565720323843865"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><a name="local-6989586621679071482"><a href="#local-6989586621679071482"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071482"><span class="hs-identifier hs-var">ioWithConn</span></a><span>
</span><a name="line-293"></a><span>  </span><a name="local-8214565720323843866"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><a name="local-6989586621679071483"><a href="#local-6989586621679071483"><span class="hs-identifier">ioFinally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679071483"><span class="hs-identifier hs-var">ioFinally</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">{-|
   Migration Guide: @defaultLiftWithConnection@ has been removed. In its
   place you can use either the @ReaderT@ instance of @MonadOrvilleControl@
   or the helpers in @Orville.PostgreSQL.UnliftIO@.

   defaultLiftWithConnection provides a simple definition of
   'liftWithConnection' for 'MonadOrvilleControl' instances when the Monad in
   question is a wrapper around a type that already implements
   'MonadOrvilleControl'
  -}</span><span>
</span><a name="line-305"></a><span class="hs-identifier">defaultLiftWithConnection</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-306"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071503"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071507"><a href="#local-6989586621679071507"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071503"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071507"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071504"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071507"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071508"><a href="#local-6989586621679071508"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071504"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071508"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071503"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071508"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071509"><a href="#local-6989586621679071509"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071505"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071509"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071509"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071505"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071504"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071506"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071504"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071506"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-312"></a><a name="defaultLiftWithConnection"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftWithConnection"><span class="hs-identifier">defaultLiftWithConnection</span></a></a><span> </span><a name="local-6989586621679071557"><a href="#local-6989586621679071557"><span class="hs-identifier">wrapT</span></a></a><span> </span><a name="local-6989586621679071558"><a href="#local-6989586621679071558"><span class="hs-identifier">unWrapT</span></a></a><span> </span><a name="local-6989586621679071559"><a href="#local-6989586621679071559"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><a name="local-6989586621679071560"><a href="#local-6989586621679071560"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-313"></a><span>  </span><a href="#local-6989586621679071557"><span class="hs-identifier hs-var">wrapT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><a href="#local-6989586621679071559"><span class="hs-identifier hs-var">ioWithConn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071558"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071560"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">{-|
   Migration Guide: @defaultLiftWithConnection@ has been removed (along with
   @liftFinally@)

   defaultLiftFinally provides a simple definition of
   'liftWithConnection' for 'MonadOrvilleControl' instances when the Monad in
   question is a wrapper around a type that already implements
   'MonadOrvilleControl'
  -}</span><span>
</span><a name="line-324"></a><span class="hs-identifier">defaultLiftFinally</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-325"></a><span>     </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071495"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071499"><a href="#local-6989586621679071499"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071495"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071499"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071496"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071499"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071500"><a href="#local-6989586621679071500"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679071496"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071500"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071495"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679071500"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679071501"><a href="#local-6989586621679071501"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679071502"><a href="#local-6989586621679071502"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071501"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071502"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679071501"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071496"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071497"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071496"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071498"><span class="hs-identifier hs-type">d</span></a><span>
</span><a name="line-331"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679071496"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679071497"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-332"></a><a name="defaultLiftFinally"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftFinally"><span class="hs-identifier">defaultLiftFinally</span></a></a><span> </span><a name="local-6989586621679071561"><a href="#local-6989586621679071561"><span class="hs-identifier">wrapT</span></a></a><span> </span><a name="local-6989586621679071562"><a href="#local-6989586621679071562"><span class="hs-identifier">unWrapT</span></a></a><span> </span><a name="local-6989586621679071563"><a href="#local-6989586621679071563"><span class="hs-identifier">ioFinally</span></a></a><span> </span><a name="local-6989586621679071564"><a href="#local-6989586621679071564"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071565"><a href="#local-6989586621679071565"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-333"></a><span>  </span><a href="#local-6989586621679071561"><span class="hs-identifier hs-var">wrapT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier hs-var">liftFinally</span></a><span> </span><a href="#local-6989586621679071563"><span class="hs-identifier hs-var">ioFinally</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071562"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><a href="#local-6989586621679071564"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679071562"><span class="hs-identifier hs-var">unWrapT</span></a><span> </span><a href="#local-6989586621679071565"><span class="hs-identifier hs-var">cleanup</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">startTransactionSQL</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071493"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071494"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679071494"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-336"></a><a name="startTransactionSQL"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#startTransactionSQL"><span class="hs-identifier">startTransactionSQL</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ormEnvStartTransactionSQL</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071478"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071479"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071478"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-339"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071479"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071480"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071478"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-340"></a><span>  </span><a name="local-8214565720323843868"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-341"></a><span>  </span><a name="local-8214565720323843869"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071481"><a href="#local-6989586621679071481"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><a href="#local-6989586621679071481"><span class="hs-identifier hs-var">modEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">-- ReaderT is trivial enough that we just provide a 'MonadOrvilleControl'</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- instance for it here rather than relying on either MonadUnliftIO or</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- MonadBaseControl at all. This allows Monad stacks that only use 'ReaderT'</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- and 'OrvilleT' over IO to be built without needing to know anything more</span><span>
</span><a name="line-347"></a><span class="hs-comment">-- about lifting IO operations beyond the types in this module.</span><span>
</span><a name="line-348"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071469"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071470"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071469"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-349"></a><span>  </span><a name="local-8214565720323843865"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><a name="local-6989586621679071471"><a href="#local-6989586621679071471"><span class="hs-identifier">ioWithConn</span></a></a><span> </span><a name="local-6989586621679071472"><a href="#local-6989586621679071472"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071473"><a href="#local-6989586621679071473"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-351"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier hs-var">liftWithConnection</span></a><span> </span><a href="#local-6989586621679071471"><span class="hs-identifier hs-var">ioWithConn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071473"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679071472"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>  </span><a name="local-8214565720323843866"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><a name="local-6989586621679071474"><a href="#local-6989586621679071474"><span class="hs-identifier">ioFinally</span></a></a><span> </span><a name="local-6989586621679071475"><a href="#local-6989586621679071475"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679071476"><a href="#local-6989586621679071476"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>    </span><span class="hs-identifier hs-var">ReaderT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679071477"><a href="#local-6989586621679071477"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-354"></a><span>      </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier hs-var">liftFinally</span></a><span> </span><a href="#local-6989586621679071474"><span class="hs-identifier hs-var">ioFinally</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071475"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679071477"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679071476"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621679071477"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-357"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679071466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-358"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679071466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-359"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679071467"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-360"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071467"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-361"></a><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-362"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071467"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="#local-6989586621679071468"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679071466"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-keyword">instance</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071464"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071465"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071464"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-365"></a><span>  </span><a name="local-8214565720323843865"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftWithConnection"><span class="hs-identifier hs-var">defaultLiftWithConnection</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-366"></a><span>  </span><a name="local-8214565720323843866"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftFinally"><span class="hs-identifier hs-var">defaultLiftFinally</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier">unOrvilleT</span><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679071303"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071304"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-369"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071303"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071303"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071304"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-370"></a><span>  </span><a name="local-8214565720323843868"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-371"></a><span>  </span><a name="local-8214565720323843869"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071462"><a href="#local-6989586621679071462"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><a name="local-6989586621679071463"><a href="#local-6989586621679071463"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-var">OrvilleT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">local</span><span> </span><a href="#local-6989586621679071462"><span class="hs-identifier hs-var">modEnv</span></a><span> </span><a href="#local-6989586621679071463"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-374"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-375"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-376"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679071302"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-377"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-378"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-380"></a><span class="hs-cpp">#endif
</span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-382"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679071302"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">OrvilleT</span></a><span> </span><a href="#local-6989586621679071302"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071301"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-comment">-- We can provide 'HasOrvilleContext' for 'StateT' here, but not 'MonadOrvilleControl'</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- because we do not want to force a decision on the end use about how the 'StateT'</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- state should be managed during control functions (e.g. 'liftFinally'). See the</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- 'MonadBaseControl' module for an instance of 'MonadOrvilleControl' for 'StateT', if</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- you are brave enough to use 'MonadBaseControl'.</span><span>
</span><a name="line-389"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679071168"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071169"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679071168"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-390"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679071169"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="#local-6989586621679071170"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679071168"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-391"></a><span>  </span><a name="local-8214565720323843868"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-392"></a><span>  </span><a name="local-8214565720323843869"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679071300"><a href="#local-6989586621679071300"><span class="hs-identifier">modEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapStateT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">localOrvilleEnv</span></a><span> </span><a href="#local-6989586621679071300"><span class="hs-identifier hs-var">modEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a></pre></body></html>