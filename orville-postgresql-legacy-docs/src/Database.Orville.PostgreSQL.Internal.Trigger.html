<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Trigger</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alternative</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadPlus</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Base</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBase</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Except</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runReaderT</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadTrans</span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.DList</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DList</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">IORef</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">atomicWriteIORef</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Pool</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pool</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HDBC</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.html"><span class="hs-identifier">Database.Orville.PostgreSQL</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">O</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadFail</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-35"></a><span class="hs-keyword">class</span><span> </span><a name="MonadTrigger"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#MonadTrigger"><span class="hs-identifier">MonadTrigger</span></a></a><span> </span><a name="local-6989586621679147468"><a href="#local-6989586621679147468"><span class="hs-identifier">trigger</span></a></a><span> </span><a name="local-6989586621679147469"><a href="#local-6989586621679147469"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">trigger</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-36"></a><span>  </span><a name="runTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runTriggers"><span class="hs-identifier">runTriggers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147468"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147469"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">class</span><span> </span><a name="InsertTrigger"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#InsertTrigger"><span class="hs-identifier">InsertTrigger</span></a></a><span> </span><a name="local-6989586621679147466"><a href="#local-6989586621679147466"><span class="hs-identifier">trigger</span></a></a><span> </span><a name="local-6989586621679147467"><a href="#local-6989586621679147467"><span class="hs-identifier">readEntity</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-39"></a><span>  </span><a name="insertTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#insertTriggers"><span class="hs-identifier">insertTriggers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679147467"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147466"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">class</span><span> </span><a name="UpdateTrigger"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#UpdateTrigger"><span class="hs-identifier">UpdateTrigger</span></a></a><span> </span><a name="local-6989586621679147463"><a href="#local-6989586621679147463"><span class="hs-identifier">trigger</span></a></a><span> </span><a name="local-6989586621679147464"><a href="#local-6989586621679147464"><span class="hs-identifier">readEntity</span></a></a><span> </span><a name="local-6989586621679147465"><a href="#local-6989586621679147465"><span class="hs-identifier">writeEntity</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>  </span><a name="updateTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#updateTriggers"><span class="hs-identifier">updateTriggers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679147464"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147465"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147463"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">class</span><span> </span><a name="DeleteTrigger"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#DeleteTrigger"><span class="hs-identifier">DeleteTrigger</span></a></a><span> </span><a name="local-6989586621679147461"><a href="#local-6989586621679147461"><span class="hs-identifier">trigger</span></a></a><span> </span><a name="local-6989586621679147462"><a href="#local-6989586621679147462"><span class="hs-identifier">readEntity</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-45"></a><span>  </span><a name="deleteTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#deleteTriggers"><span class="hs-identifier">deleteTriggers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679147462"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147461"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-identifier">insertTriggered</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-48"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679147534"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-49"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a><span> </span><a href="#local-6989586621679147535"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147534"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-50"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#MonadTrigger"><span class="hs-identifier hs-type">MonadTrigger</span></a><span> </span><a href="#local-6989586621679147536"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147534"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-51"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#InsertTrigger"><span class="hs-identifier hs-type">InsertTrigger</span></a><span> </span><a href="#local-6989586621679147536"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147537"><span class="hs-identifier hs-type">readEntity</span></a><span>
</span><a name="line-52"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a><span> </span><a href="#local-6989586621679147537"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679147538"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679147539"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147538"><span class="hs-identifier hs-type">writeEntity</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147534"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147537"><span class="hs-identifier hs-type">readEntity</span></a><span>
</span><a name="line-56"></a><a name="insertTriggered"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#insertTriggered"><span class="hs-identifier">insertTriggered</span></a></a><span> </span><a name="local-6989586621679147540"><a href="#local-6989586621679147540"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679147541"><a href="#local-6989586621679147541"><span class="hs-identifier">writeEntity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>  </span><a name="local-6989586621679147542"><a href="#local-6989586621679147542"><span class="hs-identifier">readEntity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Core.html#insertRecord"><span class="hs-identifier hs-var">O.insertRecord</span></a><span> </span><a href="#local-6989586621679147540"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679147541"><span class="hs-identifier hs-var">writeEntity</span></a><span>
</span><a name="line-58"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runTriggers"><span class="hs-identifier hs-var">runTriggers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#insertTriggers"><span class="hs-identifier hs-var">insertTriggers</span></a><span> </span><a href="#local-6989586621679147542"><span class="hs-identifier hs-var">readEntity</span></a><span>
</span><a name="line-59"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679147542"><span class="hs-identifier hs-var">readEntity</span></a><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-identifier">updateTriggered</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-62"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679147528"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-63"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a><span> </span><a href="#local-6989586621679147529"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147528"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-64"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#MonadTrigger"><span class="hs-identifier hs-type">MonadTrigger</span></a><span> </span><a href="#local-6989586621679147530"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147528"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-65"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#UpdateTrigger"><span class="hs-identifier hs-type">UpdateTrigger</span></a><span> </span><a href="#local-6989586621679147530"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147531"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679147532"><span class="hs-identifier hs-type">writeEntity</span></a><span>
</span><a name="line-66"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a><span> </span><a href="#local-6989586621679147531"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679147532"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679147533"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147531"><span class="hs-identifier hs-type">readEntity</span></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147532"><span class="hs-identifier hs-type">writeEntity</span></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147528"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><a name="updateTriggered"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#updateTriggered"><span class="hs-identifier">updateTriggered</span></a></a><span> </span><a name="local-6989586621679147543"><a href="#local-6989586621679147543"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679147544"><a href="#local-6989586621679147544"><span class="hs-identifier">oldEntity</span></a></a><span> </span><a name="local-6989586621679147545"><a href="#local-6989586621679147545"><span class="hs-identifier">newEntity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-72"></a><span>  </span><a href="Database.Orville.PostgreSQL.Core.html#updateRecord"><span class="hs-identifier hs-var">O.updateRecord</span></a><span> </span><a href="#local-6989586621679147543"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">O.tableGetKey</span><span> </span><a href="#local-6989586621679147543"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679147544"><span class="hs-identifier hs-var">oldEntity</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679147545"><span class="hs-identifier hs-var">newEntity</span></a><span>
</span><a name="line-73"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runTriggers"><span class="hs-identifier hs-var">runTriggers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#updateTriggers"><span class="hs-identifier hs-var">updateTriggers</span></a><span> </span><a href="#local-6989586621679147544"><span class="hs-identifier hs-var">oldEntity</span></a><span> </span><a href="#local-6989586621679147545"><span class="hs-identifier hs-var">newEntity</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">deleteTriggered</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-76"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679147522"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-77"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a><span> </span><a href="#local-6989586621679147523"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147522"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-78"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#MonadTrigger"><span class="hs-identifier hs-type">MonadTrigger</span></a><span> </span><a href="#local-6989586621679147524"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147522"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-79"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#DeleteTrigger"><span class="hs-identifier hs-type">DeleteTrigger</span></a><span> </span><a href="#local-6989586621679147524"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147525"><span class="hs-identifier hs-type">readEntity</span></a><span>
</span><a name="line-80"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">O.TableDefinition</span></a><span> </span><a href="#local-6989586621679147525"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679147526"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679147527"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147525"><span class="hs-identifier hs-type">readEntity</span></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147522"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><a name="deleteTriggered"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#deleteTriggered"><span class="hs-identifier">deleteTriggered</span></a></a><span> </span><a name="local-6989586621679147546"><a href="#local-6989586621679147546"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679147547"><a href="#local-6989586621679147547"><span class="hs-identifier">readEntity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>  </span><a href="Database.Orville.PostgreSQL.Core.html#deleteRecord"><span class="hs-identifier hs-var">O.deleteRecord</span></a><span> </span><a href="#local-6989586621679147546"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">O.tableGetKey</span><span> </span><a href="#local-6989586621679147546"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679147547"><span class="hs-identifier hs-var">readEntity</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runTriggers"><span class="hs-identifier hs-var">runTriggers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#deleteTriggers"><span class="hs-identifier hs-var">deleteTriggers</span></a><span> </span><a href="#local-6989586621679147547"><span class="hs-identifier hs-var">readEntity</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-keyword">type</span><span> </span><a name="RecordedTriggersRef"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier">RecordedTriggersRef</span></a></a><span> </span><a name="local-6989586621679147460"><a href="#local-6989586621679147460"><span class="hs-identifier">trigger</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-type">RecordedTriggers</span></a><span> </span><a href="#local-6989586621679147460"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">data</span><span> </span><a name="RecordedTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier">RecordedTriggers</span></a></a><span> </span><a name="local-6989586621679147459"><a href="#local-6989586621679147459"><span class="hs-identifier">trigger</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RecordedTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier">RecordedTriggers</span></a></a><span>
</span><a name="line-91"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="committedTriggersDList"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#committedTriggersDList"><span class="hs-identifier">committedTriggersDList</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DList.DList</span><span> </span><a href="#local-6989586621679147459"><span class="hs-identifier hs-type">trigger</span></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="uncommittedTriggersDList"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#uncommittedTriggersDList"><span class="hs-identifier">uncommittedTriggersDList</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DList.DList</span><span> </span><a href="#local-6989586621679147459"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">committedTriggers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-type">RecordedTriggers</span></a><span> </span><a href="#local-6989586621679147521"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147521"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span>
</span><a name="line-96"></a><a name="committedTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#committedTriggers"><span class="hs-identifier">committedTriggers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DList.toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">committedTriggersDList</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-identifier">uncommittedTriggers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-type">RecordedTriggers</span></a><span> </span><a href="#local-6989586621679147520"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147520"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span>
</span><a name="line-99"></a><a name="uncommittedTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#uncommittedTriggers"><span class="hs-identifier">uncommittedTriggers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">DList.toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">uncommittedTriggersDList</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-identifier">emptyTriggerData</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-type">RecordedTriggers</span></a><span> </span><a href="#local-6989586621679147519"><span class="hs-identifier hs-type">trigger</span></a><span>
</span><a name="line-102"></a><a name="emptyTriggerData"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#emptyTriggerData"><span class="hs-identifier">emptyTriggerData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-var">RecordedTriggers</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">atomicModifyIORef'_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="#local-6989586621679147518"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147518"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147518"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><a name="atomicModifyIORef%27_"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#atomicModifyIORef%27_"><span class="hs-identifier">atomicModifyIORef'_</span></a></a><span> </span><a name="local-6989586621679147548"><a href="#local-6989586621679147548"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679147549"><a href="#local-6989586621679147549"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621679147548"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679147550"><a href="#local-6989586621679147550"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147549"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679147550"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-identifier">recordTriggers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147517"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147517"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="recordTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#recordTriggers"><span class="hs-identifier">recordTriggers</span></a></a><span> </span><a name="local-6989586621679147551"><a href="#local-6989586621679147551"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679147552"><a href="#local-6989586621679147552"><span class="hs-identifier">triggers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-109"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var">atomicModifyIORef'_</span></a><span> </span><a href="#local-6989586621679147551"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679147553"><a href="#local-6989586621679147553"><span class="hs-identifier">recorded</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><a href="#local-6989586621679147553"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-111"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679147554"><a href="#local-6989586621679147554"><span class="hs-identifier">uncommitted</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-112"></a><span>        </span><a href="#local-6989586621679147553"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-113"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-114"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147554"><span class="hs-identifier hs-var">uncommitted</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">DList.fromList</span><span> </span><a href="#local-6989586621679147552"><span class="hs-identifier hs-var">triggers</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-117"></a><span>        </span><a href="#local-6989586621679147553"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-118"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">committedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-119"></a><span>              </span><span class="hs-identifier">committedTriggersDList</span><span> </span><a href="#local-6989586621679147553"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">DList.fromList</span><span> </span><a href="#local-6989586621679147552"><span class="hs-identifier hs-var">triggers</span></a><span>
</span><a name="line-120"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">startTriggerTxn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147516"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><a name="startTriggerTxn"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#startTriggerTxn"><span class="hs-identifier">startTriggerTxn</span></a></a><span> </span><a name="local-6989586621679147555"><a href="#local-6989586621679147555"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-124"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var">atomicModifyIORef'_</span></a><span> </span><a href="#local-6989586621679147555"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679147556"><a href="#local-6989586621679147556"><span class="hs-identifier">recorded</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#uncommittedTriggers"><span class="hs-identifier hs-var">uncommittedTriggers</span></a><span> </span><a href="#local-6989586621679147556"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147556"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-127"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147556"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">DList.empty</span><span class="hs-special">}</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">commitTriggerTxn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147515"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><a name="commitTriggerTxn"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#commitTriggerTxn"><span class="hs-identifier">commitTriggerTxn</span></a></a><span> </span><a name="local-6989586621679147557"><a href="#local-6989586621679147557"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var">atomicModifyIORef'_</span></a><span> </span><a href="#local-6989586621679147557"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679147558"><a href="#local-6989586621679147558"><span class="hs-identifier">recorded</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-132"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><a href="#local-6989586621679147558"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-133"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679147559"><a href="#local-6989586621679147559"><span class="hs-identifier">uncommitted</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-134"></a><span>        </span><a href="#local-6989586621679147558"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-135"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-136"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">committedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-137"></a><span>              </span><span class="hs-identifier">committedTriggersDList</span><span> </span><a href="#local-6989586621679147558"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679147559"><span class="hs-identifier hs-var">uncommitted</span></a><span>
</span><a name="line-138"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-139"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147558"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">rollbackTriggerTxn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147514"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><a name="rollbackTriggerTxn"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#rollbackTriggerTxn"><span class="hs-identifier">rollbackTriggerTxn</span></a></a><span> </span><a name="local-6989586621679147560"><a href="#local-6989586621679147560"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-143"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#atomicModifyIORef%27_"><span class="hs-identifier hs-var">atomicModifyIORef'_</span></a><span> </span><a href="#local-6989586621679147560"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679147561"><a href="#local-6989586621679147561"><span class="hs-identifier">recorded</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-144"></a><span>    </span><a href="#local-6989586621679147561"><span class="hs-identifier hs-var">recorded</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">uncommittedTriggersDList</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-keyword">newtype</span><span> </span><a name="OrvilleTriggerT"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier">OrvilleTriggerT</span></a></a><span> </span><a name="local-6989586621679147454"><a href="#local-6989586621679147454"><span class="hs-identifier">trigger</span></a></a><span> </span><a name="local-6989586621679147455"><a href="#local-6989586621679147455"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679147456"><a href="#local-6989586621679147456"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679147457"><a href="#local-6989586621679147457"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OrvilleTriggerT"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier">OrvilleTriggerT</span></a></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="unTriggerT"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#unTriggerT"><span class="hs-identifier">unTriggerT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147454"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">O.OrvilleT</span></a><span> </span><a href="#local-6989586621679147455"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147456"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679147457"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-148"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Functor</span><span>
</span><a name="line-149"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span>
</span><a name="line-150"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span>
</span><a name="line-151"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-152"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span>
</span><a name="line-153"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadBase</span><span> </span><a href="#local-6989586621679147458"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-154"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span>
</span><a name="line-155"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span>
</span><a name="line-156"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span>
</span><a name="line-157"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadPlus</span><span>
</span><a name="line-158"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span>
</span><a name="line-160"></a><span class="hs-cpp">#endif
</span><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadTrans</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147491"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147492"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-164"></a><span>  </span><a name="local-8214565720323793700"><span class="hs-identifier">lift</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679147485"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621679147486"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-167"></a><span>         </span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="#local-6989586621679147485"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147487"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147488"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147486"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-168"></a><span>  </span><a name="local-8214565720323793790"><span class="hs-identifier">throwError</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwError</span><span>
</span><a name="line-169"></a><span>  </span><a name="local-8214565720323793789"><span class="hs-identifier">catchError</span></a><span> </span><a name="local-6989586621679147489"><a href="#local-6989586621679147489"><span class="hs-identifier">action</span></a></a><span> </span><a name="local-6989586621679147490"><a href="#local-6989586621679147490"><span class="hs-identifier">handler</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-170"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">unTriggerT</span><span> </span><a href="#local-6989586621679147489"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchError</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unTriggerT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679147490"><span class="hs-identifier hs-var">handler</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679147481"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HDBC.IConnection</span><span> </span><a href="#local-6989586621679147482"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-173"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#HasOrvilleContext"><span class="hs-identifier hs-type">O.HasOrvilleContext</span></a><span> </span><a href="#local-6989586621679147482"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147483"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147482"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147481"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-174"></a><span>  </span><a name="local-8214565720323843868"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier">getOrvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">O.getOrvilleEnv</span></a><span>
</span><a name="line-175"></a><span>  </span><a name="local-8214565720323843869"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier">localOrvilleEnv</span></a></a><span> </span><a name="local-6989586621679147484"><a href="#local-6989586621679147484"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-176"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#localOrvilleEnv"><span class="hs-identifier hs-var">O.localOrvilleEnv</span></a><span> </span><a href="#local-6989586621679147484"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unTriggerT</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679147476"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-179"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#MonadTrigger"><span class="hs-identifier hs-type">MonadTrigger</span></a><span> </span><a href="#local-6989586621679147477"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147477"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147478"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147476"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>  </span><a name="local-8214565720323922347"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runTriggers"><span class="hs-identifier">runTriggers</span></a></a><span> </span><a name="local-6989586621679147479"><a href="#local-6989586621679147479"><span class="hs-identifier">triggers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-181"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-182"></a><span>      </span><a name="local-6989586621679147480"><a href="#local-6989586621679147480"><span class="hs-identifier">recordedTriggers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-183"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#recordTriggers"><span class="hs-identifier hs-var">recordTriggers</span></a><span> </span><a href="#local-6989586621679147480"><span class="hs-identifier hs-var">recordedTriggers</span></a><span> </span><a href="#local-6989586621679147479"><span class="hs-identifier hs-var">triggers</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679147473"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">O.MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679147473"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-186"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">O.MonadOrvilleControl</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147474"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147475"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147473"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-187"></a><span>  </span><a name="local-8214565720323843865"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftWithConnection"><span class="hs-identifier">liftWithConnection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftWithConnection"><span class="hs-identifier hs-var">O.defaultLiftWithConnection</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-identifier">unTriggerT</span><span>
</span><a name="line-188"></a><span>  </span><a name="local-8214565720323843866"><a href="Database.Orville.PostgreSQL.Internal.Monad.html#liftFinally"><span class="hs-identifier">liftFinally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#defaultLiftFinally"><span class="hs-identifier hs-var">O.defaultLiftFinally</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-identifier">unTriggerT</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-191"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-192"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-193"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HDBC.IConnection</span><span> </span><a href="#local-6989586621679147471"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-194"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrvilleControl"><span class="hs-identifier hs-type">O.MonadOrvilleControl</span></a><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-195"></a><span class="hs-cpp">#if MIN_VERSION_base (4,11,0)
</span><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadFail</span><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-197"></a><span class="hs-cpp">#endif
</span><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-199"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">O.MonadOrville</span></a><span> </span><a href="#local-6989586621679147471"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147472"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147471"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147470"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">{-
   `askTriggers` retrieves triggers that have been recorded thus far. If you
   do not want to see the triggers returned again from future calls, you should
   use `clearTriggers` as well.
 -}</span><span>
</span><a name="line-206"></a><span class="hs-identifier">askTriggers</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-207"></a><span>     </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679147511"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147512"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147513"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147511"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggers"><span class="hs-identifier hs-type">RecordedTriggers</span></a><span> </span><a href="#local-6989586621679147512"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="askTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#askTriggers"><span class="hs-identifier">askTriggers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-209"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621679147562"><a href="#local-6989586621679147562"><span class="hs-identifier">recordedTriggers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-211"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679147562"><span class="hs-identifier hs-var">recordedTriggers</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">{-
   `clearTriggers` clears out the trigger list. This is useful if you have
   processed the trigger list and don't want to see those triggers again.
 -}</span><span>
</span><a name="line-217"></a><span class="hs-identifier">clearTriggers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679147508"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147509"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147510"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147508"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><a name="clearTriggers"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#clearTriggers"><span class="hs-identifier">clearTriggers</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-219"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679147563"><a href="#local-6989586621679147563"><span class="hs-identifier">recordedTriggers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ask</span><span>
</span><a name="line-221"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomicWriteIORef</span><span> </span><a href="#local-6989586621679147563"><span class="hs-identifier hs-var">recordedTriggers</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#emptyTriggerData"><span class="hs-identifier hs-var">emptyTriggerData</span></a><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-comment">{-
   `runOrvilleTriggerT` runs an Orville actions that has triggering behavior and
   returns the triggers that were committed. Note there there will never be any
   *uncommitted* triggers at the end because any `withTransaction` block must
   by contained *within* the action passed  to `runOrvilleTriggerT`. If you
   layer `OrvilleTriggerT` on top of a Monad `m` that *also* allows for database
   connection activity, god rest your soul.

   Note that if an exception occurs in `m` and is not caught within the action passed
   to `runOrvilleTriggerT`, you will lose any triggers that may have happened up to
   the point of the action, including those related to database operations that were
   successfully committed. If you wish to respond to those triggers, you need to perform
   some Exception handling inside the action given to `runOrvilleTriggerT` and use
   `askTriggers` to retrieve the triggers inside the exception handler.
 -}</span><span>
</span><a name="line-238"></a><span class="hs-identifier">runOrvilleTriggerT</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-239"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679147504"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147505"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147506"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147504"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147507"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-241"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679147506"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147504"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147507"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679147505"><span class="hs-identifier hs-type">trigger</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><a name="runOrvilleTriggerT"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#runOrvilleTriggerT"><span class="hs-identifier">runOrvilleTriggerT</span></a></a><span> </span><a name="local-6989586621679147564"><a href="#local-6989586621679147564"><span class="hs-identifier">triggerT</span></a></a><span> </span><a name="local-6989586621679147565"><a href="#local-6989586621679147565"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>  </span><a name="local-6989586621679147566"><a href="#local-6989586621679147566"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#emptyTriggerData"><span class="hs-identifier hs-var">emptyTriggerData</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679147567"><a href="#local-6989586621679147567"><span class="hs-identifier">orvilleT</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unTriggerT</span><span> </span><a href="#local-6989586621679147564"><span class="hs-identifier hs-var">triggerT</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679147566"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-246"></a><span>      </span><a name="local-6989586621679147568"><a href="#local-6989586621679147568"><span class="hs-identifier">orvilleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-247"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#addTransactionCallBack"><span class="hs-identifier hs-var">O.addTransactionCallBack</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#trackTransactions"><span class="hs-identifier hs-var">trackTransactions</span></a><span> </span><a href="#local-6989586621679147566"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#newOrvilleEnv"><span class="hs-identifier hs-var">O.newOrvilleEnv</span></a><span> </span><a href="#local-6989586621679147565"><span class="hs-identifier hs-var">pool</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>  </span><a name="local-6989586621679147569"><a href="#local-6989586621679147569"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#runOrville"><span class="hs-identifier hs-var">O.runOrville</span></a><span> </span><a href="#local-6989586621679147567"><span class="hs-identifier hs-var">orvilleT</span></a><span> </span><a href="#local-6989586621679147568"><span class="hs-identifier hs-var">orvilleEnv</span></a><span>
</span><a name="line-249"></a><span>  </span><a name="local-6989586621679147570"><a href="#local-6989586621679147570"><span class="hs-identifier">triggers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#committedTriggers"><span class="hs-identifier hs-var">committedTriggers</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679147566"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147569"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679147570"><span class="hs-identifier hs-var">triggers</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-identifier">mapOrvilleTriggerT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679147498"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-253"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679147499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147500"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679147498"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679147501"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147502"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147503"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147500"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-255"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147502"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147503"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147498"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679147501"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-256"></a><a name="mapOrvilleTriggerT"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#mapOrvilleTriggerT"><span class="hs-identifier">mapOrvilleTriggerT</span></a></a><span> </span><a name="local-6989586621679147571"><a href="#local-6989586621679147571"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679147572"><a href="#local-6989586621679147572"><span class="hs-identifier">triggerT</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-257"></a><span>  </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-identifier hs-var">mapReaderT</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#mapOrvilleT"><span class="hs-identifier hs-var">O.mapOrvilleT</span></a><span> </span><a href="#local-6989586621679147571"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-259"></a><span>      </span><span class="hs-identifier">unTriggerT</span><span> </span><a href="#local-6989586621679147572"><span class="hs-identifier hs-var">triggerT</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-identifier">liftOrville</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679147494"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#OrvilleT"><span class="hs-identifier hs-type">O.OrvilleT</span></a><span> </span><a href="#local-6989586621679147495"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147494"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147496"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-type">OrvilleTriggerT</span></a><span> </span><a href="#local-6989586621679147497"><span class="hs-identifier hs-type">trigger</span></a><span> </span><a href="#local-6989586621679147495"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679147494"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679147496"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-262"></a><a name="liftOrville"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#liftOrville"><span class="hs-identifier">liftOrville</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#OrvilleTriggerT"><span class="hs-identifier hs-var">OrvilleTriggerT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-identifier">trackTransactions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#RecordedTriggersRef"><span class="hs-identifier hs-type">RecordedTriggersRef</span></a><span> </span><a href="#local-6989586621679147493"><span class="hs-identifier hs-type">trigger</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionEvent"><span class="hs-identifier hs-type">O.TransactionEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="trackTransactions"><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#trackTransactions"><span class="hs-identifier">trackTransactions</span></a></a><span> </span><a name="local-6989586621679147573"><a href="#local-6989586621679147573"><span class="hs-identifier">recorded</span></a></a><span> </span><a name="local-6989586621679147574"><a href="#local-6989586621679147574"><span class="hs-identifier">event</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679147574"><span class="hs-identifier hs-var">event</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-267"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionStart"><span class="hs-identifier hs-var">O.TransactionStart</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#startTriggerTxn"><span class="hs-identifier hs-var">startTriggerTxn</span></a><span> </span><a href="#local-6989586621679147573"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-268"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionCommit"><span class="hs-identifier hs-var">O.TransactionCommit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#commitTriggerTxn"><span class="hs-identifier hs-var">commitTriggerTxn</span></a><span> </span><a href="#local-6989586621679147573"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-269"></a><span>    </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#TransactionRollback"><span class="hs-identifier hs-var">O.TransactionRollback</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Trigger.html#rollbackTriggerTxn"><span class="hs-identifier hs-var">rollbackTriggerTxn</span></a><span> </span><a href="#local-6989586621679147573"><span class="hs-identifier hs-var">recorded</span></a><span>
</span><a name="line-270"></a></pre></body></html>