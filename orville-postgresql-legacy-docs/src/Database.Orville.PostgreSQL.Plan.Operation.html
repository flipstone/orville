<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Plan.Operation</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#mkAssertionFailed"><span class="hs-identifier hs-var">mkAssertionFailed</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOne"><span class="hs-identifier hs-var">findOne</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOneWhere"><span class="hs-identifier hs-var">findOneWhere</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAll"><span class="hs-identifier hs-var">findAll</span></a><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAllWhere"><span class="hs-identifier hs-var">findAllWhere</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findSelect"><span class="hs-identifier hs-var">findSelect</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#askParam"><span class="hs-identifier hs-var">askParam</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#assertRight"><span class="hs-identifier hs-var">assertRight</span></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-type">SelectOperation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectOperation"><span class="hs-identifier hs-var">selectOperation</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Catch</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Fold</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Database.Orville.PostgreSQL.Core.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Core</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3D%3D"><span class="hs-operator hs-var">.==</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3C-"><span class="hs-operator hs-var">.&lt;-</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Core.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Core</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Core</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="Database.Orville.PostgreSQL.Internal.MappendCompat.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.MappendCompat</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Select</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SelectInternal</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Plan.Explanation</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exp</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><a href="Database.Orville.PostgreSQL.Plan.Many.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Plan.Many</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Plan.Many.html#Many"><span class="hs-identifier hs-type">Many</span></a><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Plan.Many</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Many</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Database.Orville.PostgreSQL.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Select</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Database.Orville.PostgreSQL.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Select</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Select</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">{-|
  'Operation' provides a stucture for building primitive operations that can be
  incorporated into a 'Database.Orville.PostgreSQL.Plan.Plan'. An 'Operation'
  provides base case implementations of the various plan execution functions.
  You only need to care about this type if you want to create new custom
  operations to include in a 'Database.Orville.PostgreSQL.Plan.Plan' beyond
  those already provided in the 'Database.Orville.PostgreSQL.Plan.Plan'
  api.
-}</span><span>
</span><a name="line-43"></a><span class="hs-keyword">data</span><span> </span><a name="Operation"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier">Operation</span></a></a><span> </span><a name="local-6989586621679142188"><a href="#local-6989586621679142188"><span class="hs-identifier">param</span></a></a><span> </span><a name="local-6989586621679142189"><a href="#local-6989586621679142189"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-44"></a><span>  </span><a name="Operation"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier">Operation</span></a></a><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | 'executeOperationOne' will be called when an plan is</span><span>
</span><a name="line-46"></a><span>      </span><span class="hs-comment">-- executed with a single input parameter</span><span>
</span><a name="line-47"></a><span>      </span><a name="executeOperationOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#executeOperationOne"><span class="hs-identifier">executeOperationOne</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679142190"><a href="#local-6989586621679142190"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679142191"><a href="#local-6989586621679142191"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">Core.MonadOrville</span></a><span> </span><a href="#local-6989586621679142190"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679142191"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>                          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679142188"><span class="hs-identifier hs-type">param</span></a><span>
</span><a name="line-49"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142191"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span> </span><a href="#local-6989586621679142189"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>      </span><span class="hs-comment">-- | 'executeOperationMany' will be called when an plan is</span><span>
</span><a name="line-52"></a><span>      </span><span class="hs-comment">-- executed with multiple input parameters (via 'planMany').</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="executeOperationMany"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#executeOperationMany"><span class="hs-identifier">executeOperationMany</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679142192"><a href="#local-6989586621679142192"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679142193"><a href="#local-6989586621679142193"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">Core.MonadOrville</span></a><span> </span><a href="#local-6989586621679142192"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679142193"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>                           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142188"><span class="hs-identifier hs-type">param</span></a><span class="hs-special">]</span><span>
</span><a name="line-55"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142193"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Plan.Many.html#Many"><span class="hs-identifier hs-type">Many</span></a><span> </span><a href="#local-6989586621679142188"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142189"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span>      </span><span class="hs-comment">-- | 'explainOperationOne' will be called when producing an explanation</span><span>
</span><a name="line-58"></a><span>      </span><span class="hs-comment">-- of what the plan will do when given one input parameter. Plans that do</span><span>
</span><a name="line-59"></a><span>      </span><span class="hs-comment">-- not perform any interesting IO interactions should generally return an</span><span>
</span><a name="line-60"></a><span>      </span><span class="hs-comment">-- empty explanation.</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="explainOperationOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#explainOperationOne"><span class="hs-identifier">explainOperationOne</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#Explanation"><span class="hs-identifier hs-type">Exp.Explanation</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span>      </span><span class="hs-comment">-- | 'explainOperationMany' will be called when producing an explanation</span><span>
</span><a name="line-64"></a><span>      </span><span class="hs-comment">-- of what the plan will do when given multiple input parameters (via</span><span>
</span><a name="line-65"></a><span>      </span><span class="hs-comment">-- 'planMany'). Plans that do not perform any interesting IO interactions</span><span>
</span><a name="line-66"></a><span>      </span><span class="hs-comment">-- should generally return an empty explanation.</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="explainOperationMany"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#explainOperationMany"><span class="hs-identifier">explainOperationMany</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#Explanation"><span class="hs-identifier hs-type">Exp.Explanation</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">{-|
  'AssertionFailed' may be returned from the execute functions of an
  'Operation' to indicate that some expected invariant has failed. For example,
  following a foreign key that is enforced by the database only to find that no
  record exists. When an 'Operation' returns an 'AssertionFailed' value during
  plan execution the error is thrown as an exception using the
  'Control.Monad.Catch.MonadThrow' instance for whatever monad the plan is
  executing in.
-}</span><span>
</span><a name="line-79"></a><span class="hs-keyword">newtype</span><span> </span><a name="AssertionFailed"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier">AssertionFailed</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-80"></a><span>  </span><a name="AssertionFailed"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier">AssertionFailed</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">{-|
  'mkAssertionFailed' builds an 'AssertionFailed' error from an error message.
-}</span><span>
</span><a name="line-86"></a><span class="hs-identifier">mkAssertionFailed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span>
</span><a name="line-87"></a><a name="mkAssertionFailed"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#mkAssertionFailed"><span class="hs-identifier">mkAssertionFailed</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-88"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-var">AssertionFailed</span></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Catch.Exception</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">{-|
  'askParam' simply returns the paremeter given from the plan.
-}</span><span>
</span><a name="line-95"></a><span class="hs-identifier">askParam</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142242"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142242"><span class="hs-identifier hs-type">param</span></a><span>
</span><a name="line-96"></a><a name="askParam"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#askParam"><span class="hs-identifier">askParam</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-97"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-var">Operation</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">executeOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">executeOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142243"><a href="#local-6989586621679142243"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#fromKeys"><span class="hs-identifier hs-var">Many.fromKeys</span></a><span> </span><a href="#local-6989586621679142243"><span class="hs-identifier hs-var">params</span></a><span> </span><span class="hs-identifier hs-var">Right</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#noExplanation"><span class="hs-identifier hs-var">Exp.noExplanation</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#noExplanation"><span class="hs-identifier hs-var">Exp.noExplanation</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">{-|
  'assertRight' returns the value on the 'Right' side of an 'Either'. If
  the 'Either' is a 'Left', it raises 'AssertionFailed' with the message
  from the left side of the either.
-}</span><span>
</span><a name="line-109"></a><span class="hs-identifier">assertRight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="#local-6989586621679142241"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679142241"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-110"></a><a name="assertRight"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#assertRight"><span class="hs-identifier">assertRight</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-111"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-var">Operation</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">executeOperationOne</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142244"><a href="#local-6989586621679142244"><span class="hs-identifier">eitherA</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-113"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679142244"><span class="hs-identifier hs-var">eitherA</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-115"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679142245"><a href="#local-6989586621679142245"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-116"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-var">AssertionFailed</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Assertion failed: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679142245"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679142246"><a href="#local-6989586621679142246"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-119"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679142246"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">executeOperationMany</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142247"><a href="#local-6989586621679142247"><span class="hs-identifier">eitherAs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621679142247"><span class="hs-identifier hs-var">eitherAs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-124"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679142248"><a href="#local-6989586621679142248"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-var">AssertionFailed</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Assertion failed: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679142248"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-128"></a><span>            </span><span class="hs-keyword">let</span><span>
</span><a name="line-129"></a><span>              </span><a name="local-6989586621679142249"><a href="#local-6989586621679142249"><span class="hs-identifier">errorOnLeft</span></a></a><span> </span><a name="local-6989586621679142250"><a href="#local-6989586621679142250"><span class="hs-identifier">eitherA</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679142250"><span class="hs-identifier hs-var">eitherA</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-131"></a><span>                  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-132"></a><span>                    </span><span class="hs-comment">-- We proved all the values above didn't have any lefts in</span><span>
</span><a name="line-133"></a><span>                    </span><span class="hs-comment">-- then, so if we get a left here it must not be one of the</span><span>
</span><a name="line-134"></a><span>                    </span><span class="hs-comment">-- keys from the Many.</span><span>
</span><a name="line-135"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#NotAKey"><span class="hs-identifier hs-var">Many.NotAKey</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span>                  </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679142251"><a href="#local-6989586621679142251"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-138"></a><span>                    </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679142251"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-139"></a><span>            </span><span class="hs-keyword">in</span><span>
</span><a name="line-140"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#fromKeys"><span class="hs-identifier hs-var">Many.fromKeys</span></a><span> </span><a href="#local-6989586621679142247"><span class="hs-identifier hs-var">eitherAs</span></a><span> </span><a href="#local-6989586621679142249"><span class="hs-identifier hs-var">errorOnLeft</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#noExplanation"><span class="hs-identifier hs-var">Exp.noExplanation</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#noExplanation"><span class="hs-identifier hs-var">Exp.noExplanation</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">{-|
  'findOne' builds a planning primitive that finds (at most) one row from the
  given table where the column value for the provided 'Core.FieldDefinition' matches
  the plan's input parameter. When executed on multiple parameters it fetches
  all rows where the field matches the inputs and arbitrarily picks at most one
  of those rows to use as the result for each input.
-}</span><span>
</span><a name="line-153"></a><span class="hs-identifier">findOne</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142236"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-154"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142237"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142238"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142239"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142240"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142236"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-156"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142236"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679142237"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">)</span><span>
</span><a name="line-157"></a><a name="findOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOne"><span class="hs-identifier">findOne</span></a></a><span> </span><a name="local-6989586621679142252"><a href="#local-6989586621679142252"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142253"><a href="#local-6989586621679142253"><span class="hs-identifier">fieldDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-158"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOneWithOpts"><span class="hs-identifier hs-var">findOneWithOpts</span></a><span> </span><a href="#local-6989586621679142252"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679142253"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">{-|
  'findOneWhere' is similar to 'findOne' but allows a 'WhereCondition' to be
  specified that is added to the database query to restrict which rows are
  returned.
-}</span><span>
</span><a name="line-165"></a><span class="hs-identifier">findOneWhere</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142231"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-166"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142232"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142233"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142234"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-167"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142235"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142231"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-168"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#WhereCondition"><span class="hs-identifier hs-type">Core.WhereCondition</span></a><span>
</span><a name="line-169"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142231"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679142232"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><a name="findOneWhere"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOneWhere"><span class="hs-identifier">findOneWhere</span></a></a><span> </span><a name="local-6989586621679142254"><a href="#local-6989586621679142254"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142255"><a href="#local-6989586621679142255"><span class="hs-identifier">fieldDef</span></a></a><span> </span><a name="local-6989586621679142256"><a href="#local-6989586621679142256"><span class="hs-identifier">cond</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-171"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOneWithOpts"><span class="hs-identifier hs-var">findOneWithOpts</span></a><span> </span><a href="#local-6989586621679142254"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679142255"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><a href="#local-6989586621679142256"><span class="hs-identifier hs-var">cond</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">{-|
  'findOneWithOpts' is a internal helper used by 'findOne' and 'findOneWhere'
-}</span><span>
</span><a name="line-176"></a><span class="hs-identifier">findOneWithOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142226"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-177"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142227"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142228"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142229"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-178"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142230"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142226"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-179"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#SelectOptions"><span class="hs-identifier hs-type">Core.SelectOptions</span></a><span>
</span><a name="line-180"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142226"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679142227"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><a name="findOneWithOpts"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findOneWithOpts"><span class="hs-identifier">findOneWithOpts</span></a></a><span> </span><a name="local-6989586621679142257"><a href="#local-6989586621679142257"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142258"><a href="#local-6989586621679142258"><span class="hs-identifier">fieldDef</span></a></a><span> </span><a name="local-6989586621679142259"><a href="#local-6989586621679142259"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectOperation"><span class="hs-identifier hs-var">selectOperation</span></a><span> </span><a href="#local-6989586621679142260"><span class="hs-identifier hs-var">selectOp</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-184"></a><span>      </span><a name="local-6989586621679142260"><a href="#local-6989586621679142260"><span class="hs-identifier">selectOp</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-185"></a><span>        </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-var">SelectOperation</span></a><span>
</span><a name="line-186"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">selectOne</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142264"><a href="#local-6989586621679142264"><span class="hs-identifier">fieldValue</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-187"></a><span>              </span><a href="#local-6989586621679142261"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142259"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142258"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3D%3D"><span class="hs-operator hs-var">.==</span></a><span> </span><a href="#local-6989586621679142264"><span class="hs-identifier hs-var">fieldValue</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#limit"><span class="hs-identifier hs-var">Core.limit</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">selectMany</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142265"><a href="#local-6989586621679142265"><span class="hs-identifier">fieldValues</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-190"></a><span>              </span><a href="#local-6989586621679142261"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142259"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142258"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3C-"><span class="hs-operator hs-var">.&lt;-</span></a><span> </span><a href="#local-6989586621679142265"><span class="hs-identifier hs-var">fieldValues</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainSelectOne</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-193"></a><span>              </span><a href="#local-6989586621679142261"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142259"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142262"><span class="hs-identifier hs-var">stringyField</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3D%3D"><span class="hs-operator hs-var">.==</span></a><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-string">&quot;EXAMPLE VALUE&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainSelectMany</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-196"></a><span>              </span><a href="#local-6989586621679142261"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142259"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142262"><span class="hs-identifier hs-var">stringyField</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3C-"><span class="hs-operator hs-var">.&lt;-</span></a><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;EXAMPLE VALUE 1&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;EXAMPLE VALUE 2&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">categorizeRow</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-199"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">produceResult</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Maybe.listToMaybe</span><span>
</span><a name="line-200"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>      </span><a name="local-6989586621679142261"><a href="#local-6989586621679142261"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-203"></a><span>         </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#selectQuery"><span class="hs-identifier hs-var">Select.selectQuery</span></a><span>
</span><a name="line-204"></a><span>           </span><a href="#local-6989586621679142263"><span class="hs-identifier hs-var">fromSql</span></a><span>
</span><a name="line-205"></a><span>           </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.FromClause.html#fromClauseTable"><span class="hs-identifier hs-var">Select.fromClauseTable</span></a><span> </span><a href="#local-6989586621679142257"><span class="hs-identifier hs-var">tableDef</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>      </span><a name="local-6989586621679142262"><a href="#local-6989586621679142262"><span class="hs-identifier">stringyField</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-208"></a><span>        </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#stringifyField"><span class="hs-identifier hs-var">stringifyField</span></a><span> </span><a href="#local-6989586621679142258"><span class="hs-identifier hs-var">fieldDef</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>      </span><a name="local-6989586621679142263"><a href="#local-6989586621679142263"><span class="hs-identifier">fromSql</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>          </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.FromSql.html#fieldFromSql"><span class="hs-identifier hs-var">Core.fieldFromSql</span></a><span> </span><a href="#local-6989586621679142258"><span class="hs-identifier hs-var">fieldDef</span></a><span>
</span><a name="line-213"></a><span>          </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier">Core.tableFromSql</span><span> </span><a href="#local-6989586621679142257"><span class="hs-identifier hs-var">tableDef</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">{-|
  'findAll' builds a planning primitive that finds all the rows from the
  given table where the column value for the provided field matches the
  plan's input parameter. Where executed on multiple parameters all rows
  are fetch in a single query and then associated with their respective
  inputs after being fetched.
-}</span><span>
</span><a name="line-222"></a><span class="hs-identifier">findAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142221"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-223"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142222"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142223"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142224"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-224"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142225"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142221"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-225"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142221"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142222"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">]</span><span>
</span><a name="line-226"></a><a name="findAll"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAll"><span class="hs-identifier">findAll</span></a></a><span> </span><a name="local-6989586621679142266"><a href="#local-6989586621679142266"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142267"><a href="#local-6989586621679142267"><span class="hs-identifier">fieldDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-227"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAllWithOpts"><span class="hs-identifier hs-var">findAllWithOpts</span></a><span> </span><a href="#local-6989586621679142266"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679142267"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">{-|
  'findAllWhere' is similar to 'findAll' but allows a 'WhereCondition' to be
  specified that is added to the database query to restrict which rows are
  returned.
-}</span><span>
</span><a name="line-234"></a><span class="hs-identifier">findAllWhere</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142216"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-235"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142217"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142218"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142219"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-236"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142220"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142216"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-237"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#WhereCondition"><span class="hs-identifier hs-type">Core.WhereCondition</span></a><span>
</span><a name="line-238"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142216"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142217"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">]</span><span>
</span><a name="line-239"></a><a name="findAllWhere"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAllWhere"><span class="hs-identifier">findAllWhere</span></a></a><span> </span><a name="local-6989586621679142268"><a href="#local-6989586621679142268"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142269"><a href="#local-6989586621679142269"><span class="hs-identifier">fieldDef</span></a></a><span> </span><a name="local-6989586621679142270"><a href="#local-6989586621679142270"><span class="hs-identifier">cond</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-240"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAllWithOpts"><span class="hs-identifier hs-var">findAllWithOpts</span></a><span> </span><a href="#local-6989586621679142268"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679142269"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><a href="#local-6989586621679142270"><span class="hs-identifier hs-var">cond</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-comment">{-|
  'findAllWithOpts' is an internal helper used by 'findAll' and 'findAllWhere'
-}</span><span>
</span><a name="line-245"></a><span class="hs-identifier">findAllWithOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142211"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-246"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">Core.TableDefinition</span></a><span> </span><a href="#local-6989586621679142212"><span class="hs-identifier hs-type">readEntity</span></a><span> </span><a href="#local-6989586621679142213"><span class="hs-identifier hs-type">writeEntity</span></a><span> </span><a href="#local-6989586621679142214"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-247"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142215"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142211"><span class="hs-identifier hs-type">fieldValue</span></a><span>
</span><a name="line-248"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#SelectOptions"><span class="hs-identifier hs-type">Core.SelectOptions</span></a><span>
</span><a name="line-249"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142211"><span class="hs-identifier hs-type">fieldValue</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142212"><span class="hs-identifier hs-type">readEntity</span></a><span class="hs-special">]</span><span>
</span><a name="line-250"></a><a name="findAllWithOpts"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findAllWithOpts"><span class="hs-identifier">findAllWithOpts</span></a></a><span> </span><a name="local-6989586621679142271"><a href="#local-6989586621679142271"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679142272"><a href="#local-6989586621679142272"><span class="hs-identifier">fieldDef</span></a></a><span> </span><a name="local-6989586621679142273"><a href="#local-6989586621679142273"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-251"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectOperation"><span class="hs-identifier hs-var">selectOperation</span></a><span> </span><a href="#local-6989586621679142274"><span class="hs-identifier hs-var">selectOp</span></a><span>
</span><a name="line-252"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-253"></a><span>      </span><a name="local-6989586621679142274"><a href="#local-6989586621679142274"><span class="hs-identifier">selectOp</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-254"></a><span>        </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-var">SelectOperation</span></a><span>
</span><a name="line-255"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">selectOne</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142278"><a href="#local-6989586621679142278"><span class="hs-identifier">fieldValue</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-256"></a><span>            </span><a href="#local-6989586621679142275"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142273"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142272"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3D%3D"><span class="hs-operator hs-var">.==</span></a><span> </span><a href="#local-6989586621679142278"><span class="hs-identifier hs-var">fieldValue</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">selectMany</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142279"><a href="#local-6989586621679142279"><span class="hs-identifier">fieldValues</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-259"></a><span>            </span><a href="#local-6989586621679142275"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142273"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142272"><span class="hs-identifier hs-var">fieldDef</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3C-"><span class="hs-operator hs-var">.&lt;-</span></a><span> </span><a href="#local-6989586621679142279"><span class="hs-identifier hs-var">fieldValues</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainSelectOne</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-262"></a><span>            </span><a href="#local-6989586621679142275"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142273"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142276"><span class="hs-identifier hs-var">stringyField</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3D%3D"><span class="hs-operator hs-var">.==</span></a><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-string">&quot;EXAMPLE VALUE&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainSelectMany</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-265"></a><span>            </span><a href="#local-6989586621679142275"><span class="hs-identifier hs-var">select</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142273"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SelectOptions.html#where_"><span class="hs-identifier hs-var">Core.where_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142276"><span class="hs-identifier hs-var">stringyField</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#.%3C-"><span class="hs-operator hs-var">.&lt;-</span></a><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">T.pack</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;EXAMPLE VALUE 1&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;EXAMPLE VALUE 2&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">categorizeRow</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-268"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">produceResult</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-269"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>      </span><a name="local-6989586621679142275"><a href="#local-6989586621679142275"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-272"></a><span>        </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#selectQuery"><span class="hs-identifier hs-var">Select.selectQuery</span></a><span>
</span><a name="line-273"></a><span>          </span><a href="#local-6989586621679142277"><span class="hs-identifier hs-var">fromSql</span></a><span>
</span><a name="line-274"></a><span>          </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.FromClause.html#fromClauseTable"><span class="hs-identifier hs-var">Select.fromClauseTable</span></a><span> </span><a href="#local-6989586621679142271"><span class="hs-identifier hs-var">tableDef</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>      </span><a name="local-6989586621679142276"><a href="#local-6989586621679142276"><span class="hs-identifier">stringyField</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-277"></a><span>        </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#stringifyField"><span class="hs-identifier hs-var">stringifyField</span></a><span> </span><a href="#local-6989586621679142272"><span class="hs-identifier hs-var">fieldDef</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span>      </span><a name="local-6989586621679142277"><a href="#local-6989586621679142277"><span class="hs-identifier">fromSql</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-280"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>          </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.FromSql.html#fieldFromSql"><span class="hs-identifier hs-var">Core.fieldFromSql</span></a><span> </span><a href="#local-6989586621679142272"><span class="hs-identifier hs-var">fieldDef</span></a><span>
</span><a name="line-282"></a><span>          </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier">Core.tableFromSql</span><span> </span><a href="#local-6989586621679142271"><span class="hs-identifier hs-var">tableDef</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-comment">{-|
  'stringifyField' arbitrarily re-labels the 'SqlType' of a field definition
  as text. It is an internal helper function that is used for constructing
  'WhereCondition' clauses used to generate sql when explaining how a plan
  will be executed. Relabeling the type as 'T.Text' allows us to use text
  values as example inputs in the queries when for explaining plans.
-}</span><span>
</span><a name="line-291"></a><span class="hs-identifier">stringifyField</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142209"><span class="hs-identifier hs-type">nullability</span></a><span> </span><a href="#local-6989586621679142210"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-292"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">Core.FieldDefinition</span></a><span> </span><a href="#local-6989586621679142209"><span class="hs-identifier hs-type">nullability</span></a><span> </span><span class="hs-identifier hs-type">T.Text</span><span>
</span><a name="line-293"></a><a name="stringifyField"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#stringifyField"><span class="hs-identifier">stringifyField</span></a></a><span> </span><a name="local-6989586621679142280"><a href="#local-6989586621679142280"><span class="hs-identifier">fieldDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-294"></a><span>  </span><a href="#local-6989586621679142280"><span class="hs-identifier hs-var">fieldDef</span></a><span>
</span><a name="line-295"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Core.fieldType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.SqlType.html#text"><span class="hs-identifier hs-var">Core.text</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-comment">{-|
  'SelectOperation' is a helper type for building 'Operation' primitives that
  run 'Select' queries. Specifying the fields of 'SelectOperation' and then
  using the 'selectOperation' function to build an 'Operation' is more
  convenient that building functions to execute the queries thate are required
  by the 'Operation' type.
-}</span><span>
</span><a name="line-305"></a><span class="hs-keyword">data</span><span> </span><a name="SelectOperation"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier">SelectOperation</span></a></a><span> </span><a name="local-6989586621679142185"><a href="#local-6989586621679142185"><span class="hs-identifier">param</span></a></a><span> </span><a name="local-6989586621679142186"><a href="#local-6989586621679142186"><span class="hs-identifier">row</span></a></a><span> </span><a name="local-6989586621679142187"><a href="#local-6989586621679142187"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-306"></a><span>  </span><a name="SelectOperation"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier">SelectOperation</span></a></a><span>
</span><a name="line-307"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | 'selectOne' will be called to build the 'Select' query that should</span><span>
</span><a name="line-308"></a><span>      </span><span class="hs-comment">-- be run when there is a single input parameter while executing a plan.</span><span>
</span><a name="line-309"></a><span>      </span><span class="hs-comment">-- Note that the &quot;One-ness&quot; here refers to the single input parameter</span><span>
</span><a name="line-310"></a><span>      </span><span class="hs-comment">-- rather than result. See 'produceResult' below for more information</span><span>
</span><a name="line-311"></a><span>      </span><span class="hs-comment">-- about returning one values vs. many from a 'SelectOperation'.</span><span>
</span><a name="line-312"></a><span>      </span><a name="selectOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectOne"><span class="hs-identifier">selectOne</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679142185"><span class="hs-identifier hs-type">param</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>      </span><span class="hs-comment">-- | 'selectMany' will be called to build the 'Select' query that should</span><span>
</span><a name="line-315"></a><span>      </span><span class="hs-comment">-- be run when there are multiple parameters while executing a plan.</span><span>
</span><a name="line-316"></a><span>      </span><span class="hs-comment">-- Note that the &quot;Many-ness&quot; here refers to the multiple input parameters</span><span>
</span><a name="line-317"></a><span>      </span><span class="hs-comment">-- rather than result. See 'produceResult' below for more information</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-comment">-- about returning one values vs. many from a 'SelectOperation'.</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="selectMany"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectMany"><span class="hs-identifier">selectMany</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142185"><span class="hs-identifier hs-type">param</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>      </span><span class="hs-comment">-- | 'explainSelectOne' should show a representative query of what will</span><span>
</span><a name="line-322"></a><span>      </span><span class="hs-comment">-- be returned when 'selectOne' is used. No input parameter is available</span><span>
</span><a name="line-323"></a><span>      </span><span class="hs-comment">-- here to build the query, however, because this value is used to</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-comment">-- explain a plan without actually running it.</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="explainSelectOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#explainSelectOne"><span class="hs-identifier">explainSelectOne</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>      </span><span class="hs-comment">-- | 'explainSelectMany' should show a representative query of what will</span><span>
</span><a name="line-328"></a><span>      </span><span class="hs-comment">-- be returned when 'selectMany is used. No input parameters are available</span><span>
</span><a name="line-329"></a><span>      </span><span class="hs-comment">-- here to build the query, however, because this value is used to</span><span>
</span><a name="line-330"></a><span>      </span><span class="hs-comment">-- explain a plan without actually running it.</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="explainSelectMany"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#explainSelectMany"><span class="hs-identifier">explainSelectMany</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>      </span><span class="hs-comment">-- | 'categorizeRow' will be used when a plan is executed with multiple</span><span>
</span><a name="line-334"></a><span>      </span><span class="hs-comment">-- parameters to determine which input parameter the row should be</span><span>
</span><a name="line-335"></a><span>      </span><span class="hs-comment">-- associated with.</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="categorizeRow"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#categorizeRow"><span class="hs-identifier">categorizeRow</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142185"><span class="hs-identifier hs-type">param</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>      </span><span class="hs-comment">-- | 'produceResult' will be used convert the 'row' type returned by the</span><span>
</span><a name="line-339"></a><span>      </span><span class="hs-comment">-- 'Select' queries for the operation input the 'result' type that is</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-comment">-- present as the output of the operation. The input rows will be all the</span><span>
</span><a name="line-341"></a><span>      </span><span class="hs-comment">-- inputs associated with a single parameter. The 'result' type</span><span>
</span><a name="line-342"></a><span>      </span><span class="hs-comment">-- constructed here need not be a single value. For instance, 'findAll'</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-comment">-- uses the list type as the 'result' type and 'findOne' uses 'Maybe'.</span><span>
</span><a name="line-344"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="produceResult"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#produceResult"><span class="hs-identifier">produceResult</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142186"><span class="hs-identifier hs-type">row</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142187"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-345"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-comment">{-|
  'selectOperation' builds a primitive planning 'Operation' using the functions
  given by a 'SelectOperation'. If you are implementing a custom operation that
  runs a select statement, it is probably easier to use this function rather
  than building the 'Operation' functions directly.
-}</span><span>
</span><a name="line-353"></a><span class="hs-identifier">selectOperation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142206"><span class="hs-identifier hs-type">param</span></a><span>
</span><a name="line-354"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-type">SelectOperation</span></a><span> </span><a href="#local-6989586621679142206"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142207"><span class="hs-identifier hs-type">row</span></a><span> </span><a href="#local-6989586621679142208"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-355"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142206"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142208"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-356"></a><a name="selectOperation"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#selectOperation"><span class="hs-identifier">selectOperation</span></a></a><span> </span><a name="local-6989586621679142281"><a href="#local-6989586621679142281"><span class="hs-identifier">selectOp</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-357"></a><span>  </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-var">Operation</span></a><span>
</span><a name="line-358"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">executeOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#runSelectOne"><span class="hs-identifier hs-var">runSelectOne</span></a><span> </span><a href="#local-6989586621679142281"><span class="hs-identifier hs-var">selectOp</span></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">executeOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#runSelectMany"><span class="hs-identifier hs-var">runSelectMany</span></a><span> </span><a href="#local-6989586621679142281"><span class="hs-identifier hs-var">selectOp</span></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#explainStep"><span class="hs-identifier hs-var">Exp.explainStep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">SelectInternal.selectSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">explainSelectOne</span><span> </span><a href="#local-6989586621679142281"><span class="hs-identifier hs-var">selectOp</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#explainStep"><span class="hs-identifier hs-var">Exp.explainStep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">SelectInternal.selectSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">explainSelectMany</span><span> </span><a href="#local-6989586621679142281"><span class="hs-identifier hs-var">selectOp</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">{-|
  'runSelectOne' is an internal helper function that executes a
  'SelectOperation' on a single input parameter.
-}</span><span>
</span><a name="line-369"></a><span class="hs-identifier">runSelectOne</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">Core.MonadOrville</span></a><span> </span><a href="#local-6989586621679142201"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679142202"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-370"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-type">SelectOperation</span></a><span> </span><a href="#local-6989586621679142203"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142204"><span class="hs-identifier hs-type">row</span></a><span> </span><a href="#local-6989586621679142205"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-371"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142203"><span class="hs-identifier hs-type">param</span></a><span>
</span><a name="line-372"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142202"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span> </span><a href="#local-6989586621679142205"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><a name="runSelectOne"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#runSelectOne"><span class="hs-identifier">runSelectOne</span></a></a><span> </span><a name="local-6989586621679142282"><a href="#local-6989586621679142282"><span class="hs-identifier">selectOp</span></a></a><span> </span><a name="local-6989586621679142283"><a href="#local-6989586621679142283"><span class="hs-identifier">param</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-374"></a><span>  </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">produceResult</span><span> </span><a href="#local-6989586621679142282"><span class="hs-identifier hs-var">selectOp</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">Select.runSelect</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">selectOne</span><span> </span><a href="#local-6989586621679142282"><span class="hs-identifier hs-var">selectOp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679142283"><span class="hs-identifier hs-var">param</span></a><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-comment">{-|
  'runSelectMany' is an internal helper function that executes a
  'SelectOperation' on multiple input parameters.
-}</span><span>
</span><a name="line-382"></a><span class="hs-identifier">runSelectMany</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679142196"><span class="hs-identifier hs-type">param</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">Core.MonadOrville</span></a><span> </span><a href="#local-6989586621679142197"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679142198"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#SelectOperation"><span class="hs-identifier hs-type">SelectOperation</span></a><span> </span><a href="#local-6989586621679142196"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142199"><span class="hs-identifier hs-type">row</span></a><span> </span><a href="#local-6989586621679142200"><span class="hs-identifier hs-type">result</span></a><span>
</span><a name="line-384"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142196"><span class="hs-identifier hs-type">param</span></a><span class="hs-special">]</span><span>
</span><a name="line-385"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679142198"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#AssertionFailed"><span class="hs-identifier hs-type">AssertionFailed</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Plan.Many.html#Many"><span class="hs-identifier hs-type">Many</span></a><span> </span><a href="#local-6989586621679142196"><span class="hs-identifier hs-type">param</span></a><span> </span><a href="#local-6989586621679142200"><span class="hs-identifier hs-type">result</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><a name="runSelectMany"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#runSelectMany"><span class="hs-identifier">runSelectMany</span></a></a><span> </span><a name="local-6989586621679142284"><a href="#local-6989586621679142284"><span class="hs-identifier">selectOp</span></a></a><span> </span><a name="local-6989586621679142285"><a href="#local-6989586621679142285"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-387"></a><span>  </span><a name="local-6989586621679142286"><a href="#local-6989586621679142286"><span class="hs-identifier">rows</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">Select.runSelect</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">selectMany</span><span> </span><a href="#local-6989586621679142284"><span class="hs-identifier hs-var">selectOp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679142285"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-390"></a><span>    </span><span class="hs-comment">-- Seed add initial map with an empty list for every input parameter</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-comment">-- to guarantee that each param is a key in the map even if no rows</span><span>
</span><a name="line-392"></a><span>    </span><span class="hs-comment">-- where returned from the select query for that param.</span><span>
</span><a name="line-393"></a><span>    </span><a name="local-6989586621679142287"><a href="#local-6989586621679142287"><span class="hs-identifier">emptyRowsMap</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-394"></a><span>      </span><span class="hs-identifier hs-var">Map.fromList</span><span>
</span><a name="line-395"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679142291"><a href="#local-6989586621679142291"><span class="hs-identifier">param</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142291"><span class="hs-identifier hs-var">param</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679142285"><span class="hs-identifier hs-var">params</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>    </span><a name="local-6989586621679142288"><a href="#local-6989586621679142288"><span class="hs-identifier">insertRow</span></a></a><span> </span><a name="local-6989586621679142292"><a href="#local-6989586621679142292"><span class="hs-identifier">results</span></a></a><span> </span><a name="local-6989586621679142293"><a href="#local-6989586621679142293"><span class="hs-identifier">row</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-399"></a><span>      </span><span class="hs-identifier hs-var">Map.alter</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679142294"><a href="#local-6989586621679142294"><span class="hs-identifier">mbRows</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679142293"><span class="hs-identifier hs-var">row</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">Maybe.fromMaybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679142294"><span class="hs-identifier hs-var">mbRows</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">categorizeRow</span><span> </span><a href="#local-6989586621679142284"><span class="hs-identifier hs-var">selectOp</span></a><span> </span><a href="#local-6989586621679142293"><span class="hs-identifier hs-var">row</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>        </span><a href="#local-6989586621679142292"><span class="hs-identifier hs-var">results</span></a><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621679142289"><a href="#local-6989586621679142289"><span class="hs-identifier">rowMap</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-identifier">produceResult</span><span> </span><a href="#local-6989586621679142284"><span class="hs-identifier hs-var">selectOp</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">Fold.foldl'</span><span> </span><a href="#local-6989586621679142288"><span class="hs-identifier hs-var">insertRow</span></a><span> </span><a href="#local-6989586621679142287"><span class="hs-identifier hs-var">emptyRowsMap</span></a><span> </span><a href="#local-6989586621679142286"><span class="hs-identifier hs-var">rows</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>    </span><a name="local-6989586621679142290"><a href="#local-6989586621679142290"><span class="hs-identifier">manyRows</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-408"></a><span>      </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#fromKeys"><span class="hs-identifier hs-var">Many.fromKeys</span></a><span> </span><a href="#local-6989586621679142285"><span class="hs-identifier hs-var">params</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679142295"><a href="#local-6989586621679142295"><span class="hs-identifier">param</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621679142295"><span class="hs-identifier hs-var">param</span></a><span> </span><a href="#local-6989586621679142289"><span class="hs-identifier hs-var">rowMap</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-410"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-411"></a><span>            </span><span class="hs-comment">-- Because we seeded the map above with all the input parameters we</span><span>
</span><a name="line-412"></a><span>            </span><span class="hs-comment">-- can be sure that if we don't find a value in the map here it is</span><span>
</span><a name="line-413"></a><span>            </span><span class="hs-comment">-- because the function parameter is not one of the original inputs</span><span>
</span><a name="line-414"></a><span>            </span><span class="hs-comment">-- rather than just an input for which no rows were returned by the</span><span>
</span><a name="line-415"></a><span>            </span><span class="hs-comment">-- select query.</span><span>
</span><a name="line-416"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#NotAKey"><span class="hs-identifier hs-var">Many.NotAKey</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679142296"><a href="#local-6989586621679142296"><span class="hs-identifier">row</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-419"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679142296"><span class="hs-identifier hs-var">row</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679142290"><span class="hs-identifier hs-var">manyRows</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-comment">{-|
  'findSelect' builds a plan 'Operation' where the select that is run does not
  use the input parameters for the plan in any way. If the
  'executeOperationMany' function of the resulting 'Operation' will run the
  query once and use the entire result set as the result each of the input
  parameters in turn.
-}</span><span>
</span><a name="line-431"></a><span class="hs-identifier">findSelect</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select.Select</span></a><span> </span><a href="#local-6989586621679142194"><span class="hs-identifier hs-type">row</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-type">Operation</span></a><span> </span><a href="#local-6989586621679142195"><span class="hs-identifier hs-type">param</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679142194"><span class="hs-identifier hs-type">row</span></a><span class="hs-special">]</span><span>
</span><a name="line-432"></a><a name="findSelect"><a href="Database.Orville.PostgreSQL.Plan.Operation.html#findSelect"><span class="hs-identifier">findSelect</span></a></a><span> </span><a name="local-6989586621679142297"><a href="#local-6989586621679142297"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-434"></a><span>    </span><a name="local-6989586621679142298"><a href="#local-6989586621679142298"><span class="hs-identifier">runOne</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-435"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">Select.runSelect</span></a><span> </span><a href="#local-6989586621679142297"><span class="hs-identifier hs-var">select</span></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>    </span><a name="local-6989586621679142299"><a href="#local-6989586621679142299"><span class="hs-identifier">runMany</span></a></a><span> </span><a name="local-6989586621679142300"><a href="#local-6989586621679142300"><span class="hs-identifier">params</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-438"></a><span>      </span><a name="local-6989586621679142301"><a href="#local-6989586621679142301"><span class="hs-identifier">rows</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Select.html#runSelect"><span class="hs-identifier hs-var">Select.runSelect</span></a><span> </span><a href="#local-6989586621679142297"><span class="hs-identifier hs-var">select</span></a><span>
</span><a name="line-439"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Many.html#fromKeys"><span class="hs-identifier hs-var">Many.fromKeys</span></a><span> </span><a href="#local-6989586621679142300"><span class="hs-identifier hs-var">params</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679142301"><span class="hs-identifier hs-var">rows</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-441"></a><span>    </span><a href="Database.Orville.PostgreSQL.Plan.Operation.html#Operation"><span class="hs-identifier hs-var">Operation</span></a><span>
</span><a name="line-442"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">executeOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679142298"><span class="hs-identifier hs-var">runOne</span></a><span>
</span><a name="line-443"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">executeOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679142299"><span class="hs-identifier hs-var">runMany</span></a><span>
</span><a name="line-444"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationOne</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#explainStep"><span class="hs-identifier hs-var">Exp.explainStep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">SelectInternal.selectSql</span><span> </span><a href="#local-6989586621679142297"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explainOperationMany</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.PostgreSQL.Plan.Explanation.html#explainStep"><span class="hs-identifier hs-var">Exp.explainStep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">SelectInternal.selectSql</span><span> </span><a href="#local-6989586621679142297"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">)</span><span>
</span><a name="line-446"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-447"></a></pre></body></html>