<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.PostgreSQL.Conduit
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT
-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Conduit</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Database.Orville.PostgreSQL.Conduit.html#selectConduit"><span class="hs-identifier hs-var">selectConduit</span></a><span>
</span><a name="line-10"></a><span class="hs-cpp">#if MIN_VERSION_conduit(1,3,0)
</span><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Conduit.html#streamPages"><span class="hs-identifier hs-var">streamPages</span></a><span>
</span><a name="line-12"></a><span class="hs-cpp">#endif
</span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-comment">{-
  !!! WARNING !!!

  Basically this entire file is forked using conditional compilation on the
  version of conduit that is being used. Only 'feedRows' is shared below, and
  even that needs a different type signature. If you're changing this file,
  you should probably take the time to run some earlier LTS versions to double
  check that conduit support works correctly with different library versions.
-}</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-cpp">#if MIN_VERSION_conduit(1,3,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Conduit</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Acquire</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ReleaseType</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">allocateAcquire</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkAcquire</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkAcquireType</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">yieldMany</span><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Resource</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadResource</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">release</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Conduit</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Pool</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Select</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Types</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Where</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.PostgreSQL.Pagination.html"><span class="hs-identifier">Database.Orville.PostgreSQL.Pagination</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Pagination.html#Pagination"><span class="hs-identifier hs-type">Pagination</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Pagination.html#buildPagination"><span class="hs-identifier hs-var">buildPagination</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{-|
   'selectConduit' provides a way to stream the results of a 'Select' query
   from the database one by one using the conduit library. You can 'fuse' the
   conduit built by this function with your own conduit pipeline to handle rows
   individually in whatever fashion you need (e.g. turning them into rows of
   CSV). This is useful if you want to be able to process many rows one by one.
   You can aggregate the results however you require as part of the conduit
   processing and then use 'runConduit' (or 'runConduitRes') from the conduit
   library to execute the processing pipeline. Alternatively, your web server
   ('wai', 'servant', etc) may provide support for converting a conduit into a
   streaming HTTP response.

   Beware: this function must load all the results into memory before streaming
   can begin. For why, see https://www.postgresql.org/docs/9.2/libpq-single-row-mode.html.
   If memory use is a concern, try 'streamPages' instead.
  -}</span><span>
</span><a name="line-65"></a><span class="hs-identifier">selectConduit</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-66"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679126707"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679126708"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679126707"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span> </span><a href="#local-6989586621679126707"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadResource</span><span> </span><a href="#local-6989586621679126707"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Select.html#Select"><span class="hs-identifier hs-type">Select</span></a><span> </span><a href="#local-6989586621679126709"><span class="hs-identifier hs-type">row</span></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679126709"><span class="hs-identifier hs-type">row</span></a><span> </span><a href="#local-6989586621679126707"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><a name="selectConduit"><a href="Database.Orville.PostgreSQL.Conduit.html#selectConduit"><span class="hs-identifier">selectConduit</span></a></a><span> </span><a name="local-6989586621679126710"><a href="#local-6989586621679126710"><span class="hs-identifier">select</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-70"></a><span>  </span><a name="local-6989586621679126711"><a href="#local-6989586621679126711"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ormEnvPool</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#getOrvilleEnv"><span class="hs-identifier hs-var">getOrvilleEnv</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679126726"><a href="#local-6989586621679126726"><span class="hs-identifier">releaseKey</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679126727"><a href="#local-6989586621679126727"><span class="hs-identifier">query</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-identifier hs-var">allocateAcquire</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Conduit.html#acquireStatement"><span class="hs-identifier hs-var">acquireStatement</span></a><span> </span><a href="#local-6989586621679126711"><span class="hs-identifier hs-var">pool</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">selectSql</span><span> </span><a href="#local-6989586621679126710"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">execute</span><span> </span><a href="#local-6989586621679126727"><span class="hs-identifier hs-var">query</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">selectValues</span><span> </span><a href="#local-6989586621679126710"><span class="hs-identifier hs-var">select</span></a><span>
</span><a name="line-74"></a><span>  </span><a name="local-6989586621679126728"><a href="#local-6989586621679126728"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Conduit.html#feedRows"><span class="hs-identifier hs-var">feedRows</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">selectBuilder</span><span> </span><a href="#local-6989586621679126710"><span class="hs-identifier hs-var">select</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679126727"><span class="hs-identifier hs-var">query</span></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-comment">-- Note this doesn't use finally to release this, but it will be released</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-comment">-- automatically at the end of runResourceT. finally cannot be used here</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-comment">-- because Conduit doesn't offer MonadMask. Alternatively we could use</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-comment">-- withAllocate here, but that would require an UNLiftIO instance</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-identifier hs-var">release</span><span> </span><a href="#local-6989586621679126726"><span class="hs-identifier hs-var">releaseKey</span></a><span>
</span><a name="line-80"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679126728"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-identifier">acquireConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679126706"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Acquire</span><span> </span><a href="#local-6989586621679126706"><span class="hs-identifier hs-type">conn</span></a><span>
</span><a name="line-83"></a><a name="acquireConnection"><a href="Database.Orville.PostgreSQL.Conduit.html#acquireConnection"><span class="hs-identifier">acquireConnection</span></a></a><span> </span><a name="local-6989586621679126729"><a href="#local-6989586621679126729"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mkAcquireType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeResource</span><span> </span><a href="#local-6989586621679126729"><span class="hs-identifier hs-var">pool</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679126730"><span class="hs-identifier hs-var">releaseConnection</span></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-86"></a><span>    </span><a name="local-6989586621679126730"><a href="#local-6989586621679126730"><span class="hs-identifier">releaseConnection</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679126731"><a href="#local-6989586621679126731"><span class="hs-identifier">conn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679126732"><a href="#local-6989586621679126732"><span class="hs-identifier">local</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679126733"><a href="#local-6989586621679126733"><span class="hs-identifier">releaseType</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-87"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679126733"><span class="hs-identifier hs-var">releaseType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-88"></a><span>        </span><span class="hs-identifier hs-var">ReleaseEarly</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putResource</span><span> </span><a href="#local-6989586621679126732"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="#local-6989586621679126731"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-89"></a><span>        </span><span class="hs-identifier hs-var">ReleaseNormal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putResource</span><span> </span><a href="#local-6989586621679126732"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="#local-6989586621679126731"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-identifier hs-var">ReleaseException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">destroyResource</span><span> </span><a href="#local-6989586621679126729"><span class="hs-identifier hs-var">pool</span></a><span> </span><a href="#local-6989586621679126732"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="#local-6989586621679126731"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">acquireStatement</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-93"></a><span>     </span><span class="hs-identifier hs-type">IConnection</span><span> </span><a href="#local-6989586621679126465"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Pool</span><span> </span><a href="#local-6989586621679126465"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Acquire</span><span> </span><span class="hs-identifier hs-type">Statement</span><span>
</span><a name="line-94"></a><a name="acquireStatement"><a href="Database.Orville.PostgreSQL.Conduit.html#acquireStatement"><span class="hs-identifier">acquireStatement</span></a></a><span> </span><a name="local-6989586621679126734"><a href="#local-6989586621679126734"><span class="hs-identifier">pool</span></a></a><span> </span><a name="local-6989586621679126735"><a href="#local-6989586621679126735"><span class="hs-identifier">sql</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>  </span><a name="local-6989586621679126736"><a href="#local-6989586621679126736"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.PostgreSQL.Conduit.html#acquireConnection"><span class="hs-identifier hs-var">acquireConnection</span></a><span> </span><a href="#local-6989586621679126734"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-96"></a><span>  </span><span class="hs-identifier hs-var">mkAcquire</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679126736"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679126735"><span class="hs-identifier hs-var">sql</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">finish</span><span>
</span><a name="line-97"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Conduit</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Pool</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Monad</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Select</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.Orville.PostgreSQL.Internal.Types</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">-- All the masking manual cleanup in this function amounts to a</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- poor man's ResourceT that I *hope* is correct. The constraints</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- hat lead to this are:</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">--   * The immediate purpose of conduit queries to to provide streaming</span><span>
</span><a name="line-116"></a><span class="hs-comment">--     responses in a Happstack App</span><span>
</span><a name="line-117"></a><span class="hs-comment">--</span><span>
</span><a name="line-118"></a><span class="hs-comment">--   * Happstack does not offer a side-effect controlled streaming</span><span>
</span><a name="line-119"></a><span class="hs-comment">--     response solution at the moment. It relies in Lazy Bytestrings</span><span>
</span><a name="line-120"></a><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span class="hs-comment">--   * The conduit lazy consume specifically warns that you need to</span><span>
</span><a name="line-122"></a><span class="hs-comment">--     ensure you consume the whole list before ResourceT returns,</span><span>
</span><a name="line-123"></a><span class="hs-comment">--     which I cannot guarantee in Happstack (in fact, I believe it</span><span>
</span><a name="line-124"></a><span class="hs-comment">--     specifically will *not* happen that way)</span><span>
</span><a name="line-125"></a><span class="hs-comment">--</span><span>
</span><a name="line-126"></a><span class="hs-comment">--   * Data.Pool.withResource depends on MonadBaseControl, which</span><span>
</span><a name="line-127"></a><span class="hs-comment">--     Conduit does not offer</span><span>
</span><a name="line-128"></a><span class="hs-comment">--</span><span>
</span><a name="line-129"></a><span class="hs-comment">--   * Conduit also does not offer MonadMask, so I cannot use</span><span>
</span><a name="line-130"></a><span class="hs-comment">--     mask/restore in the normal way</span><span>
</span><a name="line-131"></a><span class="hs-comment">--</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- So, we instead we mask exceptions while registering cleanup and</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- finish actions in vars while masked and then ensure those vars</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- are read and executed at the appropriate times.</span><span>
</span><a name="line-135"></a><span class="hs-comment">--</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- Beware: this function must load all the results into memory before streaming</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- can begin. For why, see https://www.postgresql.org/docs/9.2/libpq-single-row-mode.html.</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- If memory use is a concern, try 'streamPages' instead.</span><span>
</span><a name="line-139"></a><span class="hs-identifier">selectConduit</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-140"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadOrville</span><span> </span><span class="hs-identifier">conn</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadCatch</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Select</span><span> </span><span class="hs-identifier">row</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Source</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">row</span><span>
</span><a name="line-141"></a><span class="hs-identifier">selectConduit</span><span> </span><span class="hs-identifier">select</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-identifier">pool</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ormEnvPool</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">lift</span><span> </span><span class="hs-identifier">getOrvilleEnv</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-identifier">cleanupRef</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-identifier">finishRef</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">acquire</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-identifier">lift</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-identifier">E.mask_</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-149"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">conn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">local</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">takeResource</span><span> </span><span class="hs-identifier">pool</span><span>
</span><a name="line-150"></a><span>          </span><span class="hs-identifier">writeIORef</span><span> </span><span class="hs-identifier">cleanupRef</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">destroyResource</span><span> </span><span class="hs-identifier">pool</span><span> </span><span class="hs-identifier">local</span><span> </span><span class="hs-identifier">conn</span><span>
</span><a name="line-151"></a><span>          </span><span class="hs-identifier">writeIORef</span><span> </span><span class="hs-identifier">finishRef</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">putResource</span><span> </span><span class="hs-identifier">local</span><span> </span><span class="hs-identifier">conn</span><span>
</span><a name="line-152"></a><span>          </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">conn</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-identifier">runCleanup</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">join</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">readIORef</span><span> </span><span class="hs-identifier">cleanupRef</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>      </span><span class="hs-identifier">runFinish</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">join</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">readIORef</span><span> </span><span class="hs-identifier">finishRef</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-identifier">conn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">acquire</span><span>
</span><a name="line-157"></a><span>        </span><span class="hs-identifier">query</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">prepare</span><span> </span><span class="hs-identifier">conn</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">selectSql</span><span> </span><span class="hs-identifier">select</span><span>
</span><a name="line-158"></a><span>        </span><span class="hs-identifier">addCleanup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">const</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">finish</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">query</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>          </span><span class="hs-identifier">void</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">execute</span><span> </span><span class="hs-identifier">query</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">selectValues</span><span> </span><span class="hs-identifier">select</span><span>
</span><a name="line-160"></a><span>          </span><span class="hs-identifier">feedRows</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">selectBuilder</span><span> </span><span class="hs-identifier">select</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">query</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-identifier">result</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">onException</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">runCleanup</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-identifier">runFinish</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">result</span><span>
</span><a name="line-164"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-166"></a><span class="hs-identifier">feedRows</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-167"></a><span class="hs-cpp">#if MIN_VERSION_conduit(1,3,0)
</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679126463"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679126463"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FromSql"><span class="hs-identifier hs-type">FromSql</span></a><span> </span><a href="#local-6989586621679126464"><span class="hs-identifier hs-type">row</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Statement</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679126464"><span class="hs-identifier hs-type">row</span></a><span> </span><a href="#local-6989586621679126463"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span class="hs-cpp">#else
</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadIO</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">FromSql</span><span> </span><span class="hs-identifier">row</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Statement</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Source</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">row</span><span>
</span><a name="line-171"></a><span class="hs-cpp">#endif
</span><a name="feedRows"><a href="Database.Orville.PostgreSQL.Conduit.html#feedRows"><span class="hs-identifier">feedRows</span></a></a><span> </span><a name="local-6989586621679126737"><a href="#local-6989586621679126737"><span class="hs-identifier">builder</span></a></a><span> </span><a name="local-6989586621679126738"><a href="#local-6989586621679126738"><span class="hs-identifier">query</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-173"></a><span>  </span><a name="local-6989586621679126739"><a href="#local-6989586621679126739"><span class="hs-identifier">row</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fetchRowAL</span><span> </span><a href="#local-6989586621679126738"><span class="hs-identifier hs-var">query</span></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">runFromSql</span><span> </span><a href="#local-6989586621679126737"><span class="hs-identifier hs-var">builder</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679126739"><span class="hs-identifier hs-var">row</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679126740"><a href="#local-6989586621679126740"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">yield</span><span> </span><a href="#local-6989586621679126740"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Conduit.html#feedRows"><span class="hs-identifier hs-var">feedRows</span></a><span> </span><a href="#local-6989586621679126737"><span class="hs-identifier hs-var">builder</span></a><span> </span><a href="#local-6989586621679126738"><span class="hs-identifier hs-var">query</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-cpp">#if MIN_VERSION_conduit(1,3,0)
</span><span class="hs-comment">-- | Build a conduit source that is fed by querying one page worth of results</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- at a time. When the last row of the last page is consumed, the stream ends.</span><span>
</span><a name="line-182"></a><span class="hs-identifier">streamPages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679126457"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679126458"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bounded</span><span> </span><a href="#local-6989586621679126459"><span class="hs-identifier hs-type">orderField</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span> </span><a href="#local-6989586621679126459"><span class="hs-identifier hs-type">orderField</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#TableDefinition"><span class="hs-identifier hs-type">TableDefinition</span></a><span> </span><a href="#local-6989586621679126460"><span class="hs-identifier hs-type">readEnt</span></a><span> </span><a href="#local-6989586621679126461"><span class="hs-identifier hs-type">write</span></a><span> </span><a href="#local-6989586621679126462"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-184"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#FieldDefinition"><span class="hs-identifier hs-type">FieldDefinition</span></a><span> </span><a href="Database.Orville.PostgreSQL.Internal.Types.html#NotNull"><span class="hs-identifier hs-type">NotNull</span></a><span> </span><a href="#local-6989586621679126459"><span class="hs-identifier hs-type">orderField</span></a><span>
</span><a name="line-185"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679126460"><span class="hs-identifier hs-type">readEnt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679126459"><span class="hs-identifier hs-type">orderField</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.PostgreSQL.Internal.Where.html#WhereCondition"><span class="hs-identifier hs-type">WhereCondition</span></a><span>
</span><a name="line-187"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-comment">-- ^ number of rows fetched per page</span><span>
</span><a name="line-188"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConduitT</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679126460"><span class="hs-identifier hs-type">readEnt</span></a><span> </span><a href="#local-6989586621679126458"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><a name="streamPages"><a href="Database.Orville.PostgreSQL.Conduit.html#streamPages"><span class="hs-identifier">streamPages</span></a></a><span> </span><a name="local-6989586621679126741"><a href="#local-6989586621679126741"><span class="hs-identifier">tableDef</span></a></a><span> </span><a name="local-6989586621679126742"><a href="#local-6989586621679126742"><span class="hs-identifier">orderField</span></a></a><span> </span><a name="local-6989586621679126743"><a href="#local-6989586621679126743"><span class="hs-identifier">getOrderField</span></a></a><span> </span><a name="local-6989586621679126744"><a href="#local-6989586621679126744"><span class="hs-identifier">mbWhereCond</span></a></a><span> </span><a name="local-6989586621679126745"><a href="#local-6989586621679126745"><span class="hs-identifier">pageSize</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-190"></a><span>  </span><a href="#local-6989586621679126746"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.PostgreSQL.Pagination.html#buildPagination"><span class="hs-identifier hs-var">buildPagination</span></a><span> </span><a href="#local-6989586621679126741"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679126742"><span class="hs-identifier hs-var">orderField</span></a><span> </span><a href="#local-6989586621679126743"><span class="hs-identifier hs-var">getOrderField</span></a><span> </span><a href="#local-6989586621679126744"><span class="hs-identifier hs-var">mbWhereCond</span></a><span> </span><a href="#local-6989586621679126745"><span class="hs-identifier hs-var">pageSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-192"></a><span>      </span><a name="local-6989586621679126746"><a href="#local-6989586621679126746"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621679126747"><a href="#local-6989586621679126747"><span class="hs-identifier">pagination</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-identifier hs-var">yieldMany</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pageRows</span><span> </span><a href="#local-6989586621679126747"><span class="hs-identifier hs-var">pagination</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">pageNext</span><span> </span><a href="#local-6989586621679126747"><span class="hs-identifier hs-var">pagination</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-195"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679127322"><a href="#local-6989586621679127322"><span class="hs-identifier">nxtPage</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679126746"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><a href="#local-6989586621679127322"><span class="hs-identifier hs-var">nxtPage</span></a><span>
</span><a name="line-197"></a><span class="hs-cpp">#endif
</span></pre></body></html>